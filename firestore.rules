rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // ARQUITECTURA DE SEGURIDAD
    // ============================================
    //
    // IMPORTANTE: Este sistema usa EMAIL como identificador
    //
    // - Los documentos en 'authorized_users' tienen IDs basados en email (ej: user_gmail_com)
    // - El campo 'email' en cada documento contiene el email real
    // - Las reglas verifican permisos comparando el email del documento con el email del token
    // - NO se hacen transformaciones de string en las reglas (son propensas a errores)
    // - La conversión email → ID se hace en el cliente (Angular)
    //
    // Flujo:
    // 1. Admin crea usuario → documento en authorized_users/user_gmail_com con campo email
    // 2. Usuario hace login con Google → Firebase Auth proporciona email en token
    // 3. Reglas comparan: resource.data.email == request.auth.token.email
    //
    // ============================================

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated with Firebase Auth
    function isAuthenticated() {
      return request.auth != null && request.auth.token.email != null;
    }

    // Get user email from auth token (normalized to lowercase)
    function getUserEmail() {
      return request.auth.token.email;
    }

    // ============================================
    // USER MANAGEMENT
    // ============================================

    // Authorized Users - Pre-authorization and user management
    match /authorized_users/{userId} {
      // Permitir lectura a usuarios autenticados
      // Necesario para login flow y queries por email
      allow read: if isAuthenticated();

      // Permitir creación a usuarios autenticados
      // El panel de admin está protegido por guards de Angular
      // Solo admins pueden acceder a /admin/users
      allow create: if isAuthenticated();

      // Permitir actualización a usuarios autenticados
      // Los guards de Angular protegen las rutas de admin
      // Los usuarios normales solo pueden actualizar sus propios datos no críticos
      allow update: if isAuthenticated();

      // Permitir eliminación a usuarios autenticados
      // Los guards de Angular protegen las rutas de admin
      allow delete: if isAuthenticated();
    }

    // Roles - Read by authenticated users, manage by admins
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Protected by Angular guards
    }

    // Admin Logs - Append only
    match /admin_logs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if isAuthenticated();
    }

    // ============================================
    // SYSTEM CONFIGURATION
    // ============================================

    // System Config - Public read (needed for app initialization before login)
    match /config/{configId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // Business Info - Public read (needed for branding before login)
    match /business_info/{docId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // ============================================
    // MODULES - SIMPLIFIED RULES
    // ============================================
    //
    // NOTA: Las reglas son simples porque:
    // 1. La aplicación Angular ya tiene guards en las rutas
    // 2. Solo admins pueden acceder a /admin/*
    // 3. Los permisos de módulos se verifican en el cliente
    // 4. Las reglas complejas con queries son lentas y propensas a errores
    //
    // Estrategia: Verificar solo que el usuario está autenticado
    // La seguridad real se maneja en los guards de Angular
    //
    // ============================================

    // CLIENTS MODULE
    match /clients/{clientId} {
      allow read, write: if isAuthenticated();
    }

    match /client_config/{configId} {
      allow read, write: if isAuthenticated();
    }

    // PROJECTS MODULE (Proposals/Estimates)
    match /proposals/{proposalId} {
      allow read, write: if isAuthenticated();
    }

    match /proposal_config/{configId} {
      allow read, write: if isAuthenticated();
    }

    match /catalogItems/{itemId} {
      allow read, write: if isAuthenticated();
    }

    // MATERIALS MODULE
    match /materials/{materialId} {
      allow read, write: if isAuthenticated();
    }

    match /material_config/{configId} {
      allow read, write: if isAuthenticated();
    }

    // WORKERS MODULE
    match /workers/{workerId} {
      allow read, write: if isAuthenticated();
    }

    match /companies/{companyId} {
      allow read, write: if isAuthenticated();
    }

    match /worker_config/{configId} {
      allow read, write: if isAuthenticated();
    }

    // TREASURY MODULE
    match /cobros/{cobroId} {
      allow read, write: if isAuthenticated();
    }

    match /pagos/{pagoId} {
      allow read, write: if isAuthenticated();
    }

    match /treasury_config/{configId} {
      allow read, write: if isAuthenticated();
    }

    // WORK PLANNING MODULE
    match /workPlans/{planId} {
      allow read, write: if isAuthenticated();
    }

    match /work_planning_config/{configId} {
      allow read, write: if isAuthenticated();
    }

    // MODULE CONFIGURATIONS (Generic)
    match /moduleConfigs/{moduleId} {
      allow read, write: if isAuthenticated();
    }

    // System Modules - Navigation and module management
    match /system_modules/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ============================================
    // CATCH-ALL RULE (Deny by default)
    // ============================================

    // Deny access to any collection not explicitly defined
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
