<!-- src/app/admin/admin-panel.component.html - VERSIÓN COMPLETA CON BULK DELETE Y WARNINGS CORREGIDOS -->
<div class="admin-container">
  <!-- Header Compacto - Igual al Dashboard -->
  <header class="admin-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-icon-container">
          <mat-icon>admin_panel_settings</mat-icon>
        </div>
        <div class="header-info">
          <h1>Panel de Administración</h1>
          <p>
            <span class="status-dot"></span>
            Herramienta de Administración del sistema
          </p>
        </div>
      </div>
      
      <div class="header-right">
        <button 
        mat-stroked-button 
        class="back-button"
        (click)="goToDashboard()">
        <mat-icon>arrow_back</mat-icon>
        Volver
      </button>
        <!-- User Badge -->
        @if (!isLoading && currentUser()) {
          <div class="user-badge">
            <div class="user-avatar">{{ getUserInitials() }}</div>
            <div class="user-info-header">
              <span class="user-name">{{ currentUser()?.displayName }}</span>
              <span class="user-role-badge">ADMIN</span>
            </div>
          </div>
        }
        
        <!-- Action Buttons -->
        <button mat-icon-button 
                class="icon-button" 
                matTooltip="Notificaciones"
                (click)="goToNotifications()">
          <mat-icon>notifications</mat-icon>
        </button>
        
        <button mat-icon-button 
                class="icon-button" 
                matTooltip="Configuración"
                (click)="systemSettings()">
          <mat-icon>settings</mat-icon>
        </button>
        
        <button mat-icon-button class="icon-button" matTooltip="Cerrar sesión" (click)="logout()">
          <mat-icon>logout</mat-icon>
        </button>
      </div>
    </div>
  </header>

  <div class="page-breadcrumb">
    <mat-icon class="breadcrumb-icon">admin_panel_settings</mat-icon>
    <span class="breadcrumb-text">Panel de Administración</span>
  </div>

  <!-- Main Content -->
  <main class="admin-main">
    
    <!-- Stats Grid - Clicables -->
    <section class="stats-section">
      <div class="stats-grid">
        <!-- Total Users -->
        <div class="stat-card users-card" (click)="filterByAll()">
          <div class="stat-icon">
            <mat-icon>group</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ totalUsers }}</div>
            <div class="stat-label">Usuarios Totales</div>
          </div>
        </div>

        <!-- Active Users -->
        <div class="stat-card active-card" (click)="filterByActive()">
          <div class="stat-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ activeUsers }}</div>
            <div class="stat-label">Usuarios Activos</div>
          </div>
        </div>

        <!-- Total Modules -->
        <div class="stat-card modules-card" (click)="filterByModules()">
          <div class="stat-icon">
            <mat-icon>apps</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ totalModules }}</div>
            <div class="stat-label">Módulos Activos</div>
          </div>
        </div>

        <!-- Admin Users -->
        <div class="stat-card admins-card" (click)="filterByAdmin()">
          <div class="stat-icon">
            <mat-icon>security</mat-icon>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ adminUsers }}</div>
            <div class="stat-label">Administradores</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions-section">
      <div class="quick-actions-header">
        <h3>Acciones Rápidas</h3>
        <p>Gestión del sistema y configuración</p>
      </div>
      
      <div class="quick-actions-grid">
        <button class="quick-action-btn primary" (click)="addUser()">
          <mat-icon class="quick-action-icon">person_add</mat-icon>
          <span>Agregar Usuario</span>
        </button>
        
        <button class="quick-action-btn secondary" (click)="manageRoles()">
          <mat-icon class="quick-action-icon">admin_panel_settings</mat-icon>
          <span>Gestionar Roles</span>
        </button>
        
        <button class="quick-action-btn" (click)="manageModules()">
          <mat-icon class="quick-action-icon">apps</mat-icon>
          <span>Gestionar Módulos</span>
        </button>
        
        <button class="quick-action-btn" (click)="viewLogs()">
          <mat-icon class="quick-action-icon">list_alt</mat-icon>
          <span>Ver Logs</span>
        </button>
        
        <button class="quick-action-btn" (click)="systemSettings()">
          <mat-icon class="quick-action-icon">settings</mat-icon>
          <span>Configuración</span>
        </button>
        
        <button class="quick-action-btn" (click)="exportData()">
          <mat-icon class="quick-action-icon">download</mat-icon>
          <span>Exportar Datos</span>
        </button>
      </div>
    </section>

    <!-- Toolbar - Búsqueda y Acciones -->
    <section class="toolbar-section">
      <div class="search-box">
        <mat-icon class="search-icon">search</mat-icon>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Buscar usuarios por nombre o email..."
          [(ngModel)]="searchTerm"
          (input)="onSearch()"
        >
      </div>
      
      <div class="filters-group">
        <button 
          class="filter-btn" 
          [class.active]="currentFilter === 'all'"
          (click)="setFilter('all')">
          <mat-icon>people</mat-icon>
          Todos
        </button>
        <button 
          class="filter-btn"
          [class.active]="currentFilter === 'admin'"
          (click)="setFilter('admin')">
          <mat-icon>shield</mat-icon>
          Admins
        </button>
        <button 
          class="filter-btn"
          [class.active]="currentFilter === 'modules'"
          (click)="setFilter('modules')">
          <mat-icon>apps</mat-icon>
          Con Módulos
        </button>
      </div>

      <div class="toolbar-actions">
        <!-- Mostrar acciones masivas si hay usuarios seleccionados -->
        @if (selectedUsers.size > 0) {
          <div class="bulk-actions">
            <span class="selected-count">{{ selectedUsers.size }} seleccionado(s)</span>
            <button 
              class="btn-danger-toolbar" 
              (click)="deleteSelectedUsers()"
              matTooltip="Eliminar usuarios seleccionados">
              <mat-icon>delete_sweep</mat-icon>
              Eliminar Seleccionados
            </button>
            <button 
              class="btn-secondary-toolbar" 
              (click)="clearSelection()"
              matTooltip="Cancelar selección">
              <mat-icon>clear</mat-icon>
              Cancelar
            </button>
          </div>
        } @else {
          <!-- Acciones normales cuando no hay selección -->
          <button class="btn-secondary-toolbar" (click)="exportData()">
            <mat-icon>download</mat-icon>
            Exportar
          </button>
          <button class="btn-primary-toolbar" (click)="addUser()">
            <mat-icon>person_add</mat-icon>
            Nuevo Usuario
          </button>
        }
      </div>
    </section>

    <!-- Users Table -->
    <section class="table-section">
      <div class="table-container">
        <div class="table-wrapper">
          <table class="users-table">
            <thead>
              <tr>
                <!-- Checkbox para seleccionar todos -->
                <th style="width: 50px;">
                  <input 
                    type="checkbox" 
                    class="checkbox-select-all"
                    [checked]="isAllSelected()"
                    [indeterminate]="isSomeSelected()"
                    (change)="toggleSelectAll()"
                    matTooltip="Seleccionar todos"
                  >
                </th>
                <th>Usuario</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Módulos Asignados</th>
                <th>Último Acceso</th>
                <th style="text-align: center;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (user of displayedUsers; track trackByUid($index, user)) {
                <tr class="table-row" [class.selected-row]="isUserSelected(user.uid!)">
                  <!-- Checkbox individual -->
                  <td>
                    <input 
                      type="checkbox" 
                      class="checkbox-select"
                      [checked]="isUserSelected(user.uid!)"
                      (change)="toggleUserSelection(user.uid!)"
                      [disabled]="!canSelectUser(user)"
                      [matTooltip]="getSelectionTooltip(user)"
                    >
                  </td>
                  <td class="user-cell">
                    <div class="user-info">
                      <div class="user-avatar-small" [style.background]="getUserAvatarColor(user.email)">
                        <mat-icon>{{ getUserIcon(user.role) }}</mat-icon>
                      </div>
                      <div class="user-details-table">
                        <span class="user-email">{{ user.email }}</span>
                        <span class="user-name-small">{{ user.displayName || 'Sin nombre' }}</span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="role-badge" [class]="'role-' + user.role">
                      <mat-icon class="role-icon">{{ getRoleIcon(user.role) }}</mat-icon>
                      <span>{{ user.role.toUpperCase() }}</span>
                    </div>
                  </td>
                  <td>
                    <div class="status-badge" [class]="user.isActive ? 'status-active' : 'status-inactive'">
                      <mat-icon>{{ user.isActive ? 'check_circle' : 'cancel' }}</mat-icon>
                      <span>{{ user.isActive ? 'ACTIVO' : 'INACTIVO' }}</span>
                    </div>
                  </td>
                  <td class="modules-cell">
                    @if (getUserModules(user.email).length) {
                      <div class="modules-list">
                        @for (module of getUserModules(user.email).slice(0, 3); track module) {
                          <mat-chip class="module-chip">
                            <mat-icon matChipAvatar>{{ getModuleIcon(module) }}</mat-icon>
                            {{ getModuleName(module) }}
                          </mat-chip>
                        }
                        @if (getUserModules(user.email).length > 3) {
                          <span class="more-modules">
                            +{{ getUserModules(user.email).length - 3 }} más
                          </span>
                        }
                      </div>
                    } @else {
                      <span class="no-modules">Sin módulos</span>
                    }
                  </td>
                  <td class="date-cell">
                    <div class="date-info">
                      <span class="date-text">{{ formatDate(user.lastLogin) }}</span>
                      @if (user.lastLogin) {
                        <span class="date-relative">{{ getRelativeTime(user.lastLogin) }}</span>
                      }
                    </div>
                  </td>
                  <td style="text-align: center;">
                    <button mat-icon-button [matMenuTriggerFor]="userMenu" class="action-menu-button">
                      <mat-icon>more_horiz</mat-icon>
                    </button>
                    <mat-menu #userMenu="matMenu">
                      <button mat-menu-item (click)="viewUserDetails(user)">
                        <mat-icon>visibility</mat-icon>
                        Ver Detalles
                      </button>
                      <button mat-menu-item (click)="editUser(user)">
                        <mat-icon>edit</mat-icon>
                        Editar Usuario
                      </button>
                      <button mat-menu-item (click)="resetUserPassword(user)">
                        <mat-icon>lock_reset</mat-icon>
                        Restablecer Contraseña
                      </button>
                      <button mat-menu-item (click)="toggleUserStatus(user)">
                        <mat-icon>{{ user.isActive ? 'block' : 'check_circle' }}</mat-icon>
                        {{ user.isActive ? 'Desactivar' : 'Activar' }}
                      </button>
                      <button mat-menu-item (click)="assignModules(user)" class="assign-modules">
                        <mat-icon>apps</mat-icon>
                        Asignar Módulos
                      </button>
                      
                      <mat-divider></mat-divider>
                      <button 
                        mat-menu-item 
                        (click)="deleteUser(user)" 
                        class="delete-menu-item">
                        <mat-icon class="delete-icon">delete_forever</mat-icon>
                        Eliminar Usuario
                      </button>
                    </mat-menu>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Table Actions -->
      @if (users.length > 0) {
        <div class="table-actions">
          <div class="table-info">
            <span>Mostrando {{ displayedUsers.length }} de {{ totalUsers }} usuarios</span>
            @if (selectedUsers.size > 0) {
              <span class="selection-info"> • {{ selectedUsers.size }} seleccionado(s)</span>
            }
          </div>
          <div class="table-buttons">
            @if (displayedUsers.length < users.length) {
              <button mat-button (click)="loadMoreUsers()">
                <mat-icon>expand_more</mat-icon>
                Ver Más Usuarios
              </button>
            }
          </div>
        </div>
      }
      
      <!-- Estado cuando no hay usuarios -->
      @if (users.length === 0 && !isLoading) {
        <div class="empty-state">
          <mat-icon class="empty-icon">people_outline</mat-icon>
          <h3>No hay usuarios registrados</h3>
          <p>Comienza agregando el primer usuario al sistema</p>
          <button mat-raised-button color="primary" (click)="addUser()">
            <mat-icon>person_add</mat-icon>
            Agregar Primer Usuario
          </button>
        </div>
      }
      
      <!-- Estado de carga -->
      @if (isLoading) {
        <div class="loading-state">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Cargando usuarios...</p>
        </div>
      }
    </section>

  </main>
</div>