<!-- business-info.component.html -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <div class="max-w-[1200px] mx-auto p-5">

    <!-- ============================================
         HEADER COMPACTO
         ============================================ -->
    <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-5">
      <div class="flex items-center justify-between gap-4 flex-wrap">

        <!-- Left Section -->
        <div class="flex items-center gap-3">
          <button
            type="button"
            class="back-btn"
            (click)="goBack()"
            title="Volver">
            <mat-icon>arrow_back</mat-icon>
          </button>

          <div class="header-icon-box">
            <mat-icon>business</mat-icon>
          </div>

          <div>
            <h1 class="text-lg font-bold text-slate-800">Información de Empresa</h1>
            <p class="text-xs text-slate-500">
              @if (businessExists()) {
                Gestiona la información de tu empresa
              } @else {
                Configura la información de tu empresa
              }
            </p>
          </div>
        </div>

        <!-- Stats Inline -->
        <div class="hidden md:flex items-center gap-3">
          <div class="stat-chip">
            <span class="stat-value">5</span>
            <span class="stat-label">Secciones</span>
          </div>
          <div class="stat-chip" [class.active]="editMode()">
            <span class="stat-value">{{ editMode() ? 'Sí' : 'No' }}</span>
            <span class="stat-label">Editando</span>
          </div>
        </div>

        <!-- Right Section - Action Buttons -->
        <div class="flex items-center gap-2">
          @if (!editMode() && businessExists()) {
            <button
              type="button"
              class="btn-primary"
              (click)="enableEditMode()">
              <mat-icon>edit</mat-icon>
              Editar
            </button>
          }

          @if (editMode()) {
            <button
              type="button"
              class="btn-cancel"
              (click)="cancelEdit()"
              [disabled]="saving()">
              <mat-icon>close</mat-icon>
              Cancelar
            </button>

            <button
              type="button"
              class="btn-save"
              (click)="onSubmit()"
              [disabled]="saving() || businessForm.invalid">
              @if (saving()) {
                <mat-spinner diameter="18"></mat-spinner>
              } @else {
                <mat-icon>save</mat-icon>
              }
              {{ saving() ? 'Guardando...' : 'Guardar' }}
            </button>
          }
        </div>
      </div>
    </header>

    <!-- ============================================
         LOADING STATE
         ============================================ -->
    @if (loading()) {
      <div class="flex flex-col items-center justify-center py-16">
        <mat-spinner diameter="40"></mat-spinner>
        <p class="mt-4 text-sm text-slate-600">Cargando información...</p>
      </div>
    }

    <!-- ============================================
         MAIN CONTENT
         ============================================ -->
    @if (!loading()) {
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

        <!-- ============================================
             LEFT COLUMN - FORMULARIO CON TABS (2/3 width)
             ============================================ -->
        <section class="lg:col-span-2">
          <div class="form-card">

            <!-- Upload Progress Bar -->
            @if (uploadProgress() > 0 && uploadProgress() < 100) {
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="uploadProgress()"></div>
              </div>
            }

            <!-- Tabs -->
            <mat-tab-group class="business-tabs" animationDuration="200ms">

              <!-- ==========================================
                   TAB 1: INFORMACIÓN GENERAL
                   ========================================== -->
              <mat-tab>
                <ng-template mat-tab-label>
                  <div class="tab-label-content">
                    <mat-icon class="tab-icon">info</mat-icon>
                    <span class="tab-text">General</span>
                  </div>
                </ng-template>

                <div class="tab-content">
                  <form [formGroup]="businessForm" class="space-y-4">

                    <!-- Nombre Comercial -->
                    <div class="form-group">
                      <label class="form-label">
                        <mat-icon>store</mat-icon>
                        Nombre Comercial *
                      </label>
                      <div class="input-wrapper">
                        <input
                          type="text"
                          formControlName="businessName"
                          placeholder="Ej: Mi Empresa"
                          maxlength="100"
                          class="form-input"
                          [class.error]="isFieldInvalid('businessName')"
                        />
                        <span class="char-count">{{ businessForm.get('businessName')?.value?.length || 0 }}/100</span>
                      </div>
                      @if (isFieldInvalid('businessName')) {
                        <p class="error-text">{{ getErrorMessage('businessName') }}</p>
                      }
                    </div>

                    <!-- Razón Social -->
                    <div class="form-group">
                      <label class="form-label">
                        <mat-icon>gavel</mat-icon>
                        Razón Social / Nombre Legal
                      </label>
                      <div class="input-wrapper">
                        <input
                          type="text"
                          formControlName="legalName"
                          placeholder="Ej: Mi Empresa S.A."
                          maxlength="150"
                          class="form-input"
                          [class.error]="isFieldInvalid('legalName')"
                        />
                        <span class="char-count">{{ businessForm.get('legalName')?.value?.length || 0 }}/150</span>
                      </div>
                      @if (isFieldInvalid('legalName')) {
                        <p class="error-text">{{ getErrorMessage('legalName') }}</p>
                      }
                    </div>

                    <!-- RIF / Tax ID -->
                    <div class="form-group">
                      <label class="form-label">
                        <mat-icon>badge</mat-icon>
                        RIF / Tax ID / NIT
                      </label>
                      <input
                        type="text"
                        formControlName="taxId"
                        placeholder="Ej: J-12345678-9"
                        maxlength="30"
                        class="form-input"
                        [class.error]="isFieldInvalid('taxId')"
                      />
                      @if (isFieldInvalid('taxId')) {
                        <p class="error-text">{{ getErrorMessage('taxId') }}</p>
                      }
                    </div>

                    <!-- Descripción -->
                    <div class="form-group">
                      <label class="form-label">
                        <mat-icon>description</mat-icon>
                        Descripción de la Empresa
                      </label>
                      <div class="input-wrapper">
                        <textarea
                          formControlName="description"
                          placeholder="Breve descripción de tu empresa..."
                          rows="3"
                          maxlength="500"
                          class="form-input"
                          [class.error]="isFieldInvalid('description')"
                        ></textarea>
                        <span class="char-count textarea">{{ businessForm.get('description')?.value?.length || 0 }}/500</span>
                      </div>
                      <p class="form-hint">
                        <mat-icon>info_outline</mat-icon>
                        Opcional: información adicional sobre tu empresa
                      </p>
                    </div>

                  </form>
                </div>
              </mat-tab>

              <!-- ==========================================
                   TAB 2: CONTACTO
                   ========================================== -->
              <mat-tab>
                <ng-template mat-tab-label>
                  <div class="tab-label-content">
                    <mat-icon class="tab-icon">contacts</mat-icon>
                    <span class="tab-text">Contacto</span>
                  </div>
                </ng-template>

                <div class="tab-content">
                  <form [formGroup]="businessForm" class="space-y-5">

                    <!-- Emails (dinámicos) -->
                    <div class="dynamic-section">
                      <div class="section-header">
                        <label class="form-label green">
                          <mat-icon>email</mat-icon>
                          Emails de Contacto *
                        </label>
                        @if (editMode()) {
                          <button
                            type="button"
                            class="add-btn"
                            (click)="addEmail()"
                            title="Agregar email">
                            <mat-icon>add</mat-icon>
                          </button>
                        }
                      </div>

                      <div formArrayName="emails" class="space-y-3">
                        @for (emailGroup of emails.controls; track $index) {
                          <div [formGroupName]="$index" class="dynamic-row">
                            <input
                              type="text"
                              formControlName="label"
                              placeholder="Etiqueta"
                              maxlength="30"
                              class="form-input label-input"
                            />
                            <input
                              type="email"
                              formControlName="value"
                              placeholder="email@empresa.com"
                              class="form-input flex-1"
                              [class.error]="emailGroup.get('value')?.invalid && emailGroup.get('value')?.touched"
                            />
                            @if (editMode() && emails.length > 1) {
                              <button
                                type="button"
                                class="remove-btn"
                                (click)="removeEmail($index)"
                                title="Eliminar email">
                                <mat-icon>delete</mat-icon>
                              </button>
                            }
                          </div>
                        }
                      </div>
                    </div>

                    <!-- Teléfonos (dinámicos) -->
                    <div class="dynamic-section">
                      <div class="section-header">
                        <label class="form-label green">
                          <mat-icon>phone</mat-icon>
                          Teléfonos de Contacto
                        </label>
                        @if (editMode()) {
                          <button
                            type="button"
                            class="add-btn"
                            (click)="addPhone()"
                            title="Agregar teléfono">
                            <mat-icon>add</mat-icon>
                          </button>
                        }
                      </div>

                      <div formArrayName="phones" class="space-y-3">
                        @for (phoneGroup of phones.controls; track $index) {
                          <div [formGroupName]="$index" class="dynamic-row">
                            <input
                              type="text"
                              formControlName="label"
                              placeholder="Etiqueta"
                              maxlength="30"
                              class="form-input label-input"
                            />
                            <input
                              type="tel"
                              formControlName="value"
                              placeholder="+58 212 1234567"
                              maxlength="20"
                              class="form-input flex-1"
                              [class.error]="phoneGroup.get('value')?.invalid && phoneGroup.get('value')?.touched"
                            />
                            @if (editMode() && phones.length > 1) {
                              <button
                                type="button"
                                class="remove-btn"
                                (click)="removePhone($index)"
                                title="Eliminar teléfono">
                                <mat-icon>delete</mat-icon>
                              </button>
                            }
                          </div>
                        }
                      </div>
                    </div>

                    <!-- Website -->
                    <div class="form-group">
                      <label class="form-label green">
                        <mat-icon>language</mat-icon>
                        Sitio Web
                      </label>
                      <input
                        type="url"
                        formControlName="website"
                        placeholder="https://www.empresa.com"
                        class="form-input"
                        [class.error]="isFieldInvalid('website')"
                      />
                      @if (isFieldInvalid('website')) {
                        <p class="error-text">{{ getErrorMessage('website') }}</p>
                      }
                    </div>

                  </form>
                </div>
              </mat-tab>

              <!-- ==========================================
                   TAB 3: DIRECCIÓN
                   ========================================== -->
              <mat-tab>
                <ng-template mat-tab-label>
                  <div class="tab-label-content">
                    <mat-icon class="tab-icon">location_on</mat-icon>
                    <span class="tab-text">Dirección</span>
                  </div>
                </ng-template>

                <div class="tab-content">
                  <form [formGroup]="businessForm">
                    <div formGroupName="address" class="space-y-4">

                      <!-- Calle -->
                      <div class="form-group">
                        <label class="form-label purple">
                          <mat-icon>home</mat-icon>
                          Calle y Número
                        </label>
                        <input
                          type="text"
                          formControlName="street"
                          placeholder="Ej: Av. Principal, Edif. Torre, Piso 5"
                          maxlength="200"
                          class="form-input"
                          [class.error]="isFieldInvalid('street', 'address')"
                        />
                        @if (isFieldInvalid('street', 'address')) {
                          <p class="error-text">{{ getErrorMessage('street', 'address') }}</p>
                        }
                      </div>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Ciudad -->
                        <div class="form-group">
                          <label class="form-label purple">
                            <mat-icon>location_city</mat-icon>
                            Ciudad
                          </label>
                          <input
                            type="text"
                            formControlName="city"
                            placeholder="Ej: Caracas"
                            maxlength="100"
                            class="form-input"
                            [class.error]="isFieldInvalid('city', 'address')"
                          />
                          @if (isFieldInvalid('city', 'address')) {
                            <p class="error-text">{{ getErrorMessage('city', 'address') }}</p>
                          }
                        </div>

                        <!-- Estado/Provincia -->
                        <div class="form-group">
                          <label class="form-label purple">
                            <mat-icon>map</mat-icon>
                            Estado / Provincia
                          </label>
                          <input
                            type="text"
                            formControlName="state"
                            placeholder="Ej: Distrito Capital"
                            maxlength="100"
                            class="form-input"
                            [class.error]="isFieldInvalid('state', 'address')"
                          />
                          @if (isFieldInvalid('state', 'address')) {
                            <p class="error-text">{{ getErrorMessage('state', 'address') }}</p>
                          }
                        </div>

                        <!-- Código Postal -->
                        <div class="form-group">
                          <label class="form-label purple">
                            <mat-icon>markunread_mailbox</mat-icon>
                            Código Postal
                          </label>
                          <input
                            type="text"
                            formControlName="zipCode"
                            placeholder="Ej: 1050"
                            maxlength="20"
                            class="form-input"
                            [class.error]="isFieldInvalid('zipCode', 'address')"
                          />
                          @if (isFieldInvalid('zipCode', 'address')) {
                            <p class="error-text">{{ getErrorMessage('zipCode', 'address') }}</p>
                          }
                        </div>

                        <!-- País -->
                        <div class="form-group">
                          <label class="form-label purple">
                            <mat-icon>public</mat-icon>
                            País
                          </label>
                          <input
                            type="text"
                            formControlName="country"
                            placeholder="Ej: Venezuela"
                            maxlength="100"
                            class="form-input"
                            [class.error]="isFieldInvalid('country', 'address')"
                          />
                          @if (isFieldInvalid('country', 'address')) {
                            <p class="error-text">{{ getErrorMessage('country', 'address') }}</p>
                          }
                        </div>
                      </div>

                    </div>
                  </form>
                </div>
              </mat-tab>

              <!-- ==========================================
                   TAB 4: BRANDING
                   ========================================== -->
              <mat-tab>
                <ng-template mat-tab-label>
                  <div class="tab-label-content">
                    <mat-icon class="tab-icon">palette</mat-icon>
                    <span class="tab-text">Branding</span>
                  </div>
                </ng-template>

                <div class="tab-content">
                  <form [formGroup]="businessForm" class="space-y-6">

                    <!-- Logo Section -->
                    <div class="branding-section">
                      <h3 class="section-title amber">
                        <mat-icon>image</mat-icon>
                        Logo de la Empresa
                      </h3>

                      <!-- Logo Preview -->
                      <div class="logo-preview-zone">
                        @if (logoPreview()) {
                          <div class="relative group">
                            <div class="logo-preview-box">
                              <img
                                [src]="logoPreview()"
                                alt="Logo preview"
                                class="w-full h-full object-contain p-3"
                              />
                            </div>
                            @if (editMode()) {
                              <div class="logo-overlay">
                                <button
                                  type="button"
                                  class="logo-delete-btn"
                                  (click)="logoPreview.set(''); selectedLogoFile.set(null)"
                                  title="Eliminar logo">
                                  <mat-icon>delete</mat-icon>
                                </button>
                              </div>
                            }
                          </div>
                        } @else {
                          <div class="logo-placeholder">
                            <mat-icon>image</mat-icon>
                          </div>
                        }
                        <p class="text-xs text-slate-500 font-medium mt-2">
                          {{ logoPreview() ? 'Logo actual' : 'Sin logo' }}
                        </p>
                      </div>

                      <!-- Upload Button -->
                      @if (editMode()) {
                        <div class="mt-4">
                          <input
                            type="file"
                            #logoInput
                            accept="image/*"
                            (change)="onLogoSelected($event)"
                            class="hidden"
                          />
                          <button
                            type="button"
                            class="btn-upload w-full"
                            (click)="logoInput.click()">
                            <mat-icon>cloud_upload</mat-icon>
                            {{ logoPreview() ? 'Cambiar Logo' : 'Subir Logo' }}
                          </button>
                          <p class="text-xs text-slate-500 text-center mt-2">
                            Formatos: JPG, PNG, SVG • Máx. 5MB
                          </p>
                        </div>
                      }

                      <input type="hidden" formControlName="logoUrl">
                    </div>

                    <div class="section-divider"></div>

                    <!-- Colors Section -->
                    <div class="branding-section">
                      <h3 class="section-title amber">
                        <mat-icon>color_lens</mat-icon>
                        Colores Corporativos
                      </h3>

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <!-- Color Primario -->
                        <div class="color-picker-group">
                          <label class="form-label">Color Primario</label>
                          <div class="color-picker-row">
                            <input
                              type="color"
                              formControlName="primaryColor"
                              class="color-picker"
                            />
                            <input
                              type="text"
                              formControlName="primaryColor"
                              placeholder="#3b82f6"
                              class="color-input"
                            />
                          </div>
                          <p class="form-hint">
                            <mat-icon>info_outline</mat-icon>
                            Color principal de tu marca
                          </p>
                        </div>

                        <!-- Color Secundario -->
                        <div class="color-picker-group">
                          <label class="form-label">Color Secundario</label>
                          <div class="color-picker-row">
                            <input
                              type="color"
                              formControlName="secondaryColor"
                              class="color-picker"
                            />
                            <input
                              type="text"
                              formControlName="secondaryColor"
                              placeholder="#8b5cf6"
                              class="color-input"
                            />
                          </div>
                          <p class="form-hint">
                            <mat-icon>info_outline</mat-icon>
                            Color complementario
                          </p>
                        </div>
                      </div>
                    </div>

                  </form>
                </div>
              </mat-tab>

              <!-- ==========================================
                   TAB 5: REDES SOCIALES
                   ========================================== -->
              <mat-tab>
                <ng-template mat-tab-label>
                  <div class="tab-label-content">
                    <mat-icon class="tab-icon">share</mat-icon>
                    <span class="tab-text">Redes</span>
                  </div>
                </ng-template>

                <div class="tab-content">
                  <form [formGroup]="businessForm">
                    <div formGroupName="socialMedia" class="space-y-4">

                      <!-- Facebook -->
                      <div class="form-group">
                        <label class="form-label social facebook">
                          <mat-icon>facebook</mat-icon>
                          Facebook
                        </label>
                        <input
                          type="url"
                          formControlName="facebook"
                          placeholder="https://www.facebook.com/tuempresa"
                          class="form-input"
                          [class.error]="isFieldInvalid('facebook', 'socialMedia')"
                        />
                        @if (isFieldInvalid('facebook', 'socialMedia')) {
                          <p class="error-text">{{ getErrorMessage('facebook', 'socialMedia') }}</p>
                        }
                      </div>

                      <!-- Instagram -->
                      <div class="form-group">
                        <label class="form-label social instagram">
                          <mat-icon>camera_alt</mat-icon>
                          Instagram
                        </label>
                        <input
                          type="url"
                          formControlName="instagram"
                          placeholder="https://www.instagram.com/tuempresa"
                          class="form-input"
                          [class.error]="isFieldInvalid('instagram', 'socialMedia')"
                        />
                        @if (isFieldInvalid('instagram', 'socialMedia')) {
                          <p class="error-text">{{ getErrorMessage('instagram', 'socialMedia') }}</p>
                        }
                      </div>

                      <!-- Twitter -->
                      <div class="form-group">
                        <label class="form-label social twitter">
                          <mat-icon>tag</mat-icon>
                          Twitter / X
                        </label>
                        <input
                          type="url"
                          formControlName="twitter"
                          placeholder="https://www.twitter.com/tuempresa"
                          class="form-input"
                          [class.error]="isFieldInvalid('twitter', 'socialMedia')"
                        />
                        @if (isFieldInvalid('twitter', 'socialMedia')) {
                          <p class="error-text">{{ getErrorMessage('twitter', 'socialMedia') }}</p>
                        }
                      </div>

                      <!-- LinkedIn -->
                      <div class="form-group">
                        <label class="form-label social linkedin">
                          <mat-icon>work</mat-icon>
                          LinkedIn
                        </label>
                        <input
                          type="url"
                          formControlName="linkedin"
                          placeholder="https://www.linkedin.com/company/tuempresa"
                          class="form-input"
                          [class.error]="isFieldInvalid('linkedin', 'socialMedia')"
                        />
                        @if (isFieldInvalid('linkedin', 'socialMedia')) {
                          <p class="error-text">{{ getErrorMessage('linkedin', 'socialMedia') }}</p>
                        }
                      </div>

                    </div>
                  </form>
                </div>
              </mat-tab>

            </mat-tab-group>

          </div>
        </section>

        <!-- ============================================
             RIGHT COLUMN - PREVIEW (1/3 width)
             ============================================ -->
        <section class="lg:col-span-1">

          <!-- CARD: VISTA PREVIA -->
          <div class="preview-card">
            <div class="card-header">
              <div class="card-icon cyan">
                <mat-icon>preview</mat-icon>
              </div>
              <h2 class="card-title">Vista Previa</h2>
            </div>

            <div class="space-y-4">

              <!-- Preview: Logo -->
              <div class="preview-section">
                <p class="preview-label">Logo</p>
                <div class="preview-logo-container">
                  @if (logoPreview()) {
                    <div class="preview-logo">
                      <img
                        [src]="logoPreview()"
                        alt="Logo preview"
                        class="w-full h-full object-contain p-2"
                      />
                    </div>
                  } @else {
                    <div class="preview-logo empty">
                      <mat-icon>image</mat-icon>
                    </div>
                  }
                </div>
              </div>

              <!-- Preview: Información -->
              <div class="preview-section">
                <p class="preview-label">Información</p>
                <div class="preview-info">
                  <h3 class="preview-business-name">
                    {{ businessForm.get('businessName')?.value || 'Nombre de Empresa' }}
                  </h3>
                  <p class="preview-legal-name">
                    {{ businessForm.get('legalName')?.value || 'Razón Social' }}
                  </p>
                  @if (businessForm.get('description')?.value) {
                    <p class="preview-description">
                      {{ businessForm.get('description')?.value }}
                    </p>
                  }
                </div>
              </div>

              <!-- Preview: Contacto -->
              <div class="preview-section">
                <p class="preview-label">Contacto</p>
                <div class="preview-contact">
                  @for (emailGroup of emails.controls; track $index) {
                    @if (emailGroup.get('value')?.value) {
                      <div class="contact-item">
                        <mat-icon>email</mat-icon>
                        <div>
                          <span class="contact-label">{{ emailGroup.get('label')?.value || 'Email' }}</span>
                          <span class="contact-value">{{ emailGroup.get('value')?.value }}</span>
                        </div>
                      </div>
                    }
                  }
                  @for (phoneGroup of phones.controls; track $index) {
                    @if (phoneGroup.get('value')?.value) {
                      <div class="contact-item">
                        <mat-icon>phone</mat-icon>
                        <div>
                          <span class="contact-label">{{ phoneGroup.get('label')?.value || 'Teléfono' }}</span>
                          <span class="contact-value">{{ phoneGroup.get('value')?.value }}</span>
                        </div>
                      </div>
                    }
                  }
                </div>
              </div>

              <!-- Preview: Colores -->
              <div class="preview-section">
                <p class="preview-label">Colores</p>
                <div class="preview-colors">
                  <div class="color-preview">
                    <div
                      class="color-box"
                      [style.background]="businessForm.get('primaryColor')?.value || '#3b82f6'">
                    </div>
                    <span class="color-value">{{ businessForm.get('primaryColor')?.value || '#3b82f6' }}</span>
                  </div>
                  <div class="color-preview">
                    <div
                      class="color-box"
                      [style.background]="businessForm.get('secondaryColor')?.value || '#8b5cf6'">
                    </div>
                    <span class="color-value">{{ businessForm.get('secondaryColor')?.value || '#8b5cf6' }}</span>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </section>

      </div>
    }

  </div>
</div>
