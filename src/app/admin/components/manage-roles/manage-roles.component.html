<!-- manage-roles.component.html -->
<div class="max-w-[1100px] max-h-[90vh] bg-white rounded-2xl overflow-hidden flex flex-col">

  <!-- ============================================
       HEADER
       ============================================ -->
  <div class="flex justify-between items-center px-8 py-8 bg-gradient-to-br from-green-500 to-green-600 text-white">
    <div class="flex items-center gap-4">
      <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-xl shadow-[0_4px_12px_rgba(0,0,0,0.1)]">
        <mat-icon class="!text-[28px] !w-[28px] !h-[28px]">admin_panel_settings</mat-icon>
      </div>
      <div>
        <h2 class="text-2xl font-bold mb-1">
          @if (viewMode === 'list') {
            Gestión de Roles
          } @else if (viewMode === 'add') {
            Agregar Nuevo Rol
          } @else {
            Editar Rol
          }
        </h2>
        <p class="text-green-100 text-sm">
          @if (viewMode === 'list') {
            Administra los roles del sistema y visualiza usuarios asignados
          } @else if (viewMode === 'add') {
            Define un nuevo rol con permisos personalizados
          } @else {
            Modifica la configuración del rol seleccionado
          }
        </p>
      </div>
    </div>
    <button
      mat-icon-button
      (click)="onCancel()"
      class="!text-white !bg-white/10 !border !border-white/20 hover:!bg-white/20 transition-all"
      [disabled]="isLoading">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- ============================================
       CONTENT
       ============================================ -->
  <div class="flex-1 overflow-y-auto px-8 py-8 min-h-[500px] max-h-[600px]">

    <!-- ============================================
         MODO LISTA - VER TODOS LOS ROLES
         ============================================ -->
    @if (viewMode === 'list') {
      <div>
        <!-- Action Button -->
        <div class="mb-6 flex justify-between items-center">
          <p class="text-slate-600 text-sm font-medium">
            {{ roles.length }} rol{{ roles.length !== 1 ? 'es' : '' }} en el sistema
          </p>
          <button
            mat-raised-button
            class="!bg-gradient-to-br !from-green-500 !to-green-600 !text-white"
            (click)="showAddRole()">
            <mat-icon>add</mat-icon>
            Agregar Rol
          </button>
        </div>

        <!-- Roles Grid -->
        @if (isLoading) {
          <div class="flex justify-center items-center py-20">
            <mat-spinner diameter="50"></mat-spinner>
          </div>
        } @else {
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @for (role of roles; track role.id) {
              <div class="role-card-item bg-white border-2 rounded-xl p-5 hover:shadow-lg transition-all"
                   [class.border-red-200]="role.value === 'admin'"
                   [class.border-blue-200]="role.value === 'user'"
                   [class.border-green-200]="role.value === 'viewer'"
                   [class.border-purple-200]="!role.isSystemRole">

                <!-- Header -->
                <div class="flex justify-between items-start mb-4">
                  <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center"
                         [class.bg-red-100]="role.value === 'admin'"
                         [class.bg-blue-100]="role.value === 'user'"
                         [class.bg-green-100]="role.value === 'viewer'"
                         [class.bg-purple-100]="!role.isSystemRole">
                      <mat-icon class="!text-2xl"
                                [class.text-red-600]="role.value === 'admin'"
                                [class.text-blue-600]="role.value === 'user'"
                                [class.text-green-600]="role.value === 'viewer'"
                                [class.text-purple-600]="!role.isSystemRole">
                        {{ getRoleIcon(role.value) }}
                      </mat-icon>
                    </div>
                    <div>
                      <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        {{ role.label }}
                        @if (role.isSystemRole) {
                          <span class="px-2 py-0.5 text-xs font-semibold bg-amber-100 text-amber-700 rounded-full">
                            Sistema
                          </span>
                        }
                      </h3>
                      <p class="text-xs text-slate-500 font-mono">{{ role.value }}</p>
                    </div>
                  </div>

                  <!-- Actions Menu -->
                  <button mat-icon-button [matMenuTriggerFor]="roleMenu">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #roleMenu="matMenu">
                    <button mat-menu-item (click)="showEditRole(role)">
                      <mat-icon>edit</mat-icon>
                      <span>Editar</span>
                    </button>
                    @if (!role.isSystemRole) {
                      <button mat-menu-item (click)="deleteRole(role)">
                        <mat-icon class="text-red-500">delete</mat-icon>
                        <span class="text-red-500">Eliminar</span>
                      </button>
                    }
                  </mat-menu>
                </div>

                <!-- Description -->
                <p class="text-sm text-slate-600 mb-4">{{ role.description }}</p>

                <mat-divider class="my-4"></mat-divider>

                <!-- Permissions -->
                <div class="mb-4">
                  <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-2">
                    Permisos ({{ role.permissions.length }})
                  </span>
                  <mat-chip-set class="flex flex-wrap gap-1.5">
                    @for (perm of role.permissions; track perm) {
                      <mat-chip class="!bg-blue-50 !text-blue-700 !text-xs !font-semibold">
                        <mat-icon class="!text-sm" matChipAvatar>{{ getPermissionIcon(perm) }}</mat-icon>
                        {{ getPermissionLabel(perm) }}
                      </mat-chip>
                    }
                  </mat-chip-set>
                </div>

                <!-- Users Count -->
                <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                  <div class="flex items-center gap-2">
                    <mat-icon class="!text-[18px] text-slate-400">people</mat-icon>
                    <span class="text-sm font-semibold text-slate-700">
                      {{ role.userCount || 0 }} usuario{{ (role.userCount || 0) !== 1 ? 's' : '' }}
                    </span>
                  </div>

                  @if (!role.isActive) {
                    <span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-full">
                      Inactivo
                    </span>
                  }
                </div>

                <!-- Users List (if any) -->
                @if (getUsersByRole(role.value).length > 0) {
                  <div class="mt-3 pt-3 border-t border-slate-100">
                    <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-2">
                      Usuarios asignados
                    </span>
                    <div class="flex flex-wrap gap-2">
                      @for (user of getUsersByRole(role.value).slice(0, 5); track user.uid) {
                        <div class="flex items-center gap-2 px-2.5 py-1.5 bg-slate-50 rounded-lg border border-slate-200">
                          <div class="w-6 h-6 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-semibold">
                            {{ user.displayName?.charAt(0) || user.email.charAt(0) }}
                          </div>
                          <span class="text-xs font-medium text-slate-700">
                            {{ user.displayName || user.email }}
                          </span>
                        </div>
                      }
                      @if (getUsersByRole(role.value).length > 5) {
                        <span class="px-2.5 py-1.5 text-xs font-semibold text-slate-500">
                          +{{ getUsersByRole(role.value).length - 5 }} más
                        </span>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- ============================================
         MODO AGREGAR/EDITAR - FORMULARIO
         ============================================ -->
    @if (viewMode === 'add' || viewMode === 'edit') {
      <div>
        <form [formGroup]="roleForm">

          <!-- Información Básica -->
          <div class="mb-8">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <mat-icon class="text-blue-500">info</mat-icon>
              Información Básica
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <!-- Value -->
              <div class="input-group flex flex-col gap-2">
                <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                  <mat-icon class="label-icon !text-lg text-blue-500">vpn_key</mat-icon>
                  Identificador
                  @if (selectedRole?.isSystemRole) {
                    <span class="text-xs font-normal text-slate-500">(No editable)</span>
                  }
                </label>
                <input
                  type="text"
                  class="input-field"
                  formControlName="value"
                  placeholder="ej: editor, manager"
                  [readonly]="selectedRole?.isSystemRole">
                @if (isFieldInvalid('value')) {
                  <div class="input-error">
                    {{ getErrorMessage('value') }}
                  </div>
                }
                <span class="text-xs text-slate-500">Solo letras minúsculas y guiones bajos</span>
              </div>

              <!-- Label -->
              <div class="input-group flex flex-col gap-2">
                <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                  <mat-icon class="label-icon !text-lg text-blue-500">label</mat-icon>
                  Nombre del Rol
                </label>
                <input
                  type="text"
                  class="input-field"
                  formControlName="label"
                  placeholder="ej: Editor de Contenido">
                @if (isFieldInvalid('label')) {
                  <div class="input-error">
                    {{ getErrorMessage('label') }}
                  </div>
                }
              </div>
            </div>

            <!-- Description -->
            <div class="input-group flex flex-col gap-2 mb-6">
              <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                <mat-icon class="label-icon !text-lg text-blue-500">description</mat-icon>
                Descripción
              </label>
              <textarea
                class="input-field resize-none"
                formControlName="description"
                rows="3"
                placeholder="Describe las responsabilidades de este rol..."></textarea>
              @if (isFieldInvalid('description')) {
                <div class="input-error">
                  {{ getErrorMessage('description') }}
                </div>
              }
            </div>

            <!-- Active Status -->
            <div class="status-section bg-green-50 border border-green-200 rounded-xl p-5">
              <mat-checkbox
                formControlName="isActive"
                class="status-checkbox w-full"
                color="primary">
                <div class="checkbox-content flex flex-col gap-1">
                  <span class="checkbox-label text-[15px] font-semibold text-green-800">Rol Activo</span>
                  <span class="checkbox-hint text-sm text-green-600 italic">El rol estará disponible para asignar a usuarios</span>
                </div>
              </mat-checkbox>
            </div>
          </div>

          <mat-divider class="my-8"></mat-divider>

          <!-- Permisos -->
          <div>
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <mat-icon class="text-blue-500">security</mat-icon>
              Permisos del Rol
            </h3>

            <div class="permissions-grid grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
              @for (permission of permissionOptions; track permission.value) {
                <div
                  class="permission-card flex items-start gap-3 p-4 border-2 rounded-xl cursor-pointer hover:border-blue-300 transition-all"
                  [class.border-blue-500]="isPermissionSelected(permission.value)"
                  [class.bg-blue-50]="isPermissionSelected(permission.value)"
                  [class.border-slate-200]="!isPermissionSelected(permission.value)"
                  (click)="togglePermission(permission.value)">

                  <mat-checkbox
                    [checked]="isPermissionSelected(permission.value)"
                    (change)="togglePermission(permission.value)"
                    (click)="$event.stopPropagation()"
                    color="primary"
                    class="permission-checkbox flex-shrink-0">
                  </mat-checkbox>

                  <div class="permission-content flex items-start gap-3 flex-1">
                    <mat-icon class="permission-icon !text-2xl text-blue-500 flex-shrink-0 mt-1">
                      {{ getPermissionIcon(permission.value) }}
                    </mat-icon>
                    <div>
                      <h4 class="permission-name text-sm font-semibold text-slate-800 m-0 mb-1">{{ permission.label }}</h4>
                      <p class="permission-desc text-xs text-slate-500 m-0">{{ permission.description }}</p>
                    </div>
                  </div>
                </div>
              }
            </div>

            @if (roleForm.get('permissions')?.invalid && (roleForm.get('permissions')?.dirty || roleForm.get('permissions')?.touched)) {
              <div class="text-red-500 text-sm font-medium mb-4">
                Debes seleccionar al menos un permiso
              </div>
            }

            <!-- Preview -->
            @if (roleForm.get('permissions')?.value?.length > 0) {
              <div class="selected-preview bg-slate-50 border border-slate-200 rounded-xl p-4">
                <span class="preview-label block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">
                  Permisos seleccionados ({{ roleForm.get('permissions')?.value?.length }})
                </span>
                <mat-chip-set class="modern-chip-set flex flex-wrap gap-2">
                  @for (perm of roleForm.get('permissions')?.value; track perm) {
                    <mat-chip
                      class="modern-chip permission-chip"
                      (removed)="togglePermission(perm)">
                      <mat-icon matChipAvatar class="!text-base">{{ getPermissionIcon(perm) }}</mat-icon>
                      {{ getPermissionLabel(perm) }}
                      <button matChipRemove>
                        <mat-icon>cancel</mat-icon>
                      </button>
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
            }
          </div>

        </form>
      </div>
    }

  </div>

  <!-- ============================================
       FOOTER
       ============================================ -->
  <div class="dialog-modern-footer m-0 p-0 border-t border-slate-200 bg-slate-50">
    <div class="footer-content flex justify-between items-center px-8 py-6 gap-4">

      <!-- Back button (solo en modo add/edit) -->
      <div class="footer-navigation flex-1">
        @if (viewMode !== 'list') {
          <button
            mat-button
            (click)="backToList()"
            [disabled]="isLoading"
            class="nav-button flex items-center gap-2 text-slate-500 font-medium px-4 py-2 rounded-lg hover:bg-slate-200 hover:text-slate-800 transition-all">
            <mat-icon>arrow_back</mat-icon>
            Volver
          </button>
        }
      </div>

      <!-- Actions -->
      <div class="footer-actions flex items-center gap-3">
        <button
          mat-button
          (click)="onCancel()"
          [disabled]="isLoading"
          class="cancel-button-modern text-slate-500 font-medium px-5 py-2 rounded-lg hover:bg-slate-200 hover:text-slate-800 transition-all">
          Cerrar
        </button>

        @if (viewMode !== 'list') {
          <button
            mat-raised-button
            type="button"
            (click)="saveRole()"
            [disabled]="roleForm.invalid || isLoading"
            class="create-button-modern flex items-center gap-2 font-semibold px-7 py-3 rounded-lg !bg-gradient-to-br !from-green-500 !to-green-600 !text-white !shadow-[0_4px_12px_rgba(34,197,94,0.3)] hover:!shadow-[0_8px_20px_rgba(34,197,94,0.4)] hover:!-translate-y-0.5 transition-all disabled:opacity-60 disabled:cursor-not-allowed"
            color="primary">
            @if (!isLoading) {
              <mat-icon>{{ viewMode === 'add' ? 'add' : 'save' }}</mat-icon>
            }
            @if (isLoading) {
              <mat-spinner diameter="20" class="button-spinner inline-block"></mat-spinner>
            }
            {{ isLoading ? 'Guardando...' : (viewMode === 'add' ? 'Crear Rol' : 'Guardar Cambios') }}
          </button>
        }
      </div>
    </div>
  </div>

</div>
