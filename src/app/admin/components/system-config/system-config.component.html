<!-- src/app/admin/components/system-config/system-config.component.html -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <div class="max-w-[1200px] mx-auto p-5">

    <!-- ============================================
         HEADER COMPACTO
         ============================================ -->
    <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-5">
      <div class="flex items-center justify-between gap-4 flex-wrap">

        <!-- Left Section -->
        <div class="flex items-center gap-3">
          <button
            mat-icon-button
            class="!bg-slate-100 hover:!bg-slate-200"
            (click)="goBack()"
            matTooltip="Volver al panel de admin"
            aria-label="Volver al panel de admin">
            <mat-icon>arrow_back</mat-icon>
          </button>

          <div class="header-icon-box">
            <mat-icon>settings</mat-icon>
          </div>

          <div>
            <h1 class="text-lg font-bold text-slate-800">Configuración del Sistema</h1>
            <p class="text-xs text-slate-500">Personaliza la apariencia y configuración</p>
          </div>
        </div>

        <!-- Stats Inline -->
        <div class="hidden md:flex items-center gap-3">
          <div class="stat-chip">
            <span class="stat-value">4</span>
            <span class="stat-label">Campos</span>
          </div>
          <div class="stat-chip logo">
            <span class="stat-value">{{ logoPreviewUrl() ? '1' : '0' }}</span>
            <span class="stat-label">Logo</span>
          </div>
        </div>

        <!-- Right Section -->
        <div class="flex items-center gap-2">
          <button
            mat-icon-button
            class="refresh-btn"
            (click)="loadConfiguration()"
            [disabled]="isLoading()"
            matTooltip="Recargar configuración"
            aria-label="Recargar configuración">
            <mat-icon [class.animate-spin]="isLoading()">refresh</mat-icon>
          </button>
        </div>
      </div>
    </header>

    <!-- ============================================
         LOADING STATE
         ============================================ -->
    @if (isLoading()) {
      <div class="flex flex-col items-center justify-center py-16">
        <mat-spinner diameter="40"></mat-spinner>
        <p class="mt-4 text-sm text-slate-600">Cargando configuración...</p>
      </div>
    }

    <!-- ============================================
         MAIN CONTENT
         ============================================ -->
    @if (!isLoading()) {
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

        <!-- ============================================
             LEFT COLUMN - FORMULARIO (2/3 width)
             ============================================ -->
        <section class="lg:col-span-2 space-y-5">

          <!-- CARD: INFORMACIÓN BÁSICA -->
          <div class="config-card">
            <div class="card-header">
              <div class="card-icon blue">
                <mat-icon>info</mat-icon>
              </div>
              <h2 class="card-title">Información Básica</h2>
            </div>

            <form [formGroup]="configForm" class="space-y-4">

              <!-- Nombre de la aplicación -->
              <div class="form-group">
                <label class="form-label">
                  <mat-icon>label</mat-icon>
                  Nombre de la Aplicación *
                </label>
                <div class="input-wrapper">
                  <input
                    type="text"
                    formControlName="appName"
                    placeholder="Ej: Mi Sistema Admin"
                    maxlength="50"
                    class="form-input"
                    [class.error]="isFieldInvalid('appName')"
                  />
                  <span class="char-count">{{ configForm.get('appName')?.value?.length || 0 }}/50</span>
                </div>
                @if (isFieldInvalid('appName')) {
                  <p class="error-text">{{ getErrorMessage('appName') }}</p>
                }
                <p class="form-hint">
                  <mat-icon>info_outline</mat-icon>
                  Este nombre aparecerá en el login, navbar y título del navegador
                </p>
              </div>

              <!-- Descripción -->
              <div class="form-group">
                <label class="form-label">
                  <mat-icon>description</mat-icon>
                  Descripción de la Aplicación
                </label>
                <div class="input-wrapper">
                  <textarea
                    formControlName="appDescription"
                    placeholder="Ej: Sistema de autenticación y gestión de usuarios"
                    rows="2"
                    maxlength="200"
                    class="form-input"
                    [class.error]="isFieldInvalid('appDescription')"
                  ></textarea>
                  <span class="char-count textarea">{{ configForm.get('appDescription')?.value?.length || 0 }}/200</span>
                </div>
                @if (isFieldInvalid('appDescription')) {
                  <p class="error-text">{{ getErrorMessage('appDescription') }}</p>
                }
                <p class="form-hint">
                  <mat-icon>info_outline</mat-icon>
                  Se mostrará en la pantalla de login
                </p>
              </div>

              <!-- Email de contacto -->
              <div class="form-group">
                <label class="form-label">
                  <mat-icon>email</mat-icon>
                  Email de Contacto del Administrador *
                </label>
                <input
                  type="email"
                  formControlName="adminContactEmail"
                  placeholder="admin@empresa.com"
                  class="form-input"
                  [class.error]="isFieldInvalid('adminContactEmail')"
                />
                @if (isFieldInvalid('adminContactEmail')) {
                  <p class="error-text">{{ getErrorMessage('adminContactEmail') }}</p>
                }
                <p class="form-hint">
                  <mat-icon>info_outline</mat-icon>
                  Email para soporte y contacto del sistema
                </p>
              </div>

              <!-- Texto del footer -->
              <div class="form-group">
                <label class="form-label">
                  <mat-icon>text_fields</mat-icon>
                  Texto del Footer
                </label>
                <div class="input-wrapper">
                  <input
                    type="text"
                    formControlName="footerText"
                    placeholder="Ej: © 2025 Mi Empresa. Todos los derechos reservados."
                    maxlength="100"
                    class="form-input"
                    [class.error]="isFieldInvalid('footerText')"
                  />
                  <span class="char-count">{{ configForm.get('footerText')?.value?.length || 0 }}/100</span>
                </div>
                @if (isFieldInvalid('footerText')) {
                  <p class="error-text">{{ getErrorMessage('footerText') }}</p>
                }
                <p class="form-hint">
                  <mat-icon>info_outline</mat-icon>
                  Se mostrará en el footer del dashboard
                </p>
              </div>

              <!-- Colores del Footer (Lado a lado) -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <!-- Color del footer -->
                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>palette</mat-icon>
                    Color de Fondo del Footer
                  </label>
                  <div class="color-selector">
                    <!-- Color Picker -->
                    <div class="color-input-wrapper">
                      <input
                        type="color"
                        formControlName="footerColor"
                        (input)="footerColor.set($any($event.target).value)"
                        class="color-picker"
                      />
                      <input
                        type="text"
                        formControlName="footerColor"
                        placeholder="#1e293b"
                        maxlength="7"
                        class="color-text-input"
                        (input)="footerColor.set($any($event.target).value)"
                      />
                    </div>

                    <!-- Colores predefinidos -->
                    <div class="preset-colors">
                      @for (color of footerPresetColors; track color.value) {
                        <button
                          type="button"
                          class="color-option"
                          [class.selected]="footerColor() === color.value"
                          [style.background-color]="color.value"
                          (click)="footerColor.set(color.value); configForm.patchValue({ footerColor: color.value })"
                          [matTooltip]="color.name">
                        </button>
                      }
                    </div>
                  </div>
                  <p class="form-hint">
                    <mat-icon>info_outline</mat-icon>
                    Personaliza el color de fondo del footer
                  </p>
                </div>

                <!-- Color del texto del footer -->
                <div class="form-group">
                  <label class="form-label">
                    <mat-icon>text_format</mat-icon>
                    Color del Texto del Footer
                  </label>
                  <div class="color-selector">
                    <!-- Color Picker -->
                    <div class="color-input-wrapper">
                      <input
                        type="color"
                        formControlName="footerTextColor"
                        (input)="footerTextColor.set($any($event.target).value)"
                        class="color-picker"
                      />
                      <input
                        type="text"
                        formControlName="footerTextColor"
                        placeholder="#94a3b8"
                        maxlength="7"
                        class="color-text-input"
                        (input)="footerTextColor.set($any($event.target).value)"
                      />
                    </div>

                    <!-- Colores predefinidos -->
                    <div class="preset-colors">
                      @for (color of footerTextPresetColors; track color.value) {
                        <button
                          type="button"
                          class="color-option"
                          [class.selected]="footerTextColor() === color.value"
                          [style.background-color]="color.value"
                          (click)="footerTextColor.set(color.value); configForm.patchValue({ footerTextColor: color.value })"
                          [matTooltip]="color.name">
                        </button>
                      }
                    </div>
                  </div>
                  <p class="form-hint">
                    <mat-icon>info_outline</mat-icon>
                    Asegúrate de que el texto contraste bien con el fondo del footer
                  </p>
                </div>

              </div>

            </form>
          </div>

          <!-- CARD: GESTIÓN DE LOGO -->
          <div class="config-card">
            <div class="card-header">
              <div class="card-icon purple">
                <mat-icon>image</mat-icon>
              </div>
              <h2 class="card-title">Logo de la Aplicación</h2>
            </div>

            <div class="space-y-5">

              <!-- Preview del logo -->
              <div class="logo-preview-zone">
                @if (logoPreviewUrl()) {
                  <div class="relative group">
                    <div
                      class="logo-preview-box"
                      [style.background]="logoBackgroundColor()">
                      <img
                        [src]="logoPreviewUrl()"
                        alt="Logo preview"
                        class="w-full h-full object-contain p-2"
                      />
                    </div>
                    <div class="logo-overlay">
                      <button
                        type="button"
                        class="logo-delete-btn"
                        (click)="removeLogo()"
                        [disabled]="isUploadingLogo()"
                        title="Eliminar logo">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                } @else {
                  <div class="logo-placeholder">
                    <mat-icon>image</mat-icon>
                  </div>
                }

                <p class="text-xs text-slate-500 font-medium mt-2">
                  {{ logoPreviewUrl() ? 'Logo actual' : 'Sin logo' }}
                </p>
              </div>

              <!-- Información del archivo seleccionado -->
              @if (selectedLogoFile()) {
                <div class="file-info-box">
                  <mat-icon>insert_drive_file</mat-icon>
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-blue-900">{{ selectedLogoFile()?.name }}</p>
                    <p class="text-xs text-blue-700">
                      {{ (selectedLogoFile()!.size / 1024).toFixed(2) }} KB
                    </p>
                  </div>
                  <button
                    type="button"
                    class="file-close-btn"
                    (click)="selectedLogoFile.set(null); logoPreviewUrl.set(currentConfig()?.logoUrl || '')"
                    title="Cancelar archivo seleccionado">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }

              <!-- Botones de acción -->
              <div class="flex flex-col gap-2">
                <label class="relative">
                  <input
                    type="file"
                    class="hidden"
                    #fileInput
                    accept="image/png,image/jpeg,image/jpg,image/svg+xml"
                    (change)="onLogoFileSelected($event)"
                    [disabled]="isUploadingLogo()"
                  />
                  <button
                    type="button"
                    class="btn-upload w-full"
                    [disabled]="isUploadingLogo()"
                    (click)="triggerFileInput(fileInput)">
                    <mat-icon>upload_file</mat-icon>
                    Seleccionar Archivo
                  </button>
                </label>

                @if (selectedLogoFile()) {
                  <button
                    type="button"
                    class="btn-save w-full"
                    (click)="uploadLogo()"
                    [disabled]="isUploadingLogo()">
                    @if (isUploadingLogo()) {
                      <mat-spinner diameter="18"></mat-spinner>
                    } @else {
                      <mat-icon>cloud_upload</mat-icon>
                    }
                    {{ isUploadingLogo() ? 'Subiendo...' : 'Subir Logo' }}
                  </button>
                }

                @if (logoPreviewUrl() && !selectedLogoFile()) {
                  <button
                    type="button"
                    class="btn-delete w-full"
                    (click)="removeLogo()"
                    [disabled]="isUploadingLogo()">
                    <mat-icon>delete</mat-icon>
                    Eliminar Logo Actual
                  </button>
                }
              </div>

              <!-- Selector de color de fondo -->
              <div class="color-section">
                <label class="form-label mb-3">
                  <mat-icon>palette</mat-icon>
                  Color de Fondo del Logo
                </label>

                <!-- Colores predefinidos -->
                <div class="color-grid">
                  @for (color of presetColors; track color.value) {
                    <button
                      type="button"
                      class="color-btn"
                      [class.selected]="logoBackgroundColor() === color.value"
                      [style.background]="color.value === 'transparent' ? 'repeating-conic-gradient(#e2e8f0 0% 25%, white 0% 50%) 50% / 10px 10px' : color.value"
                      (click)="onColorChange(color.value)"
                      [title]="color.name">

                      @if (logoBackgroundColor() === color.value) {
                        <mat-icon
                          class="check-icon"
                          [class.dark]="color.value !== 'transparent' && color.value !== '#ffffff' && color.value !== '#f8fafc'">
                          check_circle
                        </mat-icon>
                      }
                    </button>
                  }
                </div>

                <!-- Color picker personalizado -->
                <div class="flex items-center gap-3 mt-3">
                  <input
                    type="color"
                    class="color-picker"
                    [value]="logoBackgroundColor() === 'transparent' ? '#ffffff' : logoBackgroundColor()"
                    (input)="onColorChange($any($event.target).value)"
                  />
                  <input
                    type="text"
                    class="color-input"
                    [value]="logoBackgroundColor()"
                    (input)="onColorChange($any($event.target).value)"
                    placeholder="#000000 o transparent"
                  />
                </div>

                <p class="form-hint mt-2">
                  <mat-icon>info_outline</mat-icon>
                  El color de fondo se aplicará detrás del logo en login y navbar
                </p>
              </div>

              <!-- Especificaciones -->
              <div class="specs-box">
                <p class="specs-title">
                  <mat-icon>info</mat-icon>
                  Especificaciones del Logo
                </p>
                <ul class="specs-list">
                  <li>• Formatos: PNG, JPG, SVG</li>
                  <li>• Tamaño máximo: 2 MB</li>
                  <li>• Dimensiones recomendadas: 300x300 px</li>
                  <li>• Se usará en login, navbar y favicon</li>
                </ul>
              </div>

            </div>
          </div>

          <!-- BOTONES DE ACCIÓN AL FINAL -->
          <div class="config-card">
            <div class="card-actions">
              <button
                type="button"
                class="btn-cancel"
                (click)="goBack()"
                [disabled]="isSaving()">
                <mat-icon>close</mat-icon>
                Cancelar
              </button>

              <button
                type="button"
                class="btn-save"
                (click)="saveConfiguration()"
                [disabled]="configForm.invalid || isSaving()">
                @if (isSaving()) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  <mat-icon>save</mat-icon>
                }
                {{ isSaving() ? 'Guardando...' : 'Guardar Cambios' }}
              </button>
            </div>
          </div>

        </section>

        <!-- ============================================
             RIGHT COLUMN - PREVIEW (1/3 width)
             ============================================ -->
        <section class="lg:col-span-1">

          <!-- CARD: VISTA PREVIA EN VIVO -->
          <div class="config-card preview-card">
            <div class="card-header">
              <div class="card-icon green">
                <mat-icon>preview</mat-icon>
              </div>
              <h2 class="card-title">Vista Previa</h2>
            </div>

            <div class="space-y-5">

              <!-- Preview: Navbar -->
              <div class="preview-section">
                <p class="preview-label">Navbar</p>
                <div class="preview-navbar">
                  <div class="flex items-center gap-3">
                    @if (logoPreviewUrl()) {
                      <div
                        class="preview-logo-sm"
                        [style.background]="logoBackgroundColor()">
                        <img
                          [src]="logoPreviewUrl()"
                          alt="Logo"
                          class="w-full h-full object-contain p-1"
                        />
                      </div>
                    } @else {
                      <div class="preview-logo-sm default">
                        <mat-icon>admin_panel_settings</mat-icon>
                      </div>
                    }
                    <div>
                      <p class="text-sm font-bold text-slate-800">
                        {{ configForm.get('appName')?.value || 'Nombre de la App' }}
                      </p>
                      <p class="text-xs text-slate-400">v2.0</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Preview: Login -->
              <div class="preview-section">
                <p class="preview-label">Pantalla de Login</p>
                <div class="preview-login">
                  <div class="preview-login-card">
                    @if (logoPreviewUrl()) {
                      <div
                        class="preview-logo-lg"
                        [style.background]="logoBackgroundColor()">
                        <img
                          [src]="logoPreviewUrl()"
                          alt="Logo"
                          class="w-full h-full object-contain p-2"
                        />
                      </div>
                    } @else {
                      <div class="preview-logo-lg default">
                        <mat-icon>admin_panel_settings</mat-icon>
                      </div>
                    }
                    <h3 class="text-base font-bold text-slate-800 text-center">
                      {{ configForm.get('appName')?.value || 'Nombre de la App' }}
                    </h3>
                    <p class="text-xs text-slate-500 text-center line-clamp-2">
                      {{ configForm.get('appDescription')?.value || 'Descripción de la aplicación' }}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Preview: Footer -->
              <div class="preview-section">
                <p class="preview-label">Footer</p>
                <div class="preview-footer" [style.background-color]="footerColor()">
                  <p class="text-xs text-center" [style.color]="footerTextColor()">
                    {{ configForm.get('footerText')?.value || 'Texto del footer' }}
                  </p>
                </div>
              </div>

              <!-- Información de contacto -->
              <div class="preview-section">
                <p class="preview-label">Contacto</p>
                <div class="preview-contact">
                  <mat-icon>email</mat-icon>
                  <p class="text-xs font-medium text-blue-900 truncate">
                    {{ configForm.get('adminContactEmail')?.value || 'admin@empresa.com' }}
                  </p>
                </div>
              </div>

            </div>
          </div>

        </section>

      </div>
    }

  </div>
</div>
