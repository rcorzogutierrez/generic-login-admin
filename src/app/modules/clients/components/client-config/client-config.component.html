<!-- src/app/modules/clients/components/client-config/client-config.component.html -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <div class="max-w-[1400px] mx-auto p-5">

    <!-- HEADER -->
    <header class="page-header">
      <div class="flex items-center justify-between gap-5 flex-wrap">

        <!-- Left Section -->
        <div class="flex items-center gap-4">
          <button
            mat-icon-button
            class="icon-btn"
            (click)="goBack()"
            matTooltip="Volver a clientes">
            <mat-icon>arrow_back</mat-icon>
          </button>

          <div class="header-icon-container" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
            <mat-icon>settings</mat-icon>
          </div>

          <div>
            <h1 class="text-2xl font-bold text-slate-800 mb-1">Configuración del Módulo</h1>
            <p class="text-sm text-slate-600 flex items-center gap-2 font-medium">
              <span class="status-dot"></span>
              Administra campos personalizados y configuración
            </p>
          </div>
        </div>

        <!-- Right Section -->
        <div class="flex items-center gap-3">
          <button
            mat-icon-button
            class="icon-btn"
            (click)="loadConfig()"
            [disabled]="isLoading"
            matTooltip="Recargar configuración">
            <mat-icon>refresh</mat-icon>
          </button>

          <button
            mat-raised-button
            color="primary"
            (click)="addField()"
            [disabled]="isLoading">
            <mat-icon>add</mat-icon>
            Nuevo Campo
          </button>
        </div>
      </div>
    </header>

    <!-- LOADING STATE -->
    @if (isLoading && fields.length === 0) {
      <div class="empty-state">
        <mat-spinner diameter="50"></mat-spinner>
        <p class="mt-4 text-slate-600 font-medium">Cargando configuración...</p>
      </div>
    }

    <!-- MAIN CONTENT -->
    @if (!isLoading || fields.length > 0) {

      <!-- TABS -->
      <mat-tab-group class="config-tabs" animationDuration="300ms">

        <!-- TAB 1: LISTA DE CAMPOS -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="mr-2">list</mat-icon>
            Lista de Campos
          </ng-template>

          <!-- Stats -->
          <section class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 mt-6">
        <div class="card-corporate">
          <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mb-4">
            <mat-icon class="!text-2xl text-white">dashboard</mat-icon>
          </div>
          <div class="text-3xl font-bold text-slate-800 mb-1">{{ totalFields }}</div>
          <div class="text-sm text-slate-600 font-semibold">Total Campos</div>
        </div>

        <div class="card-corporate">
          <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mb-4">
            <mat-icon class="!text-2xl text-white">check_circle</mat-icon>
          </div>
          <div class="text-3xl font-bold text-slate-800 mb-1">{{ activeFields }}</div>
          <div class="text-sm text-slate-600 font-semibold">Activos</div>
        </div>

        <div class="card-corporate">
          <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center mb-4">
            <mat-icon class="!text-2xl text-white">extension</mat-icon>
          </div>
          <div class="text-3xl font-bold text-slate-800 mb-1">{{ customFields }}</div>
          <div class="text-sm text-slate-600 font-semibold">Personalizados</div>
        </div>

        <div class="card-corporate">
          <div class="w-12 h-12 bg-gradient-to-br from-slate-500 to-slate-600 rounded-xl flex items-center justify-center mb-4">
            <mat-icon class="!text-2xl text-white">lock</mat-icon>
          </div>
          <div class="text-3xl font-bold text-slate-800 mb-1">{{ systemFields }}</div>
          <div class="text-sm text-slate-600 font-semibold">Sistema</div>
        </div>

        <div class="card-corporate">
          <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center mb-4">
            <mat-icon class="!text-2xl text-white">table_chart</mat-icon>
          </div>
          <div class="text-3xl font-bold text-slate-800 mb-1">{{ gridColumns }}</div>
          <div class="text-sm text-slate-600 font-semibold">Columnas Visibles</div>
        </div>
      </section>

      <!-- EMPTY STATE -->
      @if (fields.length === 0) {
        <div class="empty-state">
          <mat-icon class="!text-6xl text-slate-300 mb-4">settings</mat-icon>
          <h3 class="text-lg font-semibold text-slate-800 mb-2">No hay campos configurados</h3>
          <p class="text-sm text-slate-600 mb-6">Comienza agregando el primer campo personalizado</p>
          <button
            mat-raised-button
            color="primary"
            (click)="addField()">
            <mat-icon>add</mat-icon>
            Crear Campo
          </button>
        </div>
      }

      <!-- FIELDS LIST -->
      @if (fields.length > 0) {
        <section class="bg-white rounded-2xl p-6 border border-slate-200 shadow-soft">

          <!-- Info de drag & drop -->
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-lg font-bold text-slate-800 mb-1">Campos del Formulario</h2>
              <p class="text-sm text-slate-600">
                Arrastra para reordenar • {{ fields.length }} campo(s)
              </p>
            </div>
          </div>

          <!-- Lista con drag & drop -->
          <div
            cdkDropList
            (cdkDropListDropped)="onFieldDrop($event)"
            class="space-y-3">

            @for (field of fields; track trackByFieldId($index, field)) {
              <div
                cdkDrag
                class="field-card group"
                [class.inactive]="!field.isActive"
                [class.system-field]="field.isSystem">

                <!-- Drag Handle -->
                <div cdkDragHandle class="drag-handle">
                  <mat-icon class="text-slate-400 cursor-move">drag_indicator</mat-icon>
                </div>

                <!-- Icon -->
                <div
                  class="field-icon"
                  [class.inactive-icon]="!field.isActive">
                  <mat-icon>{{ field.icon || getFieldTypeIcon(field.type) }}</mat-icon>
                </div>

                <!-- Content -->
                <div class="field-content">
                  <div class="flex items-center gap-3 mb-1 flex-wrap">
                    <h3 class="field-title">{{ field.label }}</h3>

                    <!-- Badges -->
                    <mat-chip-set>
                      <mat-chip class="!text-xs !h-6">
                        <mat-icon class="!text-xs mr-1">{{ getFieldTypeIcon(field.type) }}</mat-icon>
                        {{ getFieldTypeLabel(field.type) }}
                      </mat-chip>

                      @if (field.isSystem) {
                        <mat-chip class="!text-xs !h-6 !bg-slate-100 !text-slate-700">
                          <mat-icon class="!text-xs mr-1">lock</mat-icon>
                          Sistema
                        </mat-chip>
                      }

                      @if (!field.isActive) {
                        <mat-chip class="!text-xs !h-6 !bg-red-100 !text-red-700">
                          <mat-icon class="!text-xs mr-1">cancel</mat-icon>
                          Inactivo
                        </mat-chip>
                      }

                      @if (field.validation.required) {
                        <mat-chip class="!text-xs !h-6 !bg-blue-100 !text-blue-700">
                          <mat-icon class="!text-xs mr-1">star</mat-icon>
                          Requerido
                        </mat-chip>
                      }

                      @if (field.gridConfig.showInGrid) {
                        <mat-chip class="!text-xs !h-6 !bg-green-100 !text-green-700">
                          <mat-icon class="!text-xs mr-1">visibility</mat-icon>
                          Visible en tabla
                        </mat-chip>
                      }
                    </mat-chip-set>
                  </div>

                  <div class="flex items-center gap-4 mt-2 text-xs text-slate-500">
                    <span class="flex items-center gap-1">
                      <mat-icon class="!text-sm">code</mat-icon>
                      {{ field.name }}
                    </span>
                    @if (field.placeholder) {
                      <span class="flex items-center gap-1">
                        <mat-icon class="!text-sm">text_snippet</mat-icon>
                        "{{ field.placeholder }}"
                      </span>
                    }
                    <span class="flex items-center gap-1">
                      <mat-icon class="!text-sm">format_list_numbered</mat-icon>
                      Orden: {{ field.formOrder }}
                    </span>
                    @if (field.gridConfig.showInGrid) {
                      <span class="flex items-center gap-1">
                        <mat-icon class="!text-sm">view_column</mat-icon>
                        Columna: {{ field.gridConfig.gridOrder }}
                      </span>
                    }
                  </div>
                </div>

                <!-- Actions -->
                <div class="field-actions">
                  <button
                    mat-icon-button
                    [matMenuTriggerFor]="fieldMenu"
                    class="icon-btn">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #fieldMenu="matMenu">
                    <button mat-menu-item (click)="editField(field)">
                      <mat-icon>edit</mat-icon>
                      Editar
                    </button>

                    <button mat-menu-item (click)="toggleFieldStatus(field)">
                      <mat-icon>{{ field.isActive ? 'cancel' : 'check_circle' }}</mat-icon>
                      {{ field.isActive ? 'Desactivar' : 'Activar' }}
                    </button>

                    <button mat-menu-item (click)="toggleGridVisibility(field)">
                      <mat-icon>{{ field.gridConfig.showInGrid ? 'visibility_off' : 'visibility' }}</mat-icon>
                      {{ field.gridConfig.showInGrid ? 'Ocultar en tabla' : 'Mostrar en tabla' }}
                    </button>

                    @if (!field.isSystem) {
                      <mat-divider></mat-divider>

                      <button
                        mat-menu-item
                        (click)="deleteField(field)"
                        class="!text-red-600">
                        <mat-icon class="!text-red-600">delete</mat-icon>
                        Eliminar
                      </button>
                    }
                  </mat-menu>
                </div>

              </div>
            }
          </div>

        </section>
      }

        </mat-tab>

        <!-- TAB 2: DISEÑO DE FORMULARIO -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="mr-2">view_quilt</mat-icon>
            Diseño de Formulario
          </ng-template>

          <div class="mt-6">
            <app-form-designer
              [fields]="fields"
              [layout]="formLayout"
              (layoutChange)="onLayoutChange($event)">
            </app-form-designer>
          </div>

        </mat-tab>

      </mat-tab-group>

    }

  </div>
</div>
