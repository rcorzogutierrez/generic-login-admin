<!-- client-form.component.html - DISEÑO COMPACTO -->
<div class="form-container">

  @if (isLoading()) {
    <!-- Loading State -->
    <div class="empty-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p class="mt-3 text-sm text-slate-600">Cargando formulario...</p>
    </div>
  } @else {

    <!-- ============================================
         HEADER COMPACTO
         ============================================ -->
    <header class="form-header">
      <div class="flex items-center gap-3">
        <button type="button"
                class="back-btn"
                (click)="onCancel()"
                [disabled]="isSaving()"
                title="Volver">
          <mat-icon>arrow_back</mat-icon>
        </button>

        <div class="header-icon-box">
          <mat-icon>
            {{ mode() === 'create' ? 'person_add' : (mode() === 'edit' ? 'edit' : 'visibility') }}
          </mat-icon>
        </div>

        <div>
          <h1 class="text-lg font-bold text-slate-800">
            @switch (mode()) {
              @case ('create') { Nuevo Cliente }
              @case ('edit') { Editar Cliente }
              @case ('view') { Ver Cliente }
            }
          </h1>
          <p class="text-xs text-slate-500">
            @if (mode() === 'create') {
              Complete la información del nuevo cliente
            } @else if (currentClient()) {
              {{ currentClient()!.name }}
            }
          </p>
        </div>
      </div>

      @if (mode() === 'view') {
        <button type="button" class="btn-edit" (click)="enableEdit()">
          <mat-icon>edit</mat-icon>
          Editar
        </button>
      }
    </header>

    <!-- ============================================
         FORMULARIO
         ============================================ -->
    <form [formGroup]="clientForm" (ngSubmit)="onSubmit()" class="form-content">

      <!-- Banner de Validación -->
      @if (mode() !== 'view' && hasValidationErrors() && clientForm.touched) {
        <div class="validation-banner">
          <div class="flex items-start gap-3">
            <div class="validation-icon">
              <mat-icon>error_outline</mat-icon>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-red-800 mb-1">Campos incompletos</h4>
              <ul class="space-y-1">
                @for (field of getInvalidFields().slice(0, 5); track field.id) {
                  <li class="text-xs text-red-700 flex items-center gap-1.5">
                    <span class="w-1 h-1 bg-red-500 rounded-full"></span>
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="text-red-500">(requerido)</span>
                    }
                  </li>
                }
              </ul>
            </div>
          </div>
        </div>
      }

      <!-- Grid de Campos -->
      <div class="form-fields" [class]="getGridClass() + ' ' + getFormSpacing()">

        @for (row of getGridRows(); track $index) {
          @for (field of row; track field.id) {
            <div class="field-wrapper">

              <!-- ========== TEXT / EMAIL / PHONE / URL ========== -->
              @if (field.type === FieldType.TEXT || field.type === FieldType.EMAIL || field.type === FieldType.PHONE || field.type === FieldType.URL) {
                <div class="form-group">
                  <label class="form-label">
                    @if (field.icon) {
                      <mat-icon>{{ field.icon }}</mat-icon>
                    }
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required">*</span>
                    }
                  </label>
                  <input [type]="field.type === FieldType.EMAIL ? 'email' : field.type === FieldType.URL ? 'url' : field.type === FieldType.PHONE ? 'tel' : 'text'"
                         class="form-input"
                         [class.error]="hasError(field.name)"
                         [formControlName]="field.name"
                         [placeholder]="field.placeholder || ''"
                         [readonly]="mode() === 'view'">
                  @if (field.helpText && !hasError(field.name)) {
                    <span class="help-text">{{ field.helpText }}</span>
                  }
                  @if (hasError(field.name)) {
                    <span class="error-text">{{ getErrorMessage(field.name) }}</span>
                  }
                </div>
              }

              <!-- ========== NUMBER / CURRENCY ========== -->
              @if (field.type === FieldType.NUMBER || field.type === FieldType.CURRENCY) {
                <div class="form-group">
                  <label class="form-label">
                    @if (field.icon) {
                      <mat-icon>{{ field.icon }}</mat-icon>
                    }
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required">*</span>
                    }
                  </label>
                  <div class="input-wrapper">
                    @if (field.type === FieldType.CURRENCY) {
                      <span class="input-prefix">$</span>
                    }
                    <input type="number"
                           class="form-input"
                           [class.error]="hasError(field.name)"
                           [class.has-prefix]="field.type === FieldType.CURRENCY"
                           [formControlName]="field.name"
                           [placeholder]="field.placeholder || ''"
                           [min]="field.validation.min ?? null"
                           [max]="field.validation.max ?? null"
                           [step]="field.type === FieldType.CURRENCY ? '0.01' : '1'"
                           [readonly]="mode() === 'view'">
                  </div>
                  @if (hasError(field.name)) {
                    <span class="error-text">{{ getErrorMessage(field.name) }}</span>
                  }
                </div>
              }

              <!-- ========== TEXTAREA ========== -->
              @if (field.type === FieldType.TEXTAREA) {
                <div class="form-group">
                  <label class="form-label">
                    @if (field.icon) {
                      <mat-icon>{{ field.icon }}</mat-icon>
                    }
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required">*</span>
                    }
                  </label>
                  <textarea class="form-input form-textarea"
                            [class.error]="hasError(field.name)"
                            [formControlName]="field.name"
                            [placeholder]="field.placeholder || ''"
                            rows="3"
                            [maxlength]="field.validation.maxLength ?? null"
                            [readonly]="mode() === 'view'"></textarea>
                  @if (hasError(field.name)) {
                    <span class="error-text">{{ getErrorMessage(field.name) }}</span>
                  }
                </div>
              }

              <!-- ========== SELECT ========== -->
              @if (field.type === FieldType.SELECT) {
                <div class="form-group">
                  <label class="form-label">
                    @if (field.icon) {
                      <mat-icon>{{ field.icon }}</mat-icon>
                    }
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required">*</span>
                    }
                  </label>
                  <select class="form-input form-select"
                          [class.error]="hasError(field.name)"
                          [formControlName]="field.name"
                          [disabled]="mode() === 'view'">
                    <option value="">{{ field.placeholder || 'Seleccionar...' }}</option>
                    @for (option of field.options; track option.value) {
                      <option [value]="option.value">{{ option.label }}</option>
                    }
                  </select>
                  @if (hasError(field.name)) {
                    <span class="error-text">{{ getErrorMessage(field.name) }}</span>
                  }
                </div>
              }

              <!-- ========== MULTISELECT ========== -->
              @if (field.type === FieldType.MULTISELECT) {
                <div class="form-group">
                  <label class="form-label">
                    @if (field.icon) {
                      <mat-icon>{{ field.icon }}</mat-icon>
                    }
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required">*</span>
                    }
                  </label>
                  <select multiple
                          class="form-input form-multiselect"
                          [class.error]="hasError(field.name)"
                          [formControlName]="field.name"
                          [disabled]="mode() === 'view'">
                    @for (option of field.options; track option.value) {
                      <option [value]="option.value">{{ option.label }}</option>
                    }
                  </select>
                  <span class="help-text">Ctrl + click para selección múltiple</span>
                </div>
              }

              <!-- ========== DICTIONARY ========== -->
              @if (field.type === FieldType.DICTIONARY) {
                <div class="form-group">
                  <label class="form-label">
                    @if (field.icon) {
                      <mat-icon>{{ field.icon }}</mat-icon>
                    }
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required">*</span>
                    }
                  </label>
                  <div class="dictionary-grid">
                    @for (option of field.options; track option.value) {
                      <div class="dictionary-item">
                        <span class="dictionary-label">{{ option.label }}</span>
                        <input type="text"
                               class="form-input"
                               [formControlName]="field.name + '_' + option.value"
                               [placeholder]="option.label"
                               [readonly]="mode() === 'view'">
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- ========== DATE ========== -->
              @if (field.type === FieldType.DATE || field.type === FieldType.DATETIME) {
                <div class="form-group">
                  <label class="form-label">
                    @if (field.icon) {
                      <mat-icon>{{ field.icon }}</mat-icon>
                    }
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required">*</span>
                    }
                  </label>
                  <input [type]="field.type === FieldType.DATETIME ? 'datetime-local' : 'date'"
                         class="form-input"
                         [class.error]="hasError(field.name)"
                         [formControlName]="field.name"
                         [readonly]="mode() === 'view'">
                  @if (hasError(field.name)) {
                    <span class="error-text">{{ getErrorMessage(field.name) }}</span>
                  }
                </div>
              }

              <!-- ========== CHECKBOX ========== -->
              @if (field.type === FieldType.CHECKBOX) {
                <div class="checkbox-card">
                  <input type="checkbox"
                         [id]="'checkbox-' + field.name"
                         class="checkbox-input"
                         [formControlName]="field.name"
                         [disabled]="mode() === 'view'">
                  <label [for]="'checkbox-' + field.name" class="checkbox-content">
                    <div class="checkbox-header">
                      @if (field.icon) {
                        <mat-icon>{{ field.icon }}</mat-icon>
                      }
                      <span>{{ field.label }}</span>
                    </div>
                    @if (field.helpText) {
                      <p class="checkbox-help">{{ field.helpText }}</p>
                    }
                  </label>
                </div>
              }

            </div>
          }
        }

      </div>

      <!-- ============================================
           ACCIONES
           ============================================ -->
      @if (mode() !== 'view') {
        <div class="form-actions" [class]="getButtonsJustify() + ' ' + getButtonsDirection()">
          <button type="button"
                  class="btn-cancel"
                  (click)="onCancel()"
                  [disabled]="isSaving()">
            Cancelar
          </button>

          <button type="submit"
                  class="btn-save"
                  [disabled]="clientForm.invalid || isSaving()">
            @if (isSaving()) {
              <mat-spinner diameter="18"></mat-spinner>
              Guardando...
            } @else {
              <mat-icon>{{ mode() === 'create' ? 'add' : 'save' }}</mat-icon>
              {{ mode() === 'create' ? 'Crear Cliente' : 'Guardar Cambios' }}
            }
          </button>
        </div>
      }

    </form>

  }

</div>
