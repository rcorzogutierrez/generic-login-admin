<!-- material-form.component.html - DISEÑO COMPACTO -->

<div class="form-container">

  @if (isLoading()) {
    <!-- Loading State -->
    <div class="flex flex-col items-center justify-center py-16">
      <div class="loading-spinner"></div>
      <p class="text-sm text-slate-500 mt-3">Cargando formulario...</p>
    </div>
  } @else {

    <!-- ========== HEADER COMPACTO ========== -->
    <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-5 animate-fadeIn">
      <div class="flex items-center justify-between gap-4 flex-wrap">

        <div class="flex items-center gap-3">
          <button type="button"
                  class="back-btn"
                  (click)="onCancel()"
                  [disabled]="isSaving()"
                  title="Volver a materiales">
            <mat-icon>arrow_back</mat-icon>
          </button>

          <div class="header-icon-box green">
            <mat-icon>
              {{ mode() === 'create' ? 'add_circle' : (mode() === 'edit' ? 'edit' : 'visibility') }}
            </mat-icon>
          </div>

          <div>
            <h1 class="text-lg font-bold text-slate-800">
              @switch (mode()) {
                @case ('create') { Nuevo Material }
                @case ('edit') { Editar Material }
                @case ('view') { Ver Material }
              }
            </h1>
            <p class="text-xs text-slate-500">
              @if (mode() === 'create') {
                Complete la información del nuevo material
              } @else if (currentMaterial()) {
                {{ currentMaterial()!.name }}
              }
            </p>
          </div>
        </div>

        @if (mode() === 'view') {
          <button type="button"
                  class="btn-secondary"
                  (click)="enableEdit()">
            <mat-icon>edit</mat-icon>
            <span>Editar</span>
          </button>
        }

      </div>
    </header>

    <!-- ========== FORMULARIO ========== -->
    <form [formGroup]="materialForm" (ngSubmit)="onSubmit()" class="form-card animate-fadeIn" style="animation-delay: 0.1s">

      <!-- Grid de Campos Dinámicos -->
      <div [ngStyle]="getGridStyle()">

        @for (field of fields(); track field.id) {
          <div [ngStyle]="getFieldStyle(field)">

            <!-- ========== TEXT / EMAIL / PHONE / URL ========== -->
            @if (field.type === FieldType.TEXT || field.type === FieldType.EMAIL || field.type === FieldType.PHONE || field.type === FieldType.URL) {
              <div class="form-group">
                <label class="form-label">
                  @if (field.icon) {
                    <mat-icon class="label-icon">{{ field.icon }}</mat-icon>
                  }
                  {{ field.label }}
                  @if (field.validation.required) {
                    <span class="text-red-500">*</span>
                  }
                </label>
                <input
                  [type]="field.type === FieldType.EMAIL ? 'email' : field.type === FieldType.URL ? 'url' : field.type === FieldType.PHONE ? 'tel' : 'text'"
                  class="form-input"
                  [class.error]="hasError(field.name)"
                  [formControlName]="field.name"
                  [placeholder]="field.placeholder || ''"
                  [readonly]="mode() === 'view'">
                @if (field.helpText && !hasError(field.name)) {
                  <span class="form-help">{{ field.helpText }}</span>
                }
                @if (hasError(field.name)) {
                  <span class="form-error">{{ getErrorMessage(field.name) }}</span>
                }
              </div>
            }

            <!-- ========== NUMBER / CURRENCY ========== -->
            @if (field.type === FieldType.NUMBER || field.type === FieldType.CURRENCY) {
              <div class="form-group">
                <label class="form-label">
                  @if (field.icon) {
                    <mat-icon class="label-icon">{{ field.icon }}</mat-icon>
                  }
                  {{ field.label }}
                  @if (field.validation.required) {
                    <span class="text-red-500">*</span>
                  }
                </label>
                <div class="relative">
                  @if (field.type === FieldType.CURRENCY) {
                    <span class="currency-prefix">$</span>
                  }
                  <input
                    type="number"
                    class="form-input"
                    [class.error]="hasError(field.name)"
                    [class.has-prefix]="field.type === FieldType.CURRENCY"
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder || ''"
                    [min]="field.validation.min ?? null"
                    [max]="field.validation.max ?? null"
                    [readonly]="mode() === 'view'"
                    [step]="field.type === FieldType.CURRENCY ? '0.01' : '1'">
                </div>
                @if (field.helpText && !hasError(field.name)) {
                  <span class="form-help">{{ field.helpText }}</span>
                }
                @if (hasError(field.name)) {
                  <span class="form-error">{{ getErrorMessage(field.name) }}</span>
                }
              </div>
            }

            <!-- ========== TEXTAREA ========== -->
            @if (field.type === FieldType.TEXTAREA) {
              <div class="form-group">
                <label class="form-label">
                  @if (field.icon) {
                    <mat-icon class="label-icon">{{ field.icon }}</mat-icon>
                  }
                  {{ field.label }}
                  @if (field.validation.required) {
                    <span class="text-red-500">*</span>
                  }
                </label>
                <textarea
                  class="form-textarea"
                  [class.error]="hasError(field.name)"
                  [formControlName]="field.name"
                  [placeholder]="field.placeholder || ''"
                  rows="3"
                  [maxlength]="field.validation.maxLength ?? null"
                  [readonly]="mode() === 'view'"></textarea>
                @if (field.helpText && !hasError(field.name)) {
                  <span class="form-help">{{ field.helpText }}</span>
                }
                @if (hasError(field.name)) {
                  <span class="form-error">{{ getErrorMessage(field.name) }}</span>
                }
              </div>
            }

            <!-- ========== SELECT ========== -->
            @if (field.type === FieldType.SELECT) {
              <div class="form-group">
                <label class="form-label">
                  @if (field.icon) {
                    <mat-icon class="label-icon">{{ field.icon }}</mat-icon>
                  }
                  {{ field.label }}
                  @if (field.validation.required) {
                    <span class="text-red-500">*</span>
                  }
                </label>
                <select
                  class="form-select"
                  [class.error]="hasError(field.name)"
                  [formControlName]="field.name"
                  [disabled]="mode() === 'view'">
                  <option value="">{{ field.placeholder || 'Seleccionar...' }}</option>
                  @for (option of field.options; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                  }
                </select>
                @if (field.helpText && !hasError(field.name)) {
                  <span class="form-help">{{ field.helpText }}</span>
                }
                @if (hasError(field.name)) {
                  <span class="form-error">{{ getErrorMessage(field.name) }}</span>
                }
              </div>
            }

            <!-- ========== MULTISELECT ========== -->
            @if (field.type === FieldType.MULTISELECT) {
              <div class="form-group">
                <label class="form-label">
                  @if (field.icon) {
                    <mat-icon class="label-icon">{{ field.icon }}</mat-icon>
                  }
                  {{ field.label }}
                  @if (field.validation.required) {
                    <span class="text-red-500">*</span>
                  }
                </label>
                <select
                  multiple
                  class="form-select multiselect"
                  [class.error]="hasError(field.name)"
                  [formControlName]="field.name"
                  [disabled]="mode() === 'view'">
                  @for (option of field.options; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                  }
                </select>
                <span class="form-help">Mantén presionado Ctrl para seleccionar múltiples</span>
                @if (hasError(field.name)) {
                  <span class="form-error">{{ getErrorMessage(field.name) }}</span>
                }
              </div>
            }

            <!-- ========== DATE / DATETIME ========== -->
            @if (field.type === FieldType.DATE || field.type === FieldType.DATETIME) {
              <div class="form-group">
                <label class="form-label">
                  @if (field.icon) {
                    <mat-icon class="label-icon">{{ field.icon }}</mat-icon>
                  }
                  {{ field.label }}
                  @if (field.validation.required) {
                    <span class="text-red-500">*</span>
                  }
                </label>
                <input
                  [type]="field.type === FieldType.DATETIME ? 'datetime-local' : 'date'"
                  class="form-input"
                  [class.error]="hasError(field.name)"
                  [formControlName]="field.name"
                  [readonly]="mode() === 'view'">
                @if (field.helpText && !hasError(field.name)) {
                  <span class="form-help">{{ field.helpText }}</span>
                }
                @if (hasError(field.name)) {
                  <span class="form-error">{{ getErrorMessage(field.name) }}</span>
                }
              </div>
            }

            <!-- ========== CHECKBOX ========== -->
            @if (field.type === FieldType.CHECKBOX) {
              <div class="form-group">
                <label class="form-label">
                  @if (field.icon) {
                    <mat-icon class="label-icon">{{ field.icon }}</mat-icon>
                  }
                  {{ field.label }}
                </label>
                <label class="checkbox-card" [class.checked]="materialForm.get(field.name)?.value">
                  <input
                    type="checkbox"
                    [formControlName]="field.name"
                    [disabled]="mode() === 'view'">
                  <span class="checkbox-label">{{ field.placeholder || field.label }}</span>
                </label>
                @if (field.helpText) {
                  <span class="form-help">{{ field.helpText }}</span>
                }
              </div>
            }

          </div>
        }

      </div>

      <!-- ========== ACCIONES ========== -->
      @if (mode() !== 'view') {
        <div class="form-actions">
          <button type="button"
                  class="btn-cancel"
                  (click)="onCancel()"
                  [disabled]="isSaving()">
            <mat-icon>close</mat-icon>
            <span>Cancelar</span>
          </button>

          <button type="submit"
                  class="btn-save"
                  [disabled]="isSaving() || materialForm.invalid">
            @if (isSaving()) {
              <div class="btn-spinner"></div>
            } @else {
              <mat-icon>save</mat-icon>
            }
            <span>{{ mode() === 'create' ? 'Crear Material' : 'Guardar Cambios' }}</span>
          </button>
        </div>
      }

    </form>

  }

</div>
