<!-- materials-list.component.html -->

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <div class="max-w-[1600px] mx-auto p-5">

    <!-- ========== HEADER ========== -->
    <header class="page-header">
      <div class="flex items-center justify-between gap-5 flex-wrap">

        <!-- Título e Icono -->
        <div class="flex items-center gap-4">
          <div class="header-icon-container" style="background: linear-gradient(135deg, #10b981, #059669);">
            <mat-icon>inventory_2</mat-icon>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-slate-800 mb-1">Gestión de Materiales</h1>
            <p class="text-sm text-slate-500">
              {{ materials().length }} materiales
              @if (getActiveMaterialsCount() > 0) {
                <span class="text-green-600 font-semibold"> • {{ getActiveMaterialsCount() }} activos</span>
              }
            </p>
          </div>
        </div>

        <!-- Acciones del Header -->
        <div class="flex items-center gap-3">
          <button
            mat-icon-button
            class="icon-btn"
            (click)="refreshData()"
            [disabled]="isLoading"
            matTooltip="Actualizar"
            aria-label="Actualizar lista de materiales">
            <mat-icon>refresh</mat-icon>
          </button>

          <button
            mat-icon-button
            class="icon-btn"
            (click)="goToConfig()"
            matTooltip="Configurar módulo"
            aria-label="Configurar módulo de materiales">
            <mat-icon>settings</mat-icon>
          </button>

          <button
            mat-raised-button
            color="primary"
            (click)="createMaterial()"
            [disabled]="isLoading"
            class="flex items-center gap-2">
            <mat-icon>add</mat-icon>
            Nuevo Material
          </button>
        </div>

      </div>
    </header>

    <!-- ========== BÚSQUEDA ========== -->
    <div class="card-modern mb-6">
      <div class="flex items-center gap-4">
        <mat-icon class="text-slate-400">search</mat-icon>
        <input
          type="text"
          placeholder="Buscar por nombre, código o descripción..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="applyFilters()"
          class="flex-1 px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium
                 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all
                 placeholder:text-slate-400">

        @if (searchTerm) {
          <button
            mat-icon-button
            (click)="searchTerm = ''; applyFilters()"
            matTooltip="Limpiar búsqueda"
            aria-label="Limpiar búsqueda">
            <mat-icon>close</mat-icon>
          </button>
        }
      </div>
    </div>

    <!-- ========== BARRA DE ACCIONES MASIVAS ========== -->
    @if (selectedMaterials.size > 0) {
      <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6 flex items-center justify-between animate-fadeIn">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
            <mat-icon class="text-white !text-xl">check_circle</mat-icon>
          </div>
          <div>
            <p class="text-sm font-bold text-blue-900">
              {{ selectedMaterials.size }} material(es) seleccionado(s)
            </p>
            <p class="text-xs text-blue-700">
              Puedes realizar acciones sobre los elementos seleccionados
            </p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button
            mat-button
            (click)="clearSelection()"
            class="text-blue-700 font-medium">
            <mat-icon>close</mat-icon>
            Cancelar selección
          </button>

          <button
            mat-raised-button
            (click)="deleteSelectedMaterials()"
            class="!bg-red-500 !text-white hover:!bg-red-600 font-semibold">
            <mat-icon>delete</mat-icon>
            Eliminar seleccionados
          </button>
        </div>
      </div>
    }

    <!-- ========== TABLA DE MATERIALES ========== -->
    <div class="card-modern">

      @if (isLoading) {
        <!-- Loading State -->
        <div class="flex flex-col items-center justify-center py-16">
          <div class="w-10 h-10 border-4 border-green-600 border-t-transparent rounded-full animate-spin"></div>
          <p class="text-sm text-slate-500 mt-4">Cargando materiales...</p>
        </div>
      } @else if (displayedMaterials().length === 0) {
        <!-- Empty State -->
        <div class="empty-state">
          <mat-icon>inventory_2</mat-icon>
          <h3>No hay materiales</h3>
          <p>{{ searchTerm ? 'No se encontraron materiales con esos criterios de búsqueda' : 'Comienza agregando tu primer material' }}</p>
          @if (!searchTerm) {
            <button
              mat-raised-button
              color="primary"
              (click)="createMaterial()"
              class="empty-state-button">
              <mat-icon>add</mat-icon>
              Crear Primer Material
            </button>
          }
        </div>
      } @else {
        <!-- Tabla -->
        <div class="overflow-x-auto">
          <table class="w-full" role="table" aria-label="Tabla de materiales">
            <caption class="sr-only">Listado de materiales con su información, estado y acciones disponibles</caption>

            <!-- Header -->
            <thead class="bg-slate-50 border-b-2 border-slate-200">
              <tr>
                <!-- Checkbox -->
                <th class="px-4 py-3 text-left w-12">
                  <input
                    type="checkbox"
                    [checked]="selectedMaterials.size > 0 && selectedMaterials.size === displayedMaterials().length"
                    [indeterminate]="selectedMaterials.size > 0 && selectedMaterials.size < displayedMaterials().length"
                    (change)="toggleSelectAll()"
                    class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                </th>

                <!-- Columnas -->
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                  Nombre
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider w-40">
                  Código
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                  Descripción
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider w-32">
                  Estado
                </th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider w-24">
                  Acciones
                </th>
              </tr>
            </thead>

            <!-- Body -->
            <tbody class="divide-y divide-slate-200">
              @for (material of displayedMaterials(); track material.id) {
                <tr
                  class="hover:bg-slate-50 transition-colors"
                  [class.bg-blue-50]="isSelected(material.id)">

                  <!-- Checkbox -->
                  <td class="px-4 py-3" (click)="$event.stopPropagation()">
                    <input
                      type="checkbox"
                      [checked]="isSelected(material.id)"
                      (change)="toggleSelection(material.id)"
                      class="w-4 h-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                  </td>

                  <!-- Nombre -->
                  <td class="px-4 py-3 text-sm text-slate-700 font-medium">
                    {{ material.name }}
                  </td>

                  <!-- Código -->
                  <td class="px-4 py-3 text-sm text-slate-600">
                    {{ material.code }}
                  </td>

                  <!-- Descripción -->
                  <td class="px-4 py-3 text-sm text-slate-600">
                    {{ material.description || '-' }}
                  </td>

                  <!-- Estado -->
                  <td class="px-4 py-3">
                    @if (material.isActive) {
                      <span class="badge-status-active">
                        <mat-icon class="!text-xs">check_circle</mat-icon>
                        Activo
                      </span>
                    } @else {
                      <span class="badge-status-inactive">
                        <mat-icon class="!text-xs">cancel</mat-icon>
                        Inactivo
                      </span>
                    }
                  </td>

                  <!-- Acciones -->
                  <td class="px-4 py-3 text-right" (click)="$event.stopPropagation()">
                    <button
                      mat-icon-button
                      [matMenuTriggerFor]="menu"
                      (click)="$event.stopPropagation()"
                      aria-label="Abrir menú de opciones del material">
                      <mat-icon>more_vert</mat-icon>
                    </button>

                    <mat-menu #menu="matMenu">
                      <button mat-menu-item (click)="editMaterial(material)">
                        <mat-icon>edit</mat-icon>
                        <span>Editar</span>
                      </button>
                      <mat-divider></mat-divider>
                      <button mat-menu-item (click)="deleteMaterial(material)" class="text-red-600">
                        <mat-icon class="text-red-600">delete</mat-icon>
                        <span>Eliminar</span>
                      </button>
                    </mat-menu>
                  </td>

                </tr>
              }
            </tbody>

          </table>
        </div>

        <!-- Mostrar información si hay más elementos -->
        @if (filteredMaterials().length > displayedMaterials().length) {
          <div class="px-4 py-4 border-t border-slate-200 text-sm text-slate-600 text-center bg-amber-50">
            Mostrando {{ displayedMaterials().length }} de {{ filteredMaterials().length }} materiales.
            <button
              mat-button
              color="primary"
              (click)="displayedMaterials.set(filteredMaterials())"
              class="ml-2">
              Mostrar todos
            </button>
          </div>
        }

      }

    </div>

  </div>
</div>
