<!-- add-client-dialog.component.html -->

<div class="dialog-container">
  <!-- Header Compacto -->
  <div class="dialog-header">
    <div class="header-content">
      <div class="icon-box">
        <mat-icon>person_add</mat-icon>
      </div>
      <div class="header-text">
        <h2 class="dialog-title">Nuevo Cliente</h2>
        <p class="dialog-subtitle">Complete los datos del cliente</p>
      </div>
    </div>
    <button type="button" (click)="cancel()" class="close-btn" title="Cerrar (Esc)">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Loading State -->
  @if (isLoading() && fields().length === 0) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p class="loading-text">Cargando formulario...</p>
    </div>
  } @else {
    <!-- Form Container con Scroll Optimizado -->
    <div class="form-scroll-container">
      <form [formGroup]="clientForm" (ngSubmit)="save()" class="form-content">

        <!-- Campos DinÃ¡micos con Grid Mejorado -->
        <div class="fields-grid">
          @for (field of fields(); track field.id) {
            <div [ngClass]="getFieldWidth(field)" class="field-wrapper">

              <!-- TEXT / EMAIL / URL / PHONE -->
              @if (field.type === FieldType.TEXT || field.type === FieldType.EMAIL || field.type === FieldType.URL || field.type === FieldType.PHONE) {
                <div class="field-group">
                  <label class="field-label">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required-indicator">*</span>
                    }
                  </label>
                  <div class="input-wrapper">
                    @if (field.icon) {
                      <mat-icon class="input-icon">{{ field.icon }}</mat-icon>
                    }
                    <input
                      [type]="field.type === FieldType.EMAIL ? 'email' : field.type === FieldType.URL ? 'url' : 'tel'"
                      [formControlName]="field.name"
                      [placeholder]="field.placeholder || ''"
                      [class.has-icon]="field.icon"
                      [class.has-error]="hasError(field.name)"
                      class="input-field"
                      [attr.aria-label]="field.label">
                  </div>
                  @if (hasError(field.name)) {
                    <p class="error-message">
                      <mat-icon class="error-icon">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                  @if (field.helpText && !hasError(field.name)) {
                    <p class="help-text">{{ field.helpText }}</p>
                  }
                </div>
              }

              <!-- TEXTAREA -->
              @if (field.type === FieldType.TEXTAREA) {
                <div class="field-group">
                  <label class="field-label">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required-indicator">*</span>
                    }
                  </label>
                  <textarea
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder || ''"
                    rows="3"
                    [class.has-error]="hasError(field.name)"
                    class="textarea-field"
                    [attr.aria-label]="field.label"></textarea>
                  @if (hasError(field.name)) {
                    <p class="error-message">
                      <mat-icon class="error-icon">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                  @if (field.helpText && !hasError(field.name)) {
                    <p class="help-text">{{ field.helpText }}</p>
                  }
                </div>
              }

              <!-- NUMBER / CURRENCY -->
              @if (field.type === FieldType.NUMBER || field.type === FieldType.CURRENCY) {
                <div class="field-group">
                  <label class="field-label">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required-indicator">*</span>
                    }
                  </label>
                  <div class="input-wrapper">
                    @if (field.type === FieldType.CURRENCY) {
                      <span class="currency-symbol">$</span>
                    }
                    <input
                      type="number"
                      [formControlName]="field.name"
                      [placeholder]="field.placeholder || '0.00'"
                      [min]="field.validation.min ?? 0"
                      [max]="field.validation.max ?? null"
                      step="0.01"
                      [class.has-currency]="field.type === FieldType.CURRENCY"
                      [class.has-error]="hasError(field.name)"
                      class="input-field"
                      [attr.aria-label]="field.label">
                  </div>
                  @if (hasError(field.name)) {
                    <p class="error-message">
                      <mat-icon class="error-icon">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                </div>
              }

              <!-- DATE -->
              @if (field.type === FieldType.DATE) {
                <div class="field-group">
                  <label class="field-label">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required-indicator">*</span>
                    }
                  </label>
                  <div class="input-wrapper">
                    <mat-icon class="input-icon">event</mat-icon>
                    <input
                      type="date"
                      [formControlName]="field.name"
                      class="input-field has-icon"
                      [class.has-error]="hasError(field.name)"
                      [attr.aria-label]="field.label">
                  </div>
                  @if (hasError(field.name)) {
                    <p class="error-message">
                      <mat-icon class="error-icon">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                </div>
              }

              <!-- SELECT -->
              @if (field.type === FieldType.SELECT) {
                <div class="field-group">
                  <label class="field-label">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required-indicator">*</span>
                    }
                  </label>
                  <div class="input-wrapper">
                    @if (field.icon) {
                      <mat-icon class="input-icon">{{ field.icon }}</mat-icon>
                    }
                    <select
                      [formControlName]="field.name"
                      [class.has-icon]="field.icon"
                      [class.has-error]="hasError(field.name)"
                      class="select-field"
                      [attr.aria-label]="field.label">
                      <option value="">Seleccionar...</option>
                      @for (option of field.options; track option.value) {
                        <option [value]="option.value">{{ option.label }}</option>
                      }
                    </select>
                    <mat-icon class="select-arrow">arrow_drop_down</mat-icon>
                  </div>
                  @if (hasError(field.name)) {
                    <p class="error-message">
                      <mat-icon class="error-icon">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                </div>
              }

              <!-- CHECKBOX -->
              @if (field.type === FieldType.CHECKBOX) {
                <div class="checkbox-wrapper">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      [id]="field.name"
                      [formControlName]="field.name"
                      class="checkbox-input">
                    <span class="checkbox-text">{{ field.label }}</span>
                  </label>
                </div>
              }

              <!-- MULTISELECT -->
              @if (field.type === FieldType.MULTISELECT) {
                <div class="field-group">
                  <label class="field-label">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="required-indicator">*</span>
                    }
                  </label>
                  <div class="multiselect-container">
                    @for (option of field.options; track option.value) {
                      <label class="multiselect-option">
                        <input
                          type="checkbox"
                          [id]="field.name + '_' + option.value"
                          [value]="option.value"
                          class="checkbox-input">
                        <span class="checkbox-text">{{ option.label }}</span>
                      </label>
                    }
                  </div>
                  @if (hasError(field.name)) {
                    <p class="error-message">
                      <mat-icon class="error-icon">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                </div>
              }

              <!-- DICTIONARY -->
              @if (field.type === FieldType.DICTIONARY && field.options && field.options.length > 0) {
                <div class="dictionary-field">
                  <div class="field-group-header">
                    <label class="field-label">{{ field.label }}</label>
                    @if (field.helpText) {
                      <p class="help-text">{{ field.helpText }}</p>
                    }
                  </div>
                  <div class="dictionary-grid">
                    @for (option of field.options; track option.value) {
                      <div class="dictionary-item">
                        <label class="dictionary-label">{{ option.label }}</label>
                        <input
                          type="text"
                          [formControlName]="field.name + '_' + option.value"
                          [placeholder]="option.label"
                          class="dictionary-input"
                          [attr.aria-label]="option.label">
                      </div>
                    }
                  </div>
                </div>
              }

            </div>
          }
        </div>

      </form>
    </div>

    <!-- Footer -->
    <div class="dialog-footer">
      <button
        type="button"
        (click)="cancel()"
        [disabled]="isLoading()"
        class="btn-cancel">
        <mat-icon>close</mat-icon>
        <span>Cancelar</span>
      </button>
      <button
        type="button"
        (click)="save()"
        [disabled]="isLoading() || clientForm.invalid"
        class="btn-primary">
        @if (isLoading()) {
          <span class="spinner-small"></span>
        } @else {
          <mat-icon>check</mat-icon>
        }
        <span>{{ isLoading() ? 'Guardando...' : 'Guardar Cliente' }}</span>
      </button>
    </div>
  }

</div>
