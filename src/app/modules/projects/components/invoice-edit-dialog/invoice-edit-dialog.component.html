<!-- invoice-edit-dialog.component.html - Estilo Compacto Blue -->

<div class="dialog-container">

  <!-- Header -->
  <div class="dialog-header">
    <div class="header-content">
      <div class="icon-box">
        <mat-icon>receipt_long</mat-icon>
      </div>
      <div class="header-text">
        <h2 class="dialog-title">{{ 'projects.invoice.createInvoice' | translate }}</h2>
        <p class="dialog-subtitle">{{ 'projects.invoice.completeData' | translate }}</p>
      </div>
    </div>
    <button type="button" class="close-btn" (click)="cancel()" title="Cerrar">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Content -->
  <div class="dialog-content">

    <!-- Idioma y Fecha de Factura -->
    <div class="section section-primary">
      <div class="section-header">
        <div class="section-icon">
          <mat-icon>description</mat-icon>
        </div>
        <h3 class="section-title">{{ 'projects.invoice.invoiceInformation' | translate }}</h3>
        <span class="required-badge">{{ 'common.required' | translate }}</span>
      </div>
      <div class="form-grid cols-2">
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.documentLanguage' | translate }} <span class="required">*</span>
          </label>
          <select
            [(ngModel)]="language"
            (ngModelChange)="onLanguageChange($event)"
            class="form-select">
            <option value="es">游쀯릖 Espa침ol</option>
            <option value="en">游쥟릖 English</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.invoice.issueDate' | translate }} <span class="required">*</span>
          </label>
          <input
            type="date"
            [(ngModel)]="invoiceDate"
            required
            class="form-input"
            [placeholder]="'projects.invoice.selectDate' | translate">
        </div>
      </div>
    </div>

    <!-- Fechas y Tiempo de Trabajo -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">
          <mat-icon>calendar_month</mat-icon>
        </div>
        <h3 class="section-title">{{ 'projects.invoice.datesAndWorkTime' | translate }}</h3>
        <span class="required-badge">{{ 'common.required' | translate }}</span>
      </div>
      <div class="form-grid cols-3">
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.invoice.startDate' | translate }} <span class="required">*</span>
          </label>
          <input
            type="date"
            [(ngModel)]="workStartDate"
            required
            class="form-input"
            [placeholder]="'projects.invoice.selectDate' | translate">
        </div>
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.invoice.endDate' | translate }} <span class="required">*</span>
          </label>
          <input
            type="date"
            [(ngModel)]="workEndDate"
            required
            class="form-input"
            [placeholder]="'projects.invoice.selectDate' | translate">
        </div>
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.invoice.hoursWorked' | translate }} <span class="required">*</span>
          </label>
          <div class="input-with-suffix">
            <input
              type="number"
              [(ngModel)]="workTime"
              min="0.5"
              step="0.5"
              required
              class="form-input"
              [placeholder]="'projects.invoice.exampleHours' | translate">
            <span class="input-suffix">{{ 'projects.invoice.hrs' | translate }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Materiales Usados -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon icon-amber">
          <mat-icon>inventory_2</mat-icon>
        </div>
        <h3 class="section-title">{{ 'projects.invoice.materialsUsed' | translate }}</h3>
      </div>

      <!-- Select para agregar material -->
      <div class="add-item-row">
        <select
          #materialSelect
          (change)="addMaterial(materialSelect.value); materialSelect.value = ''"
          class="form-select">
          <option value="">{{ 'projects.invoice.selectMaterial' | translate }}</option>
          @for (material of availableMaterials(); track material.id) {
            <option [value]="material.id">{{ getMaterialName(material) }}</option>
          }
        </select>
      </div>

      <!-- Lista de materiales seleccionados -->
      <div class="items-list">
        @for (material of selectedMaterials; track $index; let i = $index) {
          <div class="item-row">
            <div class="item-name">
              <mat-icon class="item-icon">category</mat-icon>
              <span>{{ material.materialName }}</span>
            </div>
            <div class="item-inputs">
              <div class="item-input-group">
                <label class="item-label">Cant.</label>
                <input
                  type="number"
                  [(ngModel)]="material.amount"
                  min="0"
                  step="1"
                  class="item-input"
                  placeholder="0">
              </div>
              <div class="item-input-group">
                <label class="item-label">Precio</label>
                <div class="price-input-wrapper">
                  <span class="price-symbol">$</span>
                  <input
                    type="number"
                    [(ngModel)]="material.price"
                    min="0"
                    step="0.01"
                    class="item-input price-input"
                    placeholder="0.00">
                </div>
              </div>
            </div>
            <button type="button" (click)="removeMaterial(i)" class="remove-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }
        @if (selectedMaterials.length === 0) {
          <div class="empty-state">
            <mat-icon>inventory_2</mat-icon>
            <p>{{ 'projects.invoice.noMaterialsAdded' | translate }}</p>
          </div>
        }
      </div>
    </div>

    <!-- Categor칤a de Markup (solo si est치 habilitado) -->
    @if (markupEnabled() && markupCategories().length > 0) {
      <div class="section section-markup">
        <div class="section-header">
          <div class="section-icon icon-orange">
            <mat-icon>trending_up</mat-icon>
          </div>
          <h3 class="section-title">Categor칤a de Markup</h3>
          <span class="info-badge">Afecta el costo de materiales</span>
        </div>

        <div class="markup-info-box">
          <mat-icon>info</mat-icon>
          <p>Selecciona la categor칤a de markup para aplicar al costo de los materiales. El porcentaje se sumar치 autom치ticamente al total.</p>
        </div>

        <div class="form-group">
          <label class="form-label">
            Selecciona una categor칤a
          </label>
          <select
            [(ngModel)]="selectedMarkupCategoryId"
            class="form-select markup-select">
            @for (category of markupCategories(); track category.id) {
              <option [value]="category.id">
                {{ category.name }} (+{{ category.percentage }}%)
              </option>
            }
          </select>
        </div>
      </div>
    }

    <!-- Trabajadores -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon icon-green">
          <mat-icon>engineering</mat-icon>
        </div>
        <h3 class="section-title">{{ 'projects.invoice.workers' | translate }}</h3>
      </div>

      <!-- Select para agregar trabajador -->
      <div class="add-item-row">
        <select
          #workerSelect
          (change)="addWorker(workerSelect.value); workerSelect.value = ''"
          class="form-select">
          <option value="">{{ 'projects.invoice.selectWorker' | translate }}</option>
          @for (worker of availableWorkers(); track worker.id) {
            <option [value]="worker.id">{{ getWorkerName(worker) }}</option>
          }
        </select>
      </div>

      <!-- Lista de trabajadores seleccionados -->
      <div class="items-list">
        @for (worker of selectedWorkers; track $index; let i = $index) {
          <div class="item-row worker-row">
            <div class="item-name">
              <mat-icon class="item-icon">person</mat-icon>
              <span>{{ worker.workerName }}</span>
            </div>
            <button type="button" (click)="removeWorker(i)" class="remove-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }
        @if (selectedWorkers.length === 0) {
          <div class="empty-state">
            <mat-icon>engineering</mat-icon>
            <p>{{ 'projects.invoice.noWorkersAdded' | translate }}</p>
          </div>
        }
      </div>
    </div>

    <!-- Resumen de Costos -->
    @if (selectedMaterials.length > 0) {
      <div class="section section-summary">
        <div class="section-header">
          <div class="section-icon icon-blue">
            <mat-icon>payments</mat-icon>
          </div>
          <h3 class="section-title">{{ 'projects.invoice.costSummary' | translate }}</h3>
        </div>

        <!-- Tabla de materiales -->
        <div class="summary-table-wrapper">
          <table class="summary-table">
            <thead>
              <tr>
                <th class="text-left">{{ 'projects.invoice.material' | translate }}</th>
                <th class="text-center">{{ 'projects.invoice.qty' | translate }}</th>
                <th class="text-right">{{ 'projects.invoice.unitPrice' | translate }}</th>
                <th class="text-right">{{ 'projects.invoice.total' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              @for (material of selectedMaterials; track $index) {
                <tr>
                  <td>{{ material.materialName }}</td>
                  <td class="text-center">{{ material.amount }}</td>
                  <td class="text-right">{{ formatCurrency(material.price) }}</td>
                  <td class="text-right font-semibold">{{ formatCurrency(material.amount * material.price) }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Totales -->
        <div class="totals-section">
          <div class="total-row subtotal">
            <span class="total-label">{{ 'projects.invoice.estimateSubtotal' | translate }}:</span>
            <span class="total-value">{{ formatCurrency(getProposalSubtotal()) }}</span>
          </div>
          <div class="total-row materials">
            <span class="total-label">{{ 'projects.invoice.materialsSubtotal' | translate }}:</span>
            <span class="total-value">{{ formatCurrency(calculateMaterialsSubtotal()) }}</span>
          </div>
          <div class="total-row grand-total">
            <span class="total-label">{{ 'projects.invoice.grandTotal' | translate }}:</span>
            <span class="total-value">{{ formatCurrency(calculateGrandTotal()) }}</span>
          </div>
        </div>
      </div>
    }

  </div>

  <!-- Footer -->
  <div class="dialog-footer">
    <button
      type="button"
      (click)="cancel()"
      [disabled]="isSaving()"
      class="btn-cancel">
      <mat-icon>close</mat-icon>
      <span>{{ 'common.cancel' | translate }}</span>
    </button>
    <button
      type="button"
      (click)="save()"
      [disabled]="isSaving()"
      class="btn-primary">
      @if (isSaving()) {
        <span class="spinner-small"></span>
        <span>{{ 'common.saving' | translate }}...</span>
      } @else {
        <mat-icon>check</mat-icon>
        <span>{{ 'projects.invoice.createInvoice' | translate }}</span>
      }
    </button>
  </div>

</div>
