<!-- proposal-config.component.html - DISEÑO COMPACTO -->

<div class="config-container">

  <!-- ========== HEADER COMPACTO ========== -->
  <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-5 animate-fadeIn">
    <div class="flex items-center gap-4">
      <button type="button" class="back-btn" (click)="goBack()" title="Volver">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-icon-box blue">
        <mat-icon>settings</mat-icon>
      </div>
      <div>
        <h1 class="text-lg font-bold text-slate-800">Configuración de Estimados</h1>
        <p class="text-xs text-slate-500">Mapeo de campos y valores por defecto</p>
      </div>
    </div>
  </header>

  <!-- ========== INFO BOX ========== -->
  <div class="info-box animate-fadeIn" style="animation-delay: 0.05s">
    <mat-icon>lightbulb</mat-icon>
    <div>
      <h3>¿Cómo funciona?</h3>
      <p>Cuando actives "Usar misma dirección del cliente" en el formulario de estimados, el sistema copiará automáticamente los datos usando este mapeo.</p>
    </div>
  </div>

  <form [formGroup]="configForm" class="space-y-5">

    <!-- ========== CAMPOS BÁSICOS DEL CLIENTE ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.1s">
      <div class="section-header">
        <div class="section-icon blue">
          <mat-icon>person</mat-icon>
        </div>
        <div>
          <h2>Campos Básicos del Cliente</h2>
          <p>Mapea los campos del Cliente con los del Estimado</p>
        </div>
      </div>

      <div class="mapping-grid">
        @for (mapping of basicFieldMappings; track mapping.formControlName) {
          <div class="mapping-row">
            <div class="mapping-source">
              <mat-icon class="field-icon">{{ mapping.icon }}</mat-icon>
              <select [formControlName]="mapping.formControlName" required class="mapping-select">
                @for (field of availableFields(); track field.name) {
                  <option [value]="field.name">{{ field.label }}</option>
                }
              </select>
            </div>
            <div class="mapping-arrow">
              <mat-icon>arrow_forward</mat-icon>
            </div>
            <div class="mapping-target">
              <mat-icon>{{ mapping.destinationIcon || mapping.icon }}</mat-icon>
              <span>{{ mapping.label }}</span>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- ========== CAMPOS DE DIRECCIÓN ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.15s">
      <div class="section-header">
        <div class="section-icon purple">
          <mat-icon>location_on</mat-icon>
        </div>
        <div>
          <h2>Campos de Dirección</h2>
          <p>Mapea los campos de dirección del Cliente con los del Estimado</p>
        </div>
      </div>

      <div class="mapping-grid">
        @for (mapping of addressFieldMappings; track mapping.formControlName) {
          <div class="mapping-row">
            <div class="mapping-source">
              <mat-icon class="field-icon">{{ mapping.icon }}</mat-icon>
              <select [formControlName]="mapping.formControlName" required class="mapping-select">
                @for (field of availableFields(); track field.name) {
                  <option [value]="field.name">{{ field.label }}</option>
                }
              </select>
            </div>
            <div class="mapping-arrow">
              <mat-icon>arrow_forward</mat-icon>
            </div>
            <div class="mapping-target">
              <mat-icon>{{ mapping.destinationIcon || mapping.icon }}</mat-icon>
              <span>{{ mapping.label }}</span>
              @if (mapping.badge) {
                <span class="field-badge">{{ mapping.badge }}</span>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <!-- ========== VALORES POR DEFECTO ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.2s">
      <div class="section-header">
        <div class="section-icon amber">
          <mat-icon>tune</mat-icon>
        </div>
        <div>
          <h2>Valores Por Defecto</h2>
          <p>Define valores predeterminados para nuevos estimados</p>
        </div>
      </div>

      <div class="defaults-grid">
        <!-- Impuesto por defecto -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>percent</mat-icon>
            Impuesto por Defecto (%)
          </label>
          <input
            type="number"
            formControlName="defaultTaxPercentage"
            min="0"
            max="100"
            step="0.01"
            class="form-input"
            placeholder="0">
        </div>

        <!-- Días de validez -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>event</mat-icon>
            Validez por Defecto (días)
          </label>
          <input
            type="number"
            formControlName="defaultValidityDays"
            min="1"
            step="1"
            class="form-input"
            placeholder="30">
        </div>

        <!-- Tipo de trabajo -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>business</mat-icon>
            Tipo de Trabajo por Defecto
          </label>
          <select formControlName="defaultWorkType" class="form-input">
            <option value="residential">Residencial</option>
            <option value="commercial">Comercial</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ========== TÉRMINOS Y CONDICIONES ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.25s">
      <div class="section-header">
        <div class="section-icon green">
          <mat-icon>description</mat-icon>
        </div>
        <div>
          <h2>Términos y Condiciones</h2>
          <p>Este texto aparecerá automáticamente en todos los nuevos estimados</p>
        </div>
      </div>

      <div class="form-group">
        <textarea
          formControlName="defaultTerms"
          rows="10"
          class="form-textarea"
          placeholder="Ingresa los términos y condiciones por defecto..."></textarea>
      </div>
    </div>

    <!-- ========== BOTONES DE ACCIÓN ========== -->
    <div class="actions-bar animate-fadeIn" style="animation-delay: 0.3s">
      <div class="flex gap-2">
        <button type="button" class="btn-cancel" (click)="goBack()" [disabled]="isSaving()">
          <mat-icon>close</mat-icon>
          <span>Cancelar</span>
        </button>
        <button type="button" class="btn-secondary" (click)="resetToDefaults()" [disabled]="isSaving()">
          <mat-icon>refresh</mat-icon>
          <span>Restablecer</span>
        </button>
      </div>

      <button type="button" class="btn-save" (click)="saveConfig()" [disabled]="isSaving() || configForm.invalid">
        @if (isSaving()) {
          <div class="btn-spinner"></div>
        } @else {
          <mat-icon>save</mat-icon>
        }
        <span>Guardar Configuración</span>
      </button>
    </div>

  </form>

</div>
