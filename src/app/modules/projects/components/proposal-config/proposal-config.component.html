<!-- proposal-config.component.html -->

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <div class="max-w-[1200px] mx-auto p-5">

    <!-- ========== HEADER ========== -->
    <header class="page-header mb-8">
      <div class="flex items-center justify-between gap-5">
        <div class="flex items-center gap-4">
          <button
            mat-icon-button
            (click)="goBack()"
            class="icon-btn">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div>
            <h1 class="text-3xl font-bold text-slate-800 flex items-center gap-3">
              <mat-icon class="!text-3xl text-blue-600">swap_horiz</mat-icon>
              Mapeo de Campos del Cliente
            </h1>
            <p class="text-sm text-slate-500 mt-1">
              Selecciona qué campos del cliente quieres mapear al estimado
            </p>
          </div>
        </div>
      </div>
    </header>

    <!-- ========== INFORMACIÓN ========== -->
    <div class="card-modern p-5 mb-6 bg-blue-50 border-2 border-blue-200">
      <div class="flex items-start gap-4">
        <mat-icon class="text-blue-600 !text-2xl mt-0.5">lightbulb</mat-icon>
        <div class="flex-1">
          <h3 class="text-lg font-bold text-blue-900 mb-2">¿Cómo funciona?</h3>
          <p class="text-sm text-blue-800 mb-3">
            Elige los campos del cliente que quieres usar en tus estimados y mapéalos a los campos correspondientes.
            Solo agrega los campos que necesites.
          </p>
          <div class="flex items-center gap-2 text-xs text-blue-700 bg-blue-100 rounded px-3 py-2">
            <mat-icon class="!text-sm">info</mat-icon>
            <span>Puedes <strong>agregar o eliminar</strong> campos según tus necesidades</span>
          </div>
        </div>
      </div>
    </div>

    <form [formGroup]="configForm" class="space-y-6">

      <!-- ========== MAPEO DE CAMPOS ========== -->
      <div class="card-modern p-6">
        <div class="mb-6 pb-4 border-b-2 border-slate-100">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                  <mat-icon class="text-blue-600 !text-xl">link</mat-icon>
                </div>
                Campos Mapeados
              </h2>
              <p class="text-sm text-slate-500 mt-2 ml-13">
                Mapea los campos del <strong>Cliente</strong> con los del <strong>Estimado</strong>
              </p>
            </div>

            @if (availableTargetFields().length > 0) {
              <button
                mat-raised-button
                color="primary"
                type="button"
                (click)="addMapping()"
                class="!px-5 !py-2">
                <mat-icon>add</mat-icon>
                Agregar Campo
              </button>
            }
          </div>
        </div>

        <!-- ENCABEZADOS DE COLUMNAS -->
        <div class="grid grid-cols-12 gap-4 mb-4">
          <div class="col-span-5">
            <div class="flex items-center gap-2 text-sm font-bold text-slate-700 bg-blue-50 rounded-lg px-4 py-3 border-2 border-blue-200">
              <mat-icon class="!text-lg text-blue-600">person</mat-icon>
              <span>Campo del Cliente (Origen)</span>
            </div>
          </div>
          <div class="col-span-2 flex items-center justify-center">
            <mat-icon class="!text-3xl text-slate-400">arrow_forward</mat-icon>
          </div>
          <div class="col-span-4">
            <div class="flex items-center gap-2 text-sm font-bold text-slate-700 bg-purple-50 rounded-lg px-4 py-3 border-2 border-purple-200">
              <mat-icon class="!text-lg text-purple-600">description</mat-icon>
              <span>Campo del Estimado (Destino)</span>
            </div>
          </div>
          <div class="col-span-1">
            <div class="text-sm font-bold text-slate-700 text-center">Acciones</div>
          </div>
        </div>

        <!-- FILAS DE MAPEO DINÁMICAS -->
        <div class="space-y-4" formArrayName="fieldMappings">
          @for (mappingControl of fieldMappingsArray.controls; track $index; let i = $index) {
            @let targetField = mappingControl.get('targetField')?.value;
            @let targetDef = getTargetFieldDefinition(targetField);

            <div class="grid grid-cols-12 gap-4 items-center bg-white rounded-lg p-4 border-2"
                 [class.border-amber-200]="targetDef?.important"
                 [class.border-slate-200]="!targetDef?.important"
                 class="hover:border-blue-300 transition-all"
                 [formGroupName]="i">

              <!-- Campo Origen (Cliente) - SELECT -->
              <div class="col-span-5">
                <div class="relative">
                  <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-600 !text-lg z-10">folder</mat-icon>
                  <select
                    formControlName="sourceField"
                    required
                    class="w-full pl-11 pr-10 py-3 text-sm border-2 border-blue-200 rounded-lg
                           focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                           transition-all bg-blue-50 text-slate-800 hover:border-blue-400 cursor-pointer
                           appearance-none font-semibold">
                    @for (field of availableFields(); track field.name) {
                      <option [value]="field.name">{{ field.label }}</option>
                    }
                  </select>
                  <mat-icon class="absolute right-3 top-1/2 -translate-y-1/2 text-blue-600 !text-lg pointer-events-none">expand_more</mat-icon>
                </div>
                <p class="text-xs text-blue-600 mt-1.5 font-medium pl-11">
                  Campo: <strong>{{ mappingControl.get('sourceField')?.value }}</strong>
                </p>
              </div>

              <!-- Flecha -->
              <div class="col-span-2 flex items-center justify-center">
                <div class="flex flex-col items-center">
                  <mat-icon class="!text-2xl text-purple-600">arrow_forward</mat-icon>
                  <span class="text-xs text-slate-500 font-semibold mt-1">mapea a</span>
                </div>
              </div>

              <!-- Campo Destino (Estimado) - FIJO/LABEL -->
              <div class="col-span-4">
                <div class="flex items-center gap-3 p-3 bg-purple-50 border-2 border-purple-200 rounded-lg">
                  @if (targetDef) {
                    <mat-icon class="text-purple-600 !text-lg">{{ targetDef.icon }}</mat-icon>
                    <div class="flex-1">
                      <p class="text-sm font-bold text-purple-900">{{ targetDef.label }}</p>
                      <p class="text-xs text-purple-700">Campo fijo del estimado</p>
                    </div>
                    @if (targetDef.important) {
                      <div class="bg-amber-500 text-white text-xs font-bold px-2 py-1 rounded">
                        IMPORTANTE
                      </div>
                    }
                  }
                </div>
              </div>

              <!-- Botón Eliminar -->
              <div class="col-span-1 flex justify-center">
                <button
                  mat-icon-button
                  type="button"
                  color="warn"
                  (click)="removeMapping(i)"
                  matTooltip="Eliminar mapeo"
                  class="!text-red-600 hover:!bg-red-50">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          }

          <!-- Mensaje si no hay mapeos -->
          @if (fieldMappingsArray.length === 0) {
            <div class="text-center py-12 bg-slate-50 rounded-lg border-2 border-dashed border-slate-300">
              <mat-icon class="!text-5xl text-slate-400 mb-3">link_off</mat-icon>
              <p class="text-lg font-semibold text-slate-600 mb-2">No hay campos mapeados</p>
              <p class="text-sm text-slate-500 mb-4">Agrega campos del cliente para mapear al estimado</p>
              <button
                mat-raised-button
                color="primary"
                type="button"
                (click)="addMapping()"
                class="!px-5 !py-2">
                <mat-icon>add</mat-icon>
                Agregar Primer Campo
              </button>
            </div>
          }
        </div>

        <!-- CAMPOS DISPONIBLES PARA AGREGAR -->
        @if (availableTargetFields().length > 0 && fieldMappingsArray.length > 0) {
          <div class="mt-6 pt-4 border-t-2 border-slate-100">
            <p class="text-sm font-semibold text-slate-700 mb-3">Campos disponibles para agregar:</p>
            <div class="flex flex-wrap gap-2">
              @for (targetField of availableTargetFields(); track targetField.value) {
                <button
                  mat-stroked-button
                  type="button"
                  (click)="addMapping(targetField.value)"
                  class="!px-4 !py-2 !border-2 !border-blue-200 hover:!border-blue-400 hover:!bg-blue-50 !text-sm">
                  <mat-icon class="!text-base mr-1">{{ targetField.icon }}</mat-icon>
                  {{ targetField.label }}
                </button>
              }
            </div>
          </div>
        }
      </div>

      <!-- ========== VALORES POR DEFECTO ========== -->
      <div class="card-modern p-6">
        <div class="mb-6 pb-4 border-b-2 border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-purple-600 !text-xl">tune</mat-icon>
            </div>
            Valores Por Defecto
          </h2>
          <p class="text-sm text-slate-500 mt-2 ml-13">
            Define valores predeterminados para nuevos estimados
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">

          <!-- Impuesto por defecto -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Impuesto por Defecto (%)
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">percent</mat-icon>
              <input
                type="number"
                formControlName="defaultTaxPercentage"
                min="0"
                max="100"
                step="0.01"
                class="w-full pl-11 pr-12 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-purple-500 focus:ring-2 focus:ring-purple-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300 font-semibold"
                placeholder="0">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-600 font-bold">%</span>
            </div>
          </div>

          <!-- Días de validez por defecto -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Validez por Defecto (días)
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">event</mat-icon>
              <input
                type="number"
                formControlName="defaultValidityDays"
                min="1"
                step="1"
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-purple-500 focus:ring-2 focus:ring-purple-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300 font-semibold"
                placeholder="30">
            </div>
          </div>

          <!-- Tipo de trabajo por defecto -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Tipo de Trabajo por Defecto
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">business</mat-icon>
              <select
                formControlName="defaultWorkType"
                class="w-full pl-11 pr-10 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-purple-500 focus:ring-2 focus:ring-purple-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300 cursor-pointer
                       appearance-none">
                <option value="residential">Residencial</option>
                <option value="commercial">Comercial</option>
              </select>
              <mat-icon class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg pointer-events-none">expand_more</mat-icon>
            </div>
          </div>

        </div>
      </div>

      <!-- ========== TÉRMINOS Y CONDICIONES POR DEFECTO ========== -->
      <div class="card-modern p-6">
        <div class="mb-6 pb-4 border-b-2 border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-orange-600 !text-xl">description</mat-icon>
            </div>
            Términos y Condiciones por Defecto
          </h2>
          <p class="text-sm text-slate-500 mt-2 ml-13">
            Este texto aparecerá automáticamente en la sección de términos de todos los nuevos estimados
          </p>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-700 mb-2">
            Texto de Términos y Condiciones
          </label>
          <textarea
            formControlName="defaultTerms"
            rows="12"
            class="w-full px-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                   focus:border-orange-500 focus:ring-2 focus:ring-orange-100 outline-none
                   transition-all bg-white text-slate-800 hover:border-slate-300 resize-y
                   font-mono"
            placeholder="Ingresa los términos y condiciones por defecto..."></textarea>
          <p class="text-xs text-slate-500 mt-2">
            Puedes editar este texto para cada estimado individual. Este es solo el valor por defecto.
          </p>
        </div>
      </div>

      <!-- ========== BOTONES DE ACCIÓN ========== -->
      <div class="sticky bottom-0 bg-gradient-to-r from-slate-100 to-slate-200 p-6 rounded-xl shadow-lg border-2 border-slate-300 flex justify-between items-center gap-4">
        <div class="flex gap-3">
          <button
            mat-stroked-button
            type="button"
            (click)="goBack()"
            [disabled]="isSaving()"
            class="!px-6 !py-3 !border-2">
            <mat-icon>close</mat-icon>
            Cancelar
          </button>
          <button
            mat-stroked-button
            type="button"
            color="warn"
            (click)="resetToDefaults()"
            [disabled]="isSaving()"
            matTooltip="Restablecer a sugerencias automáticas"
            class="!px-6 !py-3 !border-2">
            <mat-icon>refresh</mat-icon>
            Restablecer
          </button>
        </div>

        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="saveConfig()"
          [disabled]="isSaving() || configForm.invalid"
          class="!px-8 !py-3 !text-base">
          @if (isSaving()) {
            <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
          } @else {
            <mat-icon>save</mat-icon>
          }
          Guardar Configuración
        </button>
      </div>

    </form>

  </div>
</div>
