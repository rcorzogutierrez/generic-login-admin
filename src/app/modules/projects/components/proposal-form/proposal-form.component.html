<!-- proposal-form.component.html -->

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <div class="max-w-[1400px] mx-auto p-5">

    <!-- ========== HEADER ========== -->
    <header class="page-header">
      <div class="flex items-center justify-between gap-5">
        <div class="flex items-center gap-4">
          <button
            mat-icon-button
            (click)="cancel()"
            class="icon-btn">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div>
            <h1 class="text-2xl font-bold text-slate-800">
              {{ isEditMode() ? 'Editar Estimado' : 'Nuevo Estimado' }}
            </h1>
            <p class="text-sm text-slate-500">Complete la información del estimado</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button
            mat-stroked-button
            (click)="cancel()"
            [disabled]="isLoading()">
            Cancelar
          </button>
          <button
            mat-raised-button
            color="primary"
            (click)="save()"
            [disabled]="isLoading() || proposalForm.invalid">
            <mat-icon>save</mat-icon>
            {{ isEditMode() ? 'Actualizar' : 'Guardar' }}
          </button>
        </div>
      </div>
    </header>

    <form [formGroup]="proposalForm" class="space-y-7">

      <!-- ========== INFORMACIÓN DEL CLIENTE ========== -->
      <div class="card-modern p-6">
        <div class="mb-6 pb-4 border-b-2 border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-blue-600 !text-xl">person</mat-icon>
            </div>
            Información del Cliente
          </h2>
          <p class="text-sm text-slate-500 mt-2 ml-13">Selecciona el cliente y verifica sus datos</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <!-- Cliente Autocomplete -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Cliente <span class="text-red-500">*</span>
            </label>
            <div class="flex gap-2">
              <div class="relative flex-1">
                <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg z-10">search</mat-icon>
                <input
                  type="text"
                  [value]="clientSearchTerm()"
                  (input)="onClientSearchChange($event)"
                  [matAutocomplete]="autoClients"
                  placeholder="Buscar cliente..."
                  class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                         focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                         transition-all bg-white text-slate-800 hover:border-slate-300">

                <mat-autocomplete #autoClients="matAutocomplete" (optionSelected)="selectClient($event.option.value)">
                  @if (filteredClients().length === 0) {
                    <mat-option disabled>
                      <div class="text-slate-400 text-sm py-2">
                        No se encontraron clientes
                      </div>
                    </mat-option>
                  }
                  @for (client of filteredClients(); track client.id) {
                    <mat-option [value]="client">
                      <div class="flex flex-col py-1">
                        <span class="font-semibold text-slate-800">{{ getClientName(client) }}</span>
                        @if (getClientEmail(client) || getClientPhone(client)) {
                          <span class="text-xs text-slate-500">
                            @if (getClientEmail(client)) {
                              <span>{{ getClientEmail(client) }}</span>
                            }
                            @if (getClientEmail(client) && getClientPhone(client)) {
                              <span class="mx-1">•</span>
                            }
                            @if (getClientPhone(client)) {
                              <span>{{ getClientPhone(client) }}</span>
                            }
                          </span>
                        }
                      </div>
                    </mat-option>
                  }
                </mat-autocomplete>

                @if (clients().length === 0) {
                  <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                    <span class="text-xs text-amber-600">Sin clientes</span>
                  </div>
                }
              </div>
              <button
                type="button"
                mat-mini-fab
                color="primary"
                (click)="openAddClientDialog()"
                matTooltip="Agregar nuevo cliente"
                class="!flex-shrink-0">
                <mat-icon>add</mat-icon>
              </button>
            </div>
            @if (proposalForm.get('ownerId')?.invalid && proposalForm.get('ownerId')?.touched) {
              <p class="text-xs text-red-500 mt-1.5">El cliente es requerido</p>
            }
          </div>

          <!-- Nombre del Cliente -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Nombre del Cliente <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">badge</mat-icon>
              <input
                type="text"
                formControlName="ownerName"
                required
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300"
                placeholder="Nombre completo del cliente">
            </div>
            @if (proposalForm.get('ownerName')?.invalid && proposalForm.get('ownerName')?.touched) {
              <p class="text-xs text-red-500 mt-1.5">El nombre es requerido</p>
            }
          </div>

          <!-- Email -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Email</label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">email</mat-icon>
              <input
                type="email"
                formControlName="ownerEmail"
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300"
                placeholder="cliente@ejemplo.com">
            </div>
          </div>

          <!-- Teléfono -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Teléfono</label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">phone</mat-icon>
              <input
                type="tel"
                formControlName="ownerPhone"
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300"
                placeholder="+1 (555) 123-4567">
            </div>
          </div>
        </div>
      </div>

      <!-- ========== CHECKBOX: USAR MISMA DIRECCIÓN ========== -->
      <div class="card-modern p-4 bg-blue-50 border-2 border-blue-200">
        <label class="flex items-center gap-3 cursor-pointer group">
          <input
            type="checkbox"
            [checked]="useSameAddress()"
            (change)="onUseSameAddressChange($any($event.target).checked)"
            [disabled]="!proposalForm.get('ownerId')?.value"
            class="w-5 h-5 text-blue-600 border-2 border-blue-300 rounded
                   focus:ring-2 focus:ring-blue-400 focus:ring-offset-2
                   disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer">
          <div class="flex-1">
            <span class="text-sm font-semibold text-blue-900 group-hover:text-blue-700">
              La dirección del trabajo es la misma que la del cliente
            </span>
            <p class="text-xs text-blue-600 mt-0.5">
              Marque esta opción si el trabajo se realizará en la dirección del cliente
            </p>
          </div>
          <mat-icon class="text-blue-500 !text-xl">home_work</mat-icon>
        </label>
      </div>

      <!-- ========== UBICACIÓN DEL TRABAJO ========== -->
      <div class="card-modern p-6">
        <div class="mb-6 pb-4 border-b-2 border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-green-600 !text-xl">place</mat-icon>
            </div>
            Ubicación del Trabajo
          </h2>
          <p class="text-sm text-slate-500 mt-2 ml-13">Indica dónde se realizará el trabajo (puede ser diferente a la dirección del cliente)</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          <!-- Tipo de Trabajo -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Tipo de Trabajo <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">business</mat-icon>
              <select
                formControlName="workType"
                required
                class="w-full pl-11 pr-10 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300 cursor-pointer
                       appearance-none">
                <option value="residential">Residencial</option>
                <option value="commercial">Comercial</option>
              </select>
              <mat-icon class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg pointer-events-none">expand_more</mat-icon>
            </div>
            @if (proposalForm.get('workType')?.invalid && proposalForm.get('workType')?.touched) {
              <p class="text-xs text-red-500 mt-1.5">El tipo de trabajo es requerido</p>
            }
          </div>

          <!-- Clasificación del Servicio -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Clasificación del Servicio
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">construction</mat-icon>
              <select
                formControlName="jobCategory"
                class="w-full pl-11 pr-10 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-green-500 focus:ring-2 focus:ring-green-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300 cursor-pointer
                       appearance-none">
                <option value="">Seleccione una opción</option>
                <option value="remodeling">Remodelación</option>
                <option value="plumbing">Plomería</option>
                <option value="services">Servicios</option>
                <option value="equipment">Instalación de equipos</option>
                <option value="new_construction">Nueva Construcción</option>
              </select>
              <mat-icon class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg pointer-events-none">expand_more</mat-icon>
            </div>
          </div>

          <!-- Dirección del Trabajo -->
          <div class="md:col-span-2 lg:col-span-3">
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Dirección del Trabajo <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">location_on</mat-icon>
              <input
                type="text"
                formControlName="address"
                required
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300"
                placeholder="123 Main Street">
            </div>
            @if (proposalForm.get('address')?.invalid && proposalForm.get('address')?.touched) {
              <p class="text-xs text-red-500 mt-1.5">La dirección es requerida</p>
            }
          </div>

          <!-- Ciudad -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Ciudad <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">location_city</mat-icon>
              <input
                type="text"
                formControlName="city"
                required
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300"
                placeholder="Miami">
            </div>
            @if (proposalForm.get('city')?.invalid && proposalForm.get('city')?.touched) {
              <p class="text-xs text-red-500 mt-1.5">La ciudad es requerida</p>
            }
          </div>

          <!-- Estado -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Estado</label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">map</mat-icon>
              <input
                type="text"
                formControlName="state"
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300"
                placeholder="FL">
            </div>
          </div>

          <!-- Código Postal -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Código Postal</label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">markunread_mailbox</mat-icon>
              <input
                type="text"
                formControlName="zipCode"
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300"
                placeholder="33101">
            </div>
          </div>
        </div>
      </div>

      <!-- ========== FECHAS ========== -->
      <div class="card-modern p-6">
        <div class="mb-6 pb-4 border-b-2 border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-purple-600 !text-xl">event</mat-icon>
            </div>
            Fechas del Estimado
          </h2>
          <p class="text-sm text-slate-500 mt-2 ml-13">Define la fecha del estimado y su validez</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <!-- Fecha del Estimado -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              Fecha del Estimado <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">calendar_today</mat-icon>
              <input
                type="date"
                formControlName="date"
                required
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300 cursor-pointer">
            </div>
            @if (proposalForm.get('date')?.invalid && proposalForm.get('date')?.touched) {
              <p class="text-xs text-red-500 mt-1.5">La fecha es requerida</p>
            }
          </div>

          <!-- Válido Hasta -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Válido Hasta (Opcional)</label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">event_available</mat-icon>
              <input
                type="date"
                formControlName="validUntil"
                class="w-full pl-11 pr-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                       focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                       transition-all bg-white text-slate-800 hover:border-slate-300 cursor-pointer">
            </div>
          </div>
        </div>
      </div>

      <!-- ========== ITEMS INCLUIDOS ========== -->
      <div class="card-modern p-6">
        <div class="mb-6 pb-4 border-b-2 border-slate-100 flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
              <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <mat-icon class="text-blue-600 !text-xl">checklist</mat-icon>
              </div>
              Items Incluidos en el Estimado
            </h2>
            <p class="text-sm text-slate-500 mt-2 ml-13">Trabajos y materiales que están incluidos en el precio</p>
          </div>
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="addIncludeItem()"
            class="!px-6 !py-2.5">
            <mat-icon>add_circle</mat-icon>
            Agregar Item
          </button>
        </div>

        @if (includeItems().length === 0) {
          <div class="text-center py-12 text-slate-400 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200">
            <mat-icon class="!text-6xl mb-3 text-slate-300">inventory_2</mat-icon>
            <p class="text-base font-medium">No hay items incluidos</p>
            <p class="text-sm mt-1">Haz clic en "Agregar Item" para comenzar a construir el estimado</p>
          </div>
        } @else {
          <div class="items-container">
            @for (item of includeItems(); track item.id; let i = $index) {
              <div class="item-card shadow-sm">
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-lg font-bold text-sm flex-shrink-0">
                    {{ i + 1 }}
                  </div>

                  <div class="flex-1 grid grid-cols-1 md:grid-cols-6 gap-4">
                    <!-- Descripción -->
                    <div class="md:col-span-3">
                      <label class="block text-xs font-semibold text-slate-600 mb-1.5">Descripción</label>
                      <input
                        type="text"
                        [value]="item.description"
                        (input)="updateIncludeItem(item.id, 'description', $any($event.target).value)"
                        class="w-full px-3 py-2.5 text-sm border-2 border-slate-200 rounded-lg
                               focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                               transition-all bg-white text-slate-800 hover:border-slate-300"
                        placeholder="Descripción del item...">
                    </div>

                    <!-- Cantidad -->
                    <div>
                      <label class="block text-xs font-semibold text-slate-600 mb-1.5">Cantidad</label>
                      <input
                        type="number"
                        min="0"
                        step="0.01"
                        [value]="item.quantity || 0"
                        (input)="updateIncludeItem(item.id, 'quantity', +$any($event.target).value)"
                        class="w-full px-3 py-2.5 text-sm border-2 border-slate-200 rounded-lg
                               focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                               transition-all bg-white text-slate-800 hover:border-slate-300"
                        placeholder="0">
                    </div>

                    <!-- Precio Unitario -->
                    <div>
                      <label class="block text-xs font-semibold text-slate-600 mb-1.5">Precio Unit.</label>
                      <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm font-medium">$</span>
                        <input
                          type="number"
                          min="0"
                          step="0.01"
                          [value]="item.unitPrice || 0"
                          (input)="updateIncludeItem(item.id, 'unitPrice', +$any($event.target).value)"
                          class="w-full pl-7 pr-3 py-2.5 text-sm border-2 border-slate-200 rounded-lg
                                 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                                 transition-all bg-white text-slate-800 hover:border-slate-300"
                          placeholder="0.00">
                      </div>
                    </div>

                    <!-- Total -->
                    <div>
                      <label class="block text-xs font-semibold text-slate-600 mb-1.5">Total</label>
                      <input
                        type="text"
                        [value]="formatCurrency(item.totalPrice || 0)"
                        readonly
                        class="w-full px-3 py-2.5 text-sm border-2 border-green-200 rounded-lg
                               bg-green-50 text-green-800 font-semibold cursor-not-allowed">
                    </div>
                  </div>

                  <button
                    mat-icon-button
                    color="warn"
                    type="button"
                    (click)="removeIncludeItem(item.id)"
                    matTooltip="Eliminar item"
                    class="flex-shrink-0">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- ========== EXTRAS NO INCLUIDOS ========== -->
      <div class="card-modern p-6 border-2 border-amber-100">
        <div class="mb-6 pb-4 border-b-2 border-amber-100 flex items-center justify-between">
          <div>
            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
              <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                <mat-icon class="text-amber-700 !text-xl">do_not_disturb_on</mat-icon>
              </div>
              Extras NO Incluidos en el Precio
            </h2>
            <p class="text-sm text-slate-500 mt-2 ml-13">Trabajos o costos adicionales que NO están cubiertos en este estimado</p>
          </div>
          <button
            mat-raised-button
            color="accent"
            type="button"
            (click)="addExtraItem()"
            class="!px-6 !py-2.5 !bg-amber-500 hover:!bg-amber-600">
            <mat-icon>add_circle_outline</mat-icon>
            Agregar Extra
          </button>
        </div>

        @if (extraItems().length === 0) {
          <div class="text-center py-12 text-amber-600 bg-amber-50/50 rounded-xl border-2 border-dashed border-amber-200">
            <mat-icon class="!text-6xl mb-3 text-amber-300">block</mat-icon>
            <p class="text-base font-medium">No hay extras definidos</p>
            <p class="text-sm mt-1">Los extras son items que el cliente debe cubrir por separado</p>
          </div>
        } @else {
          <div class="items-container">
            @for (item of extraItems(); track item.id; let i = $index) {
              <div class="extra-item-card shadow-sm">
                <div class="flex items-start gap-4">
                  <div class="flex items-center justify-center w-8 h-8 bg-amber-600 text-white rounded-lg font-bold text-sm flex-shrink-0">
                    {{ i + 1 }}
                  </div>

                  <div class="flex-1">
                    <label class="block text-xs font-semibold text-amber-800 mb-1.5">Descripción del Extra</label>
                    <div class="relative">
                      <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-amber-500 !text-lg">info</mat-icon>
                      <input
                        type="text"
                        [value]="item.description"
                        (input)="updateExtraItem(item.id, 'description', $any($event.target).value)"
                        class="w-full pl-11 pr-4 py-2.5 text-sm border-2 border-amber-300 rounded-lg
                               focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none
                               transition-all bg-white text-amber-900 hover:border-amber-400"
                        placeholder="Ej: Permisos y certificaciones (a cargo del cliente)">
                    </div>
                  </div>

                  <button
                    mat-icon-button
                    color="warn"
                    type="button"
                    (click)="removeExtraItem(item.id)"
                    class="item-delete-btn flex-shrink-0"
                    matTooltip="Eliminar extra">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <!-- ========== TOTALES ========== -->
      <div class="card-modern p-6 bg-gradient-to-br from-blue-50 via-blue-100 to-indigo-100 border-2 border-blue-300 shadow-lg">
        <div class="mb-6 pb-4 border-b-2 border-blue-200">
          <h2 class="text-xl font-bold text-blue-900 flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
              <mat-icon class="text-white !text-xl">calculate</mat-icon>
            </div>
            Resumen de Totales
          </h2>
          <p class="text-sm text-blue-700 mt-2 ml-13">Configura impuestos y descuentos</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
          <!-- Impuesto -->
          <div>
            <label class="block text-sm font-semibold text-blue-900 mb-2">Impuesto (%)</label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-600 !text-lg">percent</mat-icon>
              <input
                type="number"
                formControlName="taxPercentage"
                min="0"
                max="100"
                step="0.01"
                class="w-full pl-11 pr-12 py-3 text-sm border-2 border-blue-300 rounded-lg
                       focus:border-blue-600 focus:ring-2 focus:ring-blue-200 outline-none
                       transition-all bg-white text-blue-900 hover:border-blue-400 font-semibold"
                placeholder="0">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-blue-600 font-bold">%</span>
            </div>
          </div>

          <!-- Descuento -->
          <div>
            <label class="block text-sm font-semibold text-blue-900 mb-2">Descuento (%)</label>
            <div class="relative">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-600 !text-lg">local_offer</mat-icon>
              <input
                type="number"
                formControlName="discountPercentage"
                min="0"
                max="100"
                step="0.01"
                class="w-full pl-11 pr-12 py-3 text-sm border-2 border-blue-300 rounded-lg
                       focus:border-blue-600 focus:ring-2 focus:ring-blue-200 outline-none
                       transition-all bg-white text-blue-900 hover:border-blue-400 font-semibold"
                placeholder="0">
              <span class="absolute right-4 top-1/2 -translate-y-1/2 text-blue-600 font-bold">%</span>
            </div>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-slate-600">Subtotal:</span>
            <span class="font-semibold">{{ formatCurrency(calculateSubtotal()) }}</span>
          </div>

          @if (proposalForm.get('taxPercentage')?.value > 0) {
            <div class="flex justify-between text-sm">
              <span class="text-slate-600">Impuesto ({{ proposalForm.get('taxPercentage')?.value }}%):</span>
              <span class="font-semibold text-green-600">
                + {{ formatCurrency((calculateSubtotal() * (proposalForm.get('taxPercentage')?.value || 0)) / 100) }}
              </span>
            </div>
          }

          @if (proposalForm.get('discountPercentage')?.value > 0) {
            <div class="flex justify-between text-sm">
              <span class="text-slate-600">Descuento ({{ proposalForm.get('discountPercentage')?.value }}%):</span>
              <span class="font-semibold text-red-600">
                - {{ formatCurrency((calculateSubtotal() * (proposalForm.get('discountPercentage')?.value || 0)) / 100) }}
              </span>
            </div>
          }

          <mat-divider class="my-2"></mat-divider>

          <div class="flex justify-between text-lg font-bold">
            <span class="text-blue-900">TOTAL:</span>
            <span class="text-blue-600">{{ formatCurrency(calculateTotal()) }}</span>
          </div>
        </div>
      </div>

      <!-- ========== NOTAS Y TÉRMINOS ========== -->
      <div class="card-modern p-6">
        <div class="mb-6 pb-4 border-b-2 border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 flex items-center gap-3">
            <div class="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center">
              <mat-icon class="text-slate-600 !text-xl">notes</mat-icon>
            </div>
            Notas y Términos
          </h2>
          <p class="text-sm text-slate-500 mt-2 ml-13">Información adicional y condiciones del servicio</p>
        </div>

        <div class="space-y-5">
          <!-- Notas Visibles -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <mat-icon class="!text-lg text-slate-600">visibility</mat-icon>
              Notas (visibles para el cliente)
            </label>
            <textarea
              formControlName="notes"
              rows="4"
              class="w-full px-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                     focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                     transition-all bg-white text-slate-800 hover:border-slate-300
                     resize-vertical min-h-[100px]"
              placeholder="Información adicional que verá el cliente en el estimado..."></textarea>
          </div>

          <!-- Notas Internas -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <mat-icon class="!text-lg text-slate-600">visibility_off</mat-icon>
              Notas Internas (solo uso interno)
            </label>
            <textarea
              formControlName="internalNotes"
              rows="3"
              class="w-full px-4 py-3 text-sm border-2 border-purple-200 rounded-lg
                     focus:border-purple-500 focus:ring-2 focus:ring-purple-100 outline-none
                     transition-all bg-purple-50/30 text-slate-800 hover:border-purple-300
                     resize-vertical min-h-[80px]"
              placeholder="Notas privadas que solo tú y tu equipo pueden ver..."></textarea>
          </div>

          <!-- Términos y Condiciones -->
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
              <mat-icon class="!text-lg text-slate-600">gavel</mat-icon>
              Términos y Condiciones
            </label>
            <textarea
              formControlName="terms"
              rows="5"
              class="w-full px-4 py-3 text-sm border-2 border-slate-200 rounded-lg
                     focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none
                     transition-all bg-white text-slate-800 hover:border-slate-300
                     resize-vertical min-h-[120px]"
              placeholder="Condiciones de pago, garantías, plazos de entrega, etc..."></textarea>
          </div>
        </div>
      </div>

      <!-- ========== BOTONES FINALES ========== -->
      <div class="sticky bottom-0 bg-gradient-to-r from-slate-100 to-slate-200 p-6 rounded-xl shadow-lg border-2 border-slate-300 flex justify-between items-center gap-4">
        <div class="text-sm text-slate-600">
          @if (proposalForm.invalid) {
            <div class="flex items-center gap-2 text-amber-600">
              <mat-icon class="!text-base">warning</mat-icon>
              <span class="font-medium">Completa todos los campos requeridos para guardar</span>
            </div>
          } @else {
            <div class="flex items-center gap-2 text-green-600">
              <mat-icon class="!text-base">check_circle</mat-icon>
              <span class="font-medium">Formulario completo - Listo para guardar</span>
            </div>
          }
        </div>

        <div class="flex gap-3">
          <button
            mat-stroked-button
            type="button"
            (click)="cancel()"
            [disabled]="isLoading()"
            class="!px-6 !py-3 !border-2">
            <mat-icon>close</mat-icon>
            Cancelar
          </button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="save()"
            [disabled]="isLoading() || proposalForm.invalid"
            class="!px-8 !py-3 !text-base">
            @if (isLoading()) {
              <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
            } @else {
              <mat-icon>save</mat-icon>
            }
            {{ isEditMode() ? 'Actualizar Estimado' : 'Guardar Estimado' }}
          </button>
        </div>
      </div>

    </form>

  </div>
</div>
