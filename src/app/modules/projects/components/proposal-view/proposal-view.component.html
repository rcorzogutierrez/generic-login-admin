<!-- proposal-view.component.html - DISEÑO COMPACTO BLUE -->

<div class="view-container">

  @if (isLoading()) {
    <!-- Loading State -->
    <div class="loading-state">
      <div class="spinner blue"></div>
      <p>{{ 'projects.proposal.view.loading' | translate }}</p>
    </div>
  } @else if (proposal()) {

    <!-- ========== HEADER COMPACTO ========== -->
    <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-5 animate-fadeIn print:hidden">
      <div class="flex items-center justify-between gap-4 flex-wrap">

        <!-- Left: Back + Icon + Title -->
        <div class="flex items-center gap-3">
          <button type="button" class="back-btn" (click)="back()" title="Volver">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <div class="header-icon-box" [class.blue]="proposal()!.status !== 'converted_to_invoice'" [class.green]="proposal()!.status === 'converted_to_invoice'">
            <mat-icon>{{ proposal()!.status === 'converted_to_invoice' ? 'receipt_long' : 'description' }}</mat-icon>
          </div>
          <div>
            <h1 class="text-lg font-bold text-slate-800">
              @if (proposal()!.status === 'converted_to_invoice') {
                {{ 'projects.proposal.view.invoice' | translate }} {{ proposal()!.proposalNumber }}
              } @else {
                {{ 'projects.proposal.view.estimate' | translate }} {{ proposal()!.proposalNumber }}
              }
            </h1>
            <p class="text-xs text-slate-500">
              @if (proposal()!.status === 'converted_to_invoice') {
                {{ 'projects.proposal.view.detailedViewInvoice' | translate }}
              } @else {
                {{ 'projects.proposal.view.detailedView' | translate }}
              }
            </p>
          </div>
        </div>

        <!-- Right: Actions -->
        <div class="flex items-center gap-2 flex-wrap">
          <!-- Toggle para mostrar detalles del estimado (solo en facturas) -->
          @if (proposal()!.status === 'converted_to_invoice') {
            <label class="details-toggle" [class.active]="showProposalDetails()">
              <input type="checkbox" [checked]="showProposalDetails()" (change)="toggleProposalDetails()">
              <mat-icon>{{ showProposalDetails() ? 'visibility' : 'visibility_off' }}</mat-icon>
              <span>{{ 'projects.proposal.view.estimateDetails' | translate }}</span>
            </label>
          }

          <button type="button" class="icon-btn" (click)="print()" title="{{ 'projects.proposal.view.print' | translate }}">
            <mat-icon>print</mat-icon>
          </button>

          @if (proposal()!.status !== 'converted_to_invoice') {
            <button type="button" class="btn-primary" (click)="editProposal()">
              <mat-icon>edit</mat-icon>
              <span>{{ 'projects.proposal.view.editEstimate' | translate }}</span>
            </button>
          }

          <button type="button" class="icon-btn" [matMenuTriggerFor]="menu" title="{{ 'projects.proposal.view.moreOptions' | translate }}">
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #menu="matMenu">
            @if (proposal()!.status === 'draft') {
              <button mat-menu-item (click)="changeStatus('sent')">
                <mat-icon>send</mat-icon>
                <span>{{ 'projects.proposal.view.markAsSent' | translate }}</span>
              </button>
            }

            @if (proposal()!.status === 'sent') {
              <button mat-menu-item (click)="changeStatus('approved')">
                <mat-icon class="text-green-600">check_circle</mat-icon>
                <span>{{ 'projects.proposal.view.markAsApproved' | translate }}</span>
              </button>
              <button mat-menu-item (click)="changeStatus('rejected')">
                <mat-icon class="text-red-600">cancel</mat-icon>
                <span>{{ 'projects.proposal.view.markAsRejected' | translate }}</span>
              </button>
            }

            @if (proposal()!.status === 'approved') {
              <button mat-menu-item (click)="convertToInvoice()">
                <mat-icon class="text-blue-600">receipt</mat-icon>
                <span>{{ 'projects.proposal.view.convertToInvoice' | translate }}</span>
              </button>
            }

            <mat-divider></mat-divider>

            <button mat-menu-item (click)="deleteProposal()" class="text-red-600">
              <mat-icon class="text-red-600">delete</mat-icon>
              <span>{{ 'projects.proposal.view.delete' | translate }}</span>
            </button>
          </mat-menu>
        </div>

      </div>
    </header>

    <!-- ========== DOCUMENTO DEL ESTIMADO ========== -->
    <div class="document-card animate-fadeIn" style="animation-delay: 0.05s">

      <!-- Encabezado del documento -->
      <div class="document-header">
        <div class="grid grid-cols-12 gap-4">

          <!-- Columna Izquierda: Info del Cliente -->
          <div class="col-span-4 space-y-1.5">
            <p class="doc-info-row">
              <span class="doc-label">{{ 'projects.proposal.view.for' | translate }}</span>
              <span class="doc-value font-bold">{{ proposal()!.ownerName }}</span>
            </p>
            <p class="doc-info-row">
              <span class="doc-label">{{ 'projects.proposal.location.address' | translate }}</span>
              <span class="doc-value">{{ proposal()!.address }}, {{ proposal()!.city }}@if (proposal()!.state) {, {{ proposal()!.state }}}@if (proposal()!.zipCode) { {{ proposal()!.zipCode }}}</span>
            </p>
            <p class="doc-info-row">
              <span class="doc-label">
                @if (proposal()!.status === 'converted_to_invoice') {
                  {{ 'projects.proposal.view.invoiceDate' | translate }}
                } @else {
                  {{ 'projects.proposal.view.date' | translate }}
                }
              </span>
              <span class="doc-value font-semibold">
                @if (proposal()!.status === 'converted_to_invoice') {
                  {{ proposal()!.invoiceDate ? formatDate(proposal()!.invoiceDate) : formatDate(proposal()!.date) }}
                } @else {
                  {{ formatDate(proposal()!.date) }}
                }
              </span>
            </p>
          </div>

          <!-- Columna Central: Número -->
          <div class="col-span-3 flex items-start justify-center">
            <div class="document-number-box">
              @if (proposal()!.status === 'converted_to_invoice') {
                <span class="doc-type-label">{{ 'projects.proposal.view.invoice' | translate }}</span>
              } @else {
                <span class="doc-type-label">{{ 'projects.proposal.view.estimate' | translate }}</span>
              }
              <span class="doc-number">{{ proposal()!.proposalNumber }}</span>
            </div>
          </div>

          <!-- Columna Derecha: Logo e Info de Empresa -->
          <div class="col-span-5 text-right">
            @if (businessInfo()?.logoUrl) {
              <img [src]="businessInfo()!.logoUrl"
                   [alt]="businessInfo()!.businessName || 'Logo'"
                   class="company-logo">
            }
            @if (businessInfo()) {
              <div class="company-info">
                @if (businessInfo()!.businessName) {
                  <p class="company-name">{{ businessInfo()!.businessName }}</p>
                }
                @if (businessInfo()!.emails && businessInfo()!.emails.length > 0) {
                  <p>{{ businessInfo()!.emails[0].value }}</p>
                }
                @if (businessInfo()!.phones && businessInfo()!.phones!.length > 0) {
                  <p>{{ businessInfo()!.phones![0].value }}</p>
                }
                @if (businessInfo()!.address) {
                  @if (businessInfo()!.address!.street) {
                    <p>{{ businessInfo()!.address!.street }}</p>
                  }
                  @if (businessInfo()!.address!.city || businessInfo()!.address!.state) {
                    <p>
                      {{ businessInfo()!.address!.city }}{{ businessInfo()!.address!.state ? ', ' + businessInfo()!.address!.state : '' }}
                      {{ businessInfo()!.address!.zipCode }}
                    </p>
                  }
                }
              </div>
            }
            <span [class]="'status-badge ' + getStatusClass(proposal()!.status)" class="print:hidden mt-2 inline-block">
              {{ getStatusLabel(proposal()!.status) }}
            </span>
          </div>

        </div>
      </div>

      <!-- ========== DETALLES DEL ESTIMADO ORIGINAL ========== -->
      @if (proposal()!.status !== 'converted_to_invoice' || showProposalDetails()) {

        <!-- Items Incluidos -->
        @if (proposal()!.includes && proposal()!.includes.length > 0) {
          <div class="doc-section">
            <h3 class="section-title blue">
              <mat-icon>checklist</mat-icon>
              {{ 'projects.proposal.view.includes' | translate }}
            </h3>

            <div class="items-list">
              @for (item of proposal()!.includes; track item.id; let i = $index) {
                <div class="item-row">
                  <span class="item-number">{{ i + 1 }}.</span>
                  <div class="item-content">
                    <p class="item-desc">{{ item.description }}</p>
                    @if (item.notes) {
                      <p class="item-notes">{{ item.notes }}</p>
                    }
                  </div>
                  @if (item.totalPrice && item.totalPrice > 0) {
                    <div class="item-price">
                      <p class="price-main">{{ item.totalPrice | currencyFormatter }}</p>
                      @if (item.quantity && item.unitPrice) {
                        <p class="price-detail">{{ item.quantity }} x {{ item.unitPrice | currencyFormatter }}</p>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

        <!-- Extras No Incluidos -->
        @if (proposal()!.extras && proposal()!.extras.length > 0) {
          <div class="doc-section">
            <h3 class="section-title amber">
              <mat-icon>do_not_disturb_on</mat-icon>
              {{ 'projects.proposal.view.extrasNotIncluded' | translate }}
            </h3>

            <div class="extras-list">
              @for (item of proposal()!.extras; track item.id; let i = $index) {
                <div class="extra-row">
                  <span class="extra-number">{{ i + 1 }}.</span>
                  <p class="extra-desc">{{ item.description }}</p>
                </div>
              }
            </div>
          </div>
        }

        <!-- Notas -->
        @if (proposal()!.notes) {
          <div class="notes-box">
            <h3>{{ 'projects.proposal.notes.title' | translate }}</h3>
            <p>{{ proposal()!.notes }}</p>
          </div>
        }

        <!-- Términos y Condiciones -->
        @if (proposal()!.terms) {
          <div class="terms-box">
            <h3>{{ 'projects.proposal.terms.title' | translate }}</h3>
            <p>{{ proposal()!.terms }}</p>
          </div>
        }

      }

      <!-- ========== SECCIÓN DE FACTURA ========== -->
      @if (proposal()!.status === 'converted_to_invoice') {
        <div class="invoice-section">
          <div class="invoice-header">
            <h2>
              <mat-icon>receipt_long</mat-icon>
              {{ 'projects.proposal.view.invoiceInfo' | translate }}
            </h2>
            <button type="button" class="btn-edit print:hidden" (click)="editInvoiceData()">
              <mat-icon>edit</mat-icon>
              {{ 'projects.proposal.view.editData' | translate }}
            </button>
          </div>

          <!-- Info Grid -->
          <div class="invoice-info-grid">
            <div class="info-card">
              <span class="info-label">{{ 'projects.proposal.view.startDate' | translate }}</span>
              <span class="info-value">{{ proposal()!.workStartDate ? formatDate(proposal()!.workStartDate) : '-' }}</span>
            </div>
            <div class="info-card">
              <span class="info-label">{{ 'projects.proposal.view.endDate' | translate }}</span>
              <span class="info-value">{{ proposal()!.workEndDate ? formatDate(proposal()!.workEndDate) : '-' }}</span>
            </div>
            <div class="info-card">
              <span class="info-label">{{ 'projects.proposal.view.workTime' | translate }}</span>
              <span class="info-value">{{ proposal()!.workTime ? proposal()!.workTime + ' ' + ('projects.proposal.view.hours' | translate) : '-' }}</span>
            </div>
            <div class="info-card">
              <span class="info-label">{{ 'projects.proposal.view.workers' | translate }}</span>
              <span class="info-value">{{ proposal()!.workers?.length ?? 0 }}</span>
            </div>
          </div>

          <!-- Trabajadores -->
          @if ((proposal()!.workers?.length ?? 0) > 0) {
            <div class="workers-section">
              <span class="workers-label">{{ 'projects.proposal.view.workersParticipated' | translate }}</span>
              <div class="workers-list">
                @for (worker of proposal()!.workers; track worker.id) {
                  <span class="worker-badge">
                    {{ worker.name }}@if (worker.role) { <span class="worker-role">({{ worker.role }})</span>}
                  </span>
                }
              </div>
            </div>
          }

          <!-- Materiales -->
          @if ((proposal()!.materialsUsed?.length ?? 0) > 0) {
            <div class="materials-section">
              <span class="materials-label">{{ 'projects.proposal.view.materialsUsed' | translate }}</span>
              <table class="materials-table">
                <thead>
                  <tr>
                    <th class="text-left">Material</th>
                    <th class="text-center">Cant.</th>
                    <th class="text-right">Precio</th>
                  </tr>
                </thead>
                <tbody>
                  @for (material of proposal()!.materialsUsed; track material.id) {
                    <tr>
                      <td>{{ material.material }}</td>
                      <td class="text-center">{{ material.amount }}</td>
                      <td class="text-right font-semibold">{{ material.price | currencyFormatter }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      }

      <!-- ========== SECCIÓN DE TOTALES ========== -->
      <div class="totals-section">
        <div class="totals-content">

          @if (!proposal()!.materialsUsed || (proposal()!.materialsUsed?.length ?? 0) === 0) {
            <!-- Sin materiales -->
            <div class="total-row">
              <span>{{ 'projects.proposal.view.subtotal' | translate }}</span>
              <span class="value">{{ (proposal()!.subtotal || 0) | currencyFormatter }}</span>
            </div>

            @if ((proposal()!.taxPercentage ?? 0) > 0) {
              <div class="total-row">
                <span>{{ 'projects.proposal.view.tax' | translate }} ({{ proposal()!.taxPercentage }}%):</span>
                <span class="value">+ {{ (proposal()!.tax || 0) | currencyFormatter }}</span>
              </div>
            }

            @if ((proposal()!.discountPercentage ?? 0) > 0) {
              <div class="total-row">
                <span>{{ 'projects.proposal.view.discount' | translate }} ({{ proposal()!.discountPercentage }}%):</span>
                <span class="value negative">- {{ (proposal()!.discount || 0) | currencyFormatter }}</span>
              </div>
            }

            <div class="total-divider"></div>

            <div class="grand-total blue">
              <span>{{ 'projects.proposal.view.total' | translate }}</span>
              <span class="amount">{{ proposal()!.total | currencyFormatter }}</span>
            </div>

          } @else {
            <!-- Con materiales -->
            <div class="total-row">
              <span>{{ 'projects.proposal.view.workSubtotal' | translate }}</span>
              <span class="value">{{ (proposal()!.subtotal || 0) | currencyFormatter }}</span>
            </div>

            <div class="total-row">
              <span>{{ 'projects.proposal.view.materialsSubtotal' | translate }}</span>
              <span class="value amber">{{ calculateMaterialsTotal() | currencyFormatter }}</span>
            </div>

            <div class="total-divider"></div>

            <div class="total-row bold">
              <span>{{ 'projects.proposal.view.combinedSubtotal' | translate }}</span>
              <span class="value">{{ calculateCombinedSubtotal() | currencyFormatter }}</span>
            </div>

            @if ((proposal()!.taxPercentage ?? 0) > 0) {
              <div class="total-row">
                <span>{{ 'projects.proposal.view.tax' | translate }} ({{ proposal()!.taxPercentage }}%):</span>
                <span class="value">+ {{ calculateTaxAmount() | currencyFormatter }}</span>
              </div>
            }

            @if ((proposal()!.discountPercentage ?? 0) > 0) {
              <div class="total-row">
                <span>{{ 'projects.proposal.view.discount' | translate }} ({{ proposal()!.discountPercentage }}%):</span>
                <span class="value negative">- {{ calculateDiscountAmount() | currencyFormatter }}</span>
              </div>
            }

            <div class="total-divider"></div>

            <div class="grand-total green">
              <span>{{ 'projects.proposal.view.grandTotal' | translate }}</span>
              <span class="amount">{{ calculateGrandTotal() | currencyFormatter }}</span>
            </div>
          }

        </div>
      </div>

    </div>

  }

</div>
