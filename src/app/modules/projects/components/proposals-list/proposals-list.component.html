<!-- proposals-list.component.html - DISEÑO COMPACTO -->

<div class="proposals-container">

  <!-- ========== HEADER COMPACTO ========== -->
  <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-5 animate-fadeIn">
    <div class="flex items-center justify-between gap-4 flex-wrap">

      <!-- Left: Icon + Title + Stats -->
      <div class="flex items-center gap-4">
        <div class="header-icon-box blue">
          <mat-icon>description</mat-icon>
        </div>
        <div>
          <h1 class="text-lg font-bold text-slate-800">Gestión de Estimados</h1>
          <p class="text-xs text-slate-500">Control y seguimiento de propuestas</p>
        </div>

        <!-- Stats inline -->
        <div class="flex items-center gap-2 ml-2">
          <div class="stat-chip slate">
            <span class="stat-value">{{ stats().total }}</span>
            <span class="stat-label">Total</span>
          </div>
          <div class="stat-chip amber">
            <span class="stat-value">{{ stats().byStatus.sent }}</span>
            <span class="stat-label">Enviados</span>
          </div>
          <div class="stat-chip green">
            <span class="stat-value">{{ stats().byStatus.approved }}</span>
            <span class="stat-label">Aprobados</span>
          </div>
          <div class="stat-chip purple">
            <span class="stat-value">{{ stats().byStatus.converted_to_invoice }}</span>
            <span class="stat-label">Facturados</span>
          </div>
        </div>
      </div>

      <!-- Right: Actions -->
      <div class="flex items-center gap-2">
        <button type="button"
                class="icon-btn"
                (click)="openConfig()"
                [disabled]="isLoading()"
                title="Configuración">
          <mat-icon>settings</mat-icon>
        </button>

        <button type="button"
                class="icon-btn"
                (click)="refresh()"
                [disabled]="isLoading()"
                title="Actualizar">
          <mat-icon>refresh</mat-icon>
        </button>

        <button type="button"
                class="btn-primary"
                (click)="createProposal()"
                [disabled]="isLoading()">
          <mat-icon>add</mat-icon>
          <span>Nuevo Estimado</span>
        </button>
      </div>

    </div>
  </header>

  <!-- ========== STATS CARDS (clickeable para filtrar) ========== -->
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-9 gap-3 mb-4 animate-fadeIn" style="animation-delay: 0.05s">

    <!-- Total -->
    <div class="stat-card blue"
         [class.active]="statusFilter() === 'all'"
         (click)="filterByStatus('all')">
      <mat-icon>description</mat-icon>
      <span class="stat-card-value">{{ stats().total }}</span>
      <span class="stat-card-label">Total</span>
    </div>

    <!-- Borradores -->
    <div class="stat-card slate"
         [class.active]="statusFilter() === 'draft'"
         (click)="filterByStatus('draft')">
      <mat-icon>edit</mat-icon>
      <span class="stat-card-value">{{ stats().byStatus.draft }}</span>
      <span class="stat-card-label">Borradores</span>
    </div>

    <!-- Enviados -->
    <div class="stat-card amber"
         [class.active]="statusFilter() === 'sent'"
         (click)="filterByStatus('sent')">
      <mat-icon>send</mat-icon>
      <span class="stat-card-value">{{ stats().byStatus.sent }}</span>
      <span class="stat-card-label">Enviados</span>
    </div>

    <!-- Aprobados -->
    <div class="stat-card green"
         [class.active]="statusFilter() === 'approved'"
         (click)="filterByStatus('approved')">
      <mat-icon>check_circle</mat-icon>
      <span class="stat-card-value">{{ stats().byStatus.approved }}</span>
      <span class="stat-card-label">Aprobados</span>
    </div>

    <!-- Facturados -->
    <div class="stat-card purple"
         [class.active]="statusFilter() === 'converted_to_invoice'"
         (click)="filterByStatus('converted_to_invoice')">
      <mat-icon>receipt_long</mat-icon>
      <span class="stat-card-value">{{ stats().byStatus.converted_to_invoice }}</span>
      <span class="stat-card-label">Facturados</span>
    </div>

    <!-- Pagados -->
    <div class="stat-card emerald"
         [class.active]="statusFilter() === 'paid'"
         (click)="filterByStatus('paid')">
      <mat-icon>payments</mat-icon>
      <span class="stat-card-value">{{ stats().byStatus.paid }}</span>
      <span class="stat-card-label">Pagados</span>
    </div>

    <!-- Rechazados -->
    <div class="stat-card red"
         [class.active]="statusFilter() === 'rejected'"
         (click)="filterByStatus('rejected')">
      <mat-icon>cancel</mat-icon>
      <span class="stat-card-value">{{ stats().byStatus.rejected }}</span>
      <span class="stat-card-label">Rechazados</span>
    </div>

    <!-- Cancelados -->
    <div class="stat-card orange"
         [class.active]="statusFilter() === 'cancelled'"
         (click)="filterByStatus('cancelled')">
      <mat-icon>block</mat-icon>
      <span class="stat-card-value">{{ stats().byStatus.cancelled }}</span>
      <span class="stat-card-label">Cancelados</span>
    </div>

    <!-- Valor Total -->
    <div class="stat-card blue-outline">
      <mat-icon>attach_money</mat-icon>
      <span class="stat-card-value text-sm">{{ formatCurrency(filteredStats().totalValue) }}</span>
      <span class="stat-card-label">Valor Total</span>
    </div>

  </div>

  <!-- ========== FILTROS Y BÚSQUEDA ========== -->
  <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-3 mb-4 animate-fadeIn" style="animation-delay: 0.1s">
    <div class="flex flex-col md:flex-row items-start md:items-center gap-3">
      <!-- Búsqueda -->
      <div class="flex items-center gap-3 flex-1 w-full md:w-auto">
        <mat-icon class="text-slate-400 text-lg">search</mat-icon>
        <input
          type="text"
          placeholder="Buscar por número, cliente, dirección..."
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearch($event)"
          class="search-input">

        @if (searchTerm()) {
          <button type="button"
                  class="icon-btn-sm"
                  (click)="onSearch('')"
                  title="Limpiar búsqueda">
            <mat-icon>close</mat-icon>
          </button>
        }
      </div>

      <!-- Filtro activo -->
      @if (statusFilter() !== 'all') {
        <div class="status-filter-chip">
          <mat-icon>filter_list</mat-icon>
          <span>{{ getStatusLabel(statusFilter()) }}</span>
          <button type="button"
                  class="chip-close-btn"
                  (click)="filterByStatus('all')"
                  title="Quitar filtro">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      }
    </div>
  </div>

  <!-- ========== TABLA DE PROPOSALS ========== -->
  <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden animate-fadeIn" style="animation-delay: 0.15s">

    @if (isLoading()) {
      <!-- Loading State -->
      <div class="loading-state">
        <div class="spinner blue"></div>
        <p>Cargando estimados...</p>
      </div>
    } @else if (filteredProposals().length === 0) {
      <!-- Empty State -->
      <div class="empty-state">
        <mat-icon>description</mat-icon>
        <h3>{{ searchTerm() ? 'No se encontraron estimados' : 'No hay estimados' }}</h3>
        <p>{{ searchTerm() ? 'Intenta con otra búsqueda' : 'Comienza creando tu primer estimado' }}</p>
        @if (!searchTerm()) {
          <button type="button" class="btn-primary" (click)="createProposal()">
            <mat-icon>add</mat-icon>
            <span>Crear Primer Estimado</span>
          </button>
        }
      </div>
    } @else {
      <!-- Tabla -->
      <div class="overflow-x-auto">
        <table class="data-table">
          <thead>
            <tr>
              <th class="sortable" (click)="sortBy('proposalNumber')">
                <span>Número</span>
                @if (currentSort().field === 'proposalNumber') {
                  <mat-icon>{{ currentSort().direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
                }
              </th>
              <th class="sortable" (click)="sortBy('ownerName')">
                <span>Cliente</span>
                @if (currentSort().field === 'ownerName') {
                  <mat-icon>{{ currentSort().direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
                }
              </th>
              <th>Dirección</th>
              <th class="sortable" (click)="sortBy('date')">
                <span>Fecha</span>
                @if (currentSort().field === 'date') {
                  <mat-icon>{{ currentSort().direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
                }
              </th>
              <th class="sortable text-right" (click)="sortBy('total')">
                <span>Total</span>
                @if (currentSort().field === 'total') {
                  <mat-icon>{{ currentSort().direction === 'asc' ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
                }
              </th>
              <th>Estado</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>

          <tbody>
            @for (proposal of paginatedProposals(); track proposal.id) {
              <tr class="table-row" (click)="viewProposal(proposal)">
                <!-- Número -->
                <td class="proposal-number">{{ proposal.proposalNumber }}</td>

                <!-- Cliente -->
                <td>
                  <div class="client-cell">
                    <div class="client-avatar">
                      {{ (proposal.ownerName || 'C').charAt(0).toUpperCase() }}
                    </div>
                    <span>{{ proposal.ownerName }}</span>
                  </div>
                </td>

                <!-- Dirección -->
                <td class="address-cell">
                  <span class="truncate">{{ proposal.address }}, {{ proposal.city }}</span>
                </td>

                <!-- Fecha -->
                <td class="date-cell">{{ formatDate(proposal.date) }}</td>

                <!-- Total -->
                <td class="total-cell">{{ formatCurrency(getProposalTotal(proposal)) }}</td>

                <!-- Estado -->
                <td>
                  <span [class]="'status-badge ' + getStatusClass(proposal.status)">
                    {{ getStatusLabel(proposal.status) }}
                  </span>
                </td>

                <!-- Acciones -->
                <td class="actions-cell" (click)="$event.stopPropagation()">
                  <button type="button"
                          class="icon-btn"
                          [matMenuTriggerFor]="menu"
                          title="Opciones">
                    <mat-icon>more_vert</mat-icon>
                  </button>

                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="viewProposal(proposal)">
                      <mat-icon>visibility</mat-icon>
                      <span>Ver detalles</span>
                    </button>

                    @if (proposal.status === 'draft') {
                      <button mat-menu-item (click)="editProposal(proposal)">
                        <mat-icon>edit</mat-icon>
                        <span>Editar</span>
                      </button>
                    }

                    <mat-divider></mat-divider>

                    <!-- Cambiar estado -->
                    @if (proposal.status === 'draft') {
                      <button mat-menu-item (click)="changeProposalStatus(proposal, 'sent')">
                        <mat-icon>send</mat-icon>
                        <span>Marcar como enviado</span>
                      </button>
                    }

                    @if (proposal.status === 'sent') {
                      <button mat-menu-item (click)="changeProposalStatus(proposal, 'approved')">
                        <mat-icon class="text-green-600">check_circle</mat-icon>
                        <span>Marcar como aprobado</span>
                      </button>
                      <button mat-menu-item (click)="changeProposalStatus(proposal, 'rejected')">
                        <mat-icon class="text-red-600">cancel</mat-icon>
                        <span>Marcar como rechazado</span>
                      </button>
                    }

                    @if (proposal.status === 'approved') {
                      <button mat-menu-item (click)="convertToInvoice(proposal)">
                        <mat-icon class="text-purple-600">receipt_long</mat-icon>
                        <span>Convertir a factura</span>
                      </button>
                    }

                    @if (proposal.status === 'converted_to_invoice') {
                      <button mat-menu-item (click)="changeProposalStatus(proposal, 'paid')">
                        <mat-icon class="text-emerald-600">payments</mat-icon>
                        <span>Marcar como pagado</span>
                      </button>
                    }

                    <mat-divider></mat-divider>

                    <button mat-menu-item (click)="deleteProposal(proposal)" class="text-red-600">
                      <mat-icon class="text-red-600">delete</mat-icon>
                      <span>Eliminar</span>
                    </button>
                  </mat-menu>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- ========== PAGINACIÓN ========== -->
      @if (totalPages() > 1) {
        <div class="pagination-bar">
          <span class="pagination-info">
            Mostrando {{ (currentPage() * itemsPerPage()) + 1 }} a
            {{ Math.min((currentPage() + 1) * itemsPerPage(), filteredProposals().length) }}
            de {{ filteredProposals().length }}
          </span>

          <div class="pagination-controls">
            <button type="button"
                    class="pagination-btn"
                    (click)="goToPage(currentPage() - 1)"
                    [disabled]="currentPage() === 0">
              <mat-icon>chevron_left</mat-icon>
            </button>

            <span class="pagination-current">
              {{ currentPage() + 1 }} / {{ totalPages() }}
            </span>

            <button type="button"
                    class="pagination-btn"
                    (click)="goToPage(currentPage() + 1)"
                    [disabled]="currentPage() >= totalPages() - 1">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
      }
    }

  </div>

</div>
