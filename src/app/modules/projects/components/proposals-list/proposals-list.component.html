<!-- proposals-list.component.html -->

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <div class="max-w-[1600px] mx-auto p-5">

    <!-- ========== HEADER ========== -->
    <header class="page-header">
      <div class="flex items-center justify-between gap-5 flex-wrap">

        <!-- Título e Icono -->
        <div class="flex items-center gap-4">
          <div class="header-icon-container" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
            <mat-icon>description</mat-icon>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-slate-800 mb-1">Gestión de Estimados</h1>
            <p class="text-sm text-slate-500">
              {{ filteredStats().total }} estimados
              @if (filteredStats().byStatus.approved > 0) {
                <span class="text-green-600 font-semibold"> • {{ filteredStats().byStatus.approved }} aprobados</span>
              }
            </p>
          </div>
        </div>

        <!-- Acciones del Header -->
        <div class="flex items-center gap-3">
          <button
            mat-icon-button
            class="icon-btn"
            (click)="openConfig()"
            [disabled]="isLoading()"
            matTooltip="Configuración del Módulo"
            aria-label="Configuración del módulo de estimados">
            <mat-icon>settings</mat-icon>
          </button>

          <button
            mat-icon-button
            class="icon-btn"
            (click)="refresh()"
            [disabled]="isLoading()"
            matTooltip="Actualizar"
            aria-label="Actualizar lista de estimados">
            <mat-icon>refresh</mat-icon>
          </button>

          <button
            mat-raised-button
            color="primary"
            (click)="createProposal()"
            [disabled]="isLoading()"
            class="flex items-center gap-2">
            <mat-icon>add</mat-icon>
            Nuevo Estimado
          </button>
        </div>

      </div>
    </header>

    <!-- ========== STATS CARDS ========== -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mb-6">

      <!-- Total -->
      <div class="card-corporate cursor-pointer hover:shadow-lg transition-all"
           [class.ring-2]="statusFilter() === 'all'"
           [class.ring-blue-500]="statusFilter() === 'all'"
           (click)="filterByStatus('all')">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Total</p>
            <p class="text-2xl font-bold text-slate-800">{{ stats().total }}</p>
          </div>
          <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-blue-600 !text-xl">description</mat-icon>
          </div>
        </div>
      </div>

      <!-- Borradores -->
      <div class="card-corporate cursor-pointer hover:shadow-lg transition-all"
           [class.ring-2]="statusFilter() === 'draft'"
           [class.ring-slate-500]="statusFilter() === 'draft'"
           (click)="filterByStatus('draft')">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Borradores</p>
            <p class="text-2xl font-bold text-slate-600">{{ stats().byStatus.draft }}</p>
          </div>
          <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-slate-600 !text-xl">edit</mat-icon>
          </div>
        </div>
      </div>

      <!-- Enviados -->
      <div class="card-corporate cursor-pointer hover:shadow-lg transition-all"
           [class.ring-2]="statusFilter() === 'sent'"
           [class.ring-amber-500]="statusFilter() === 'sent'"
           (click)="filterByStatus('sent')">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Enviados</p>
            <p class="text-2xl font-bold text-amber-600">{{ stats().byStatus.sent }}</p>
          </div>
          <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-amber-600 !text-xl">send</mat-icon>
          </div>
        </div>
      </div>

      <!-- Aprobados -->
      <div class="card-corporate cursor-pointer hover:shadow-lg transition-all"
           [class.ring-2]="statusFilter() === 'approved'"
           [class.ring-green-500]="statusFilter() === 'approved'"
           (click)="filterByStatus('approved')">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Aprobados</p>
            <p class="text-2xl font-bold text-green-600">{{ stats().byStatus.approved }}</p>
          </div>
          <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-green-600 !text-xl">check_circle</mat-icon>
          </div>
        </div>
      </div>

      <!-- Facturados -->
      <div class="card-corporate cursor-pointer hover:shadow-lg transition-all"
           [class.ring-2]="statusFilter() === 'converted_to_invoice'"
           [class.ring-purple-500]="statusFilter() === 'converted_to_invoice'"
           (click)="filterByStatus('converted_to_invoice')">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Facturados</p>
            <p class="text-2xl font-bold text-purple-600">{{ stats().byStatus.converted_to_invoice }}</p>
          </div>
          <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-purple-600 !text-xl">receipt_long</mat-icon>
          </div>
        </div>
      </div>

      <!-- Pagados -->
      <div class="card-corporate cursor-pointer hover:shadow-lg transition-all"
           [class.ring-2]="statusFilter() === 'paid'"
           [class.ring-emerald-500]="statusFilter() === 'paid'"
           (click)="filterByStatus('paid')">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Pagados</p>
            <p class="text-2xl font-bold text-emerald-600">{{ stats().byStatus.paid }}</p>
          </div>
          <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-emerald-600 !text-xl">payments</mat-icon>
          </div>
        </div>
      </div>

      <!-- Rechazados -->
      <div class="card-corporate cursor-pointer hover:shadow-lg transition-all"
           [class.ring-2]="statusFilter() === 'rejected'"
           [class.ring-red-500]="statusFilter() === 'rejected'"
           (click)="filterByStatus('rejected')">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Rechazados</p>
            <p class="text-2xl font-bold text-red-600">{{ stats().byStatus.rejected }}</p>
          </div>
          <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-red-600 !text-xl">cancel</mat-icon>
          </div>
        </div>
      </div>

      <!-- Cancelados -->
      <div class="card-corporate cursor-pointer hover:shadow-lg transition-all"
           [class.ring-2]="statusFilter() === 'cancelled'"
           [class.ring-orange-500]="statusFilter() === 'cancelled'"
           (click)="filterByStatus('cancelled')">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Cancelados</p>
            <p class="text-2xl font-bold text-orange-600">{{ stats().byStatus.cancelled }}</p>
          </div>
          <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-orange-600 !text-xl">block</mat-icon>
          </div>
        </div>
      </div>

      <!-- Valor Total -->
      <div class="card-corporate sm:col-span-2 md:col-span-1 lg:col-span-2">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 mb-1">Valor Total</p>
            <p class="text-2xl font-bold text-blue-600">{{ formatCurrency(filteredStats().totalValue) }}</p>
          </div>
          <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
            <mat-icon class="text-blue-600 !text-xl">attach_money</mat-icon>
          </div>
        </div>
      </div>

    </div>

    <!-- ========== BÚSQUEDA Y FILTROS ========== -->
    <div class="card-modern mb-6">
      <div class="flex items-center gap-4">
        <mat-icon class="text-slate-400">search</mat-icon>
        <input
          type="text"
          placeholder="Buscar por número, cliente, dirección..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearch($event)"
          class="flex-1 px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium
                 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition-all
                 placeholder:text-slate-400">

        @if (searchTerm()) {
          <button
            mat-icon-button
            (click)="onSearch('')"
            matTooltip="Limpiar búsqueda"
            aria-label="Limpiar búsqueda">
            <mat-icon>close</mat-icon>
          </button>
        }
      </div>

      <!-- Filtros rápidos -->
      @if (statusFilter() !== 'all') {
        <div class="mt-3 flex items-center gap-2">
          <mat-icon class="text-slate-400 !text-base">filter_list</mat-icon>
          <span class="text-sm text-slate-600">Filtrado por:</span>
          <mat-chip-set>
            <mat-chip [removable]="true" (removed)="filterByStatus('all')">
              @if (statusFilter() === 'draft') { Borrador }
              @else if (statusFilter() === 'sent') { Enviado }
              @else if (statusFilter() === 'approved') { Aprobado }
              @else if (statusFilter() === 'rejected') { Rechazado }
              @else if (statusFilter() === 'converted_to_invoice') { Facturado }
              @else if (statusFilter() === 'paid') { Pagado }
              @else if (statusFilter() === 'cancelled') { Cancelado }
              <button matChipRemove>
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          </mat-chip-set>
        </div>
      }
    </div>

    <!-- ========== TABLA DE PROPOSALS ========== -->
    <div class="card-modern">

      @if (isLoading()) {
        <!-- Loading State -->
        <div class="flex flex-col items-center justify-center py-16">
          <mat-spinner diameter="40"></mat-spinner>
          <p class="text-sm text-slate-500 mt-4">Cargando estimados...</p>
        </div>
      } @else if (filteredProposals().length === 0) {
        <!-- Empty State -->
        <div class="empty-state">
          <mat-icon>description</mat-icon>
          <h3>No hay estimados</h3>
          @if (searchTerm()) {
            <p>No se encontraron estimados con esos criterios de búsqueda</p>
          } @else {
            <p>Comienza creando tu primer estimado</p>
            <button
              mat-raised-button
              color="primary"
              (click)="createProposal()"
              class="empty-state-button">
              <mat-icon>add</mat-icon>
              Crear Primer Estimado
            </button>
          }
        </div>
      } @else {
        <!-- Tabla -->
        <div class="overflow-x-auto">
          <table class="w-full" role="table" aria-label="Tabla de estimados">
            <caption class="sr-only">Listado de estimados con sus datos, estado y acciones disponibles</caption>

            <!-- Header -->
            <thead class="bg-slate-50 border-b-2 border-slate-200">
              <tr>
                <!-- Número -->
                <th
                  class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors"
                  (click)="sortBy('proposalNumber')">
                  <div class="flex items-center gap-2">
                    <span>Número</span>
                    @if (currentSort().field === 'proposalNumber') {
                      @if (currentSort().direction === 'asc') {
                        <mat-icon class="!text-base">arrow_upward</mat-icon>
                      } @else {
                        <mat-icon class="!text-base">arrow_downward</mat-icon>
                      }
                    }
                  </div>
                </th>

                <!-- Cliente -->
                <th
                  class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors"
                  (click)="sortBy('ownerName')">
                  <div class="flex items-center gap-2">
                    <span>Cliente</span>
                    @if (currentSort().field === 'ownerName') {
                      @if (currentSort().direction === 'asc') {
                        <mat-icon class="!text-base">arrow_upward</mat-icon>
                      } @else {
                        <mat-icon class="!text-base">arrow_downward</mat-icon>
                      }
                    }
                  </div>
                </th>

                <!-- Dirección -->
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                  Dirección del Trabajo
                </th>

                <!-- Fecha -->
                <th
                  class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors"
                  (click)="sortBy('date')">
                  <div class="flex items-center gap-2">
                    <span>Fecha</span>
                    @if (currentSort().field === 'date') {
                      @if (currentSort().direction === 'asc') {
                        <mat-icon class="!text-base">arrow_upward</mat-icon>
                      } @else {
                        <mat-icon class="!text-base">arrow_downward</mat-icon>
                      }
                    }
                  </div>
                </th>

                <!-- Total -->
                <th
                  class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors"
                  (click)="sortBy('total')">
                  <div class="flex items-center justify-end gap-2">
                    <span>Total</span>
                    @if (currentSort().field === 'total') {
                      @if (currentSort().direction === 'asc') {
                        <mat-icon class="!text-base">arrow_upward</mat-icon>
                      } @else {
                        <mat-icon class="!text-base">arrow_downward</mat-icon>
                      }
                    }
                  </div>
                </th>

                <!-- Estado -->
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider w-40">
                  Estado
                </th>

                <!-- Acciones -->
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider w-24">
                  Acciones
                </th>
              </tr>
            </thead>

            <!-- Body -->
            <tbody class="divide-y divide-slate-200">
              @for (proposal of paginatedProposals(); track proposal.id) {
                <tr
                  class="hover:bg-slate-50 transition-colors cursor-pointer"
                  (click)="viewProposal(proposal)">

                  <!-- Número -->
                  <td class="px-4 py-3 text-sm font-semibold text-blue-600">
                    {{ proposal.proposalNumber }}
                  </td>

                  <!-- Cliente -->
                  <td class="px-4 py-3 text-sm text-slate-700">
                    <div class="flex items-center gap-2">
                      <mat-icon class="!text-base text-slate-400">person</mat-icon>
                      {{ proposal.ownerName }}
                    </div>
                  </td>

                  <!-- Dirección -->
                  <td class="px-4 py-3 text-sm text-slate-600">
                    <div class="max-w-xs truncate">
                      {{ proposal.address }}, {{ proposal.city }}
                    </div>
                  </td>

                  <!-- Fecha -->
                  <td class="px-4 py-3 text-sm text-slate-700">
                    {{ formatDate(proposal.date) }}
                  </td>

                  <!-- Total -->
                  <td class="px-4 py-3 text-sm font-bold text-right text-slate-800">
                    {{ formatCurrency(proposal.total) }}
                  </td>

                  <!-- Estado -->
                  <td class="px-4 py-3">
                    <span [class]="getStatusClass(proposal.status)">
                      {{ getStatusLabel(proposal.status) }}
                    </span>
                  </td>

                  <!-- Acciones -->
                  <td class="px-4 py-3 text-right" (click)="$event.stopPropagation()">
                    <button
                      mat-icon-button
                      [matMenuTriggerFor]="menu"
                      (click)="$event.stopPropagation()"
                      aria-label="Abrir menú de opciones del estimado">
                      <mat-icon>more_vert</mat-icon>
                    </button>

                    <mat-menu #menu="matMenu">
                      <button mat-menu-item (click)="viewProposal(proposal)">
                        <mat-icon>visibility</mat-icon>
                        <span>Ver detalles</span>
                      </button>

                      @if (proposal.status === 'draft') {
                        <button mat-menu-item (click)="editProposal(proposal)">
                          <mat-icon>edit</mat-icon>
                          <span>Editar</span>
                        </button>
                      }

                      <mat-divider></mat-divider>

                      <!-- Cambiar estado -->
                      @if (proposal.status === 'draft') {
                        <button mat-menu-item (click)="changeProposalStatus(proposal, 'sent')">
                          <mat-icon>send</mat-icon>
                          <span>Marcar como enviado</span>
                        </button>
                      }

                      @if (proposal.status === 'sent') {
                        <button mat-menu-item (click)="changeProposalStatus(proposal, 'approved')">
                          <mat-icon class="text-green-600">check_circle</mat-icon>
                          <span>Marcar como aprobado</span>
                        </button>
                        <button mat-menu-item (click)="changeProposalStatus(proposal, 'rejected')">
                          <mat-icon class="text-red-600">cancel</mat-icon>
                          <span>Marcar como rechazado</span>
                        </button>
                      }

                      @if (proposal.status === 'approved') {
                        <button mat-menu-item (click)="convertToInvoice(proposal)">
                          <mat-icon class="text-purple-600">receipt_long</mat-icon>
                          <span>Convertir a factura</span>
                        </button>
                      }

                      @if (proposal.status === 'converted_to_invoice') {
                        <button mat-menu-item (click)="changeProposalStatus(proposal, 'paid')">
                          <mat-icon class="text-emerald-600">payments</mat-icon>
                          <span>Marcar como pagado</span>
                        </button>
                      }

                      <mat-divider></mat-divider>

                      <button mat-menu-item (click)="deleteProposal(proposal)" class="text-red-600">
                        <mat-icon class="text-red-600">delete</mat-icon>
                        <span>Eliminar</span>
                      </button>
                    </mat-menu>
                  </td>

                </tr>
              }
            </tbody>

          </table>
        </div>

        <!-- ========== PAGINACIÓN ========== -->
        @if (totalPages() > 1) {
          <div class="flex items-center justify-between px-4 py-4 border-t border-slate-200">
            <div class="text-sm text-slate-600">
              Mostrando {{ (currentPage() * itemsPerPage()) + 1 }} a
              {{ Math.min((currentPage() + 1) * itemsPerPage(), filteredProposals().length) }}
              de {{ filteredProposals().length }} estimados
            </div>

            <div class="flex items-center gap-2">
              <button
                mat-icon-button
                (click)="goToPage(currentPage() - 1)"
                [disabled]="currentPage() === 0"
                aria-label="Página anterior">
                <mat-icon>chevron_left</mat-icon>
              </button>

              <span class="text-sm font-medium text-slate-700">
                Página {{ currentPage() + 1 }} de {{ totalPages() }}
              </span>

              <button
                mat-icon-button
                (click)="goToPage(currentPage() + 1)"
                [disabled]="currentPage() >= totalPages() - 1"
                aria-label="Página siguiente">
                <mat-icon>chevron_right</mat-icon>
              </button>
            </div>
          </div>
        }

      }

    </div>

  </div>
</div>
