<!-- work-plan-form Dialog - Estilo consistente con proposals -->
<div class="dialog-container">

  <!-- Header -->
  <div class="dialog-header">
    <div class="flex items-center gap-3">
      <div class="header-icon purple">
        <mat-icon>{{ data.mode === 'create' ? 'add_task' : 'edit_calendar' }}</mat-icon>
      </div>
      <div>
        <h1 class="header-title">{{ getTitle() }}</h1>
        <p class="header-subtitle">{{ getSubtitle() }}</p>
      </div>
    </div>
    <button type="button" class="close-btn" (click)="onCancel()" [disabled]="isSaving()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p class="text-sm text-slate-500 mt-3">Cargando datos...</p>
    </div>
  } @else {

    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="dialog-content">

        <!-- Secci√≥n: Fecha y Duraci√≥n -->
        <div class="form-section">
          <div class="section-header">
            <div class="section-icon purple">
              <mat-icon>event</mat-icon>
            </div>
            <div>
              <h2>Fecha y Duraci√≥n</h2>
              <p>Cu√°ndo y por cu√°nto tiempo</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Fecha del Plan -->
            <div class="md:col-span-3">
              <div class="form-group">
                <label class="form-label required">
                  <mat-icon>event</mat-icon>
                  Fecha del Plan
                </label>
                <input
                  type="text"
                  [matDatepicker]="picker"
                  formControlName="planDate"
                  placeholder="Seleccione una fecha"
                  class="form-input"
                  [class.error]="form.get('planDate')?.invalid && form.get('planDate')?.touched"
                  required>
                <mat-datepicker-toggle [for]="picker" class="datepicker-toggle"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                @if (form.get('planDate')?.invalid && form.get('planDate')?.touched) {
                  <p class="form-error">{{ getErrorMessage('planDate') }}</p>
                }
              </div>
            </div>

            <!-- Duraci√≥n en D√≠as -->
            <div>
              <div class="form-group">
                <label class="form-label required">
                  <mat-icon>today</mat-icon>
                  D√≠as
                </label>
                <div class="relative">
                  <input
                    type="number"
                    formControlName="durationDays"
                    placeholder="0"
                    min="0"
                    class="form-input pr-20"
                    [class.error]="form.get('durationDays')?.invalid && form.get('durationDays')?.touched"
                    required>
                  <div class="number-controls">
                    <button type="button" class="control-btn" (click)="incrementDays()" [disabled]="isSaving()">
                      <mat-icon>add</mat-icon>
                    </button>
                    <button type="button" class="control-btn" (click)="decrementDays()" [disabled]="isSaving() || (form.get('durationDays')?.value || 0) === 0">
                      <mat-icon>remove</mat-icon>
                    </button>
                  </div>
                </div>
                @if (form.get('durationDays')?.invalid && form.get('durationDays')?.touched) {
                  <p class="form-error">{{ getErrorMessage('durationDays') }}</p>
                }
              </div>
            </div>

            <!-- Duraci√≥n en Horas -->
            <div>
              <div class="form-group">
                <label class="form-label required">
                  <mat-icon>schedule</mat-icon>
                  Horas (0-23)
                </label>
                <div class="relative">
                  <input
                    type="number"
                    formControlName="durationHours"
                    placeholder="0"
                    min="0"
                    max="23"
                    class="form-input pr-20"
                    [class.error]="form.get('durationHours')?.invalid && form.get('durationHours')?.touched"
                    required>
                  <div class="number-controls">
                    <button type="button" class="control-btn" (click)="incrementHours()" [disabled]="isSaving() || (form.get('durationHours')?.value || 0) >= 23">
                      <mat-icon>add</mat-icon>
                    </button>
                    <button type="button" class="control-btn" (click)="decrementHours()" [disabled]="isSaving() || (form.get('durationHours')?.value || 0) === 0">
                      <mat-icon>remove</mat-icon>
                    </button>
                  </div>
                </div>
                @if (form.get('durationHours')?.invalid && form.get('durationHours')?.touched) {
                  <p class="form-error">{{ getErrorMessage('durationHours') }}</p>
                }
              </div>
            </div>

            <!-- Total Duration -->
            <div class="flex items-end">
              <div class="info-badge">
                <mat-icon>timer</mat-icon>
                <span>Total: {{ getTotalDuration() }}h</span>
              </div>
            </div>
          </div>

          @if (getTotalDuration() === 0) {
            <div class="warning-box">
              <mat-icon>warning</mat-icon>
              <span>Debe especificar al menos 1 d√≠a o 1 hora de duraci√≥n</span>
            </div>
          }
        </div>

        <!-- Secci√≥n: Asignaci√≥n -->
        <div class="form-section">
          <div class="section-header">
            <div class="section-icon purple">
              <mat-icon>assignment_ind</mat-icon>
            </div>
            <div>
              <h2>Asignaci√≥n</h2>
              <p>Trabajador o propuesta relacionada</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Trabajador -->
            <div class="form-group">
              <label class="form-label">
                <mat-icon>engineering</mat-icon>
                Trabajador
              </label>
              <select formControlName="workerId" class="form-input" [disabled]="isSaving()">
                <option value="">Ninguno</option>
                @for (worker of workers(); track worker.id) {
                  <option [value]="worker.id">{{ worker.fullName }}</option>
                }
              </select>
              <p class="form-hint">Opcional: Asignar a un trabajador espec√≠fico</p>
            </div>

            <!-- Propuesta/Estimado -->
            <div class="form-group">
              <label class="form-label">
                <mat-icon>description</mat-icon>
                Propuesta/Estimado
              </label>
              <select formControlName="proposalId" class="form-input" [disabled]="isSaving()">
                <option value="">Ninguno</option>
                @for (proposal of proposals(); track proposal.id) {
                  <option [value]="proposal.id">{{ proposal.proposalNumber }} - {{ proposal.ownerName }}</option>
                }
              </select>
              <p class="form-hint">Opcional: Vincular a una propuesta</p>
            </div>
          </div>
        </div>

        <!-- Secci√≥n: Detalles -->
        <div class="form-section">
          <div class="section-header">
            <div class="section-icon purple">
              <mat-icon>notes</mat-icon>
            </div>
            <div>
              <h2>Detalles del Trabajo</h2>
              <p>Descripci√≥n, ubicaci√≥n y estado</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Descripci√≥n -->
            <div class="md:col-span-2 form-group">
              <label class="form-label required">
                <mat-icon>subject</mat-icon>
                Descripci√≥n
              </label>
              <textarea
                formControlName="description"
                rows="3"
                maxlength="500"
                placeholder="Descripci√≥n del trabajo a realizar..."
                class="form-textarea"
                [class.error]="form.get('description')?.invalid && form.get('description')?.touched"
                required></textarea>
              <div class="flex justify-between items-center">
                @if (form.get('description')?.invalid && form.get('description')?.touched) {
                  <p class="form-error">{{ getErrorMessage('description') }}</p>
                } @else {
                  <p class="form-hint">Describa brevemente el trabajo planificado</p>
                }
                <span class="char-count">{{ form.get('description')?.value?.length || 0 }}/500</span>
              </div>
            </div>

            <!-- Ubicaci√≥n -->
            <div class="form-group">
              <label class="form-label">
                <mat-icon>location_on</mat-icon>
                Ubicaci√≥n
              </label>
              <input
                type="text"
                formControlName="location"
                placeholder="Ej: Oficina principal, Sitio A..."
                maxlength="200"
                class="form-input"
                [disabled]="isSaving()">
              <p class="form-hint">Lugar donde se realizar√° el trabajo</p>
            </div>

            <!-- Estado -->
            <div class="form-group">
              <label class="form-label required">
                <mat-icon>flag</mat-icon>
                Estado
              </label>
              <select
                formControlName="status"
                class="form-input"
                [class.error]="form.get('status')?.invalid && form.get('status')?.touched"
                [disabled]="isSaving()"
                required>
                <option value="scheduled">üìÖ Programado</option>
                <option value="in-progress">‚öôÔ∏è En Progreso</option>
                <option value="completed">‚úÖ Completado</option>
                <option value="cancelled">‚ùå Cancelado</option>
                <option value="postponed">‚è∏Ô∏è Pospuesto</option>
              </select>
              @if (form.get('status')?.invalid && form.get('status')?.touched) {
                <p class="form-error">{{ getErrorMessage('status') }}</p>
              }
            </div>

            <!-- Notas -->
            <div class="md:col-span-2 form-group">
              <label class="form-label">
                <mat-icon>notes</mat-icon>
                Notas Adicionales
              </label>
              <textarea
                formControlName="notes"
                rows="2"
                maxlength="500"
                placeholder="Notas, comentarios o instrucciones especiales..."
                class="form-textarea"
                [disabled]="isSaving()"></textarea>
              <div class="flex justify-between items-center">
                <p class="form-hint">Informaci√≥n adicional relevante</p>
                <span class="char-count">{{ form.get('notes')?.value?.length || 0 }}/500</span>
              </div>
            </div>

            <!-- Color -->
            <div class="md:col-span-2 form-group">
              <label class="form-label">
                <mat-icon>palette</mat-icon>
                Color de Identificaci√≥n
              </label>
              <div class="color-grid">
                @for (colorOption of colorOptions; track colorOption.value) {
                  <button
                    type="button"
                    class="color-option"
                    [class.selected]="form.get('color')?.value === colorOption.value"
                    [style.background-color]="colorOption.value"
                    (click)="selectColor(colorOption.value)"
                    [disabled]="isSaving()"
                    [title]="colorOption.label">
                    @if (form.get('color')?.value === colorOption.value) {
                      <mat-icon>check</mat-icon>
                    }
                  </button>
                }
              </div>
              <p class="form-hint">Seleccione un color para identificar visualmente este plan</p>
            </div>
          </div>
        </div>

        <!-- Preview Card -->
        @if (form.get('description')?.value) {
          <div class="preview-section">
            <div class="preview-header">
              <mat-icon>visibility</mat-icon>
              <span>Vista Previa</span>
            </div>
            <div class="preview-card" [style.border-left-color]="form.get('color')?.value || '#9333EA'">
              <p class="preview-title">{{ form.get('description')?.value }}</p>
              <p class="preview-subtitle">
                <mat-icon>timer</mat-icon> {{ getTotalDuration() }}h total
                @if (form.get('workerName')?.value) {
                  ¬∑ <mat-icon>person</mat-icon> {{ form.get('workerName')?.value }}
                }
                @if (form.get('location')?.value) {
                  ¬∑ <mat-icon>location_on</mat-icon> {{ form.get('location')?.value }}
                }
              </p>
            </div>
          </div>
        }

      </div>

      <!-- Actions -->
      <div class="dialog-actions">
        <button type="button" class="btn-cancel" (click)="onCancel()" [disabled]="isSaving()">
          <mat-icon>close</mat-icon>
          <span>Cancelar</span>
        </button>
        <button type="submit" class="btn-primary" [disabled]="form.invalid || isSaving() || getTotalDuration() === 0">
          @if (isSaving()) {
            <div class="btn-spinner"></div>
          } @else {
            <mat-icon>save</mat-icon>
          }
          <span>{{ data.mode === 'create' ? 'Crear Plan' : 'Actualizar Plan' }}</span>
        </button>
      </div>
    </form>

  }
</div>
