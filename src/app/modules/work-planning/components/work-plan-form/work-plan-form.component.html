<div class="work-plan-form-dialog">
  <!-- Header -->
  <div class="dialog-header">
    <div class="flex items-center gap-3">
      <div class="dialog-icon purple">
        <span class="text-3xl">{{ getIconEmoji() }}</span>
      </div>
      <div>
        <h2 class="dialog-title">{{ getTitle() }}</h2>
        <p class="dialog-subtitle">Complete los campos para {{ data.mode === 'create' ? 'crear' : 'actualizar' }} el plan de trabajo</p>
      </div>
    </div>
    <button
      type="button"
      class="dialog-close-btn"
      (click)="onCancel()"
      [disabled]="isSaving()">
      <span class="text-xl">‚úï</span>
    </button>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p class="loading-text">Cargando datos...</p>
    </div>
  } @else {
    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="dialog-content">

        <!-- Fecha y Duraci√≥n -->
        <div class="form-section">
          <h3 class="section-title">
            <span class="section-icon">üìÖ</span>
            Fecha y Duraci√≥n
          </h3>

          <div class="form-grid">
            <!-- Fecha del Plan -->
            <div class="col-span-2">
              <label class="input-label">
                <span class="label-icon">üìÜ</span>
                Fecha del Plan
                <span class="text-red-500">*</span>
              </label>
              <div class="input-wrapper">
                <input
                  [matDatepicker]="picker"
                  formControlName="planDate"
                  placeholder="Seleccione una fecha"
                  class="input-field"
                  [class.input-error]="form.get('planDate')?.invalid && form.get('planDate')?.touched"
                  required>
                <mat-datepicker-toggle class="datepicker-toggle" [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </div>
              @if (form.get('planDate')?.invalid && form.get('planDate')?.touched) {
                <p class="error-message">{{ getErrorMessage('planDate') }}</p>
              }
            </div>

            <!-- Duraci√≥n en D√≠as -->
            <div>
              <label class="input-label">
                <span class="label-icon">üìä</span>
                D√≠as
                <span class="text-red-500">*</span>
              </label>
              <div class="number-input-wrapper">
                <input
                  type="number"
                  formControlName="durationDays"
                  placeholder="0"
                  min="0"
                  class="input-field"
                  [class.input-error]="form.get('durationDays')?.invalid && form.get('durationDays')?.touched"
                  required>
                <div class="number-controls">
                  <button
                    type="button"
                    class="control-btn"
                    (click)="incrementDays()"
                    [disabled]="isSaving()">
                    <span class="text-lg">‚ñ≤</span>
                  </button>
                  <button
                    type="button"
                    class="control-btn"
                    (click)="decrementDays()"
                    [disabled]="isSaving() || (form.get('durationDays')?.value || 0) === 0">
                    <span class="text-lg">‚ñº</span>
                  </button>
                </div>
              </div>
              @if (form.get('durationDays')?.invalid && form.get('durationDays')?.touched) {
                <p class="error-message">{{ getErrorMessage('durationDays') }}</p>
              }
            </div>

            <!-- Duraci√≥n en Horas -->
            <div>
              <label class="input-label">
                <span class="label-icon">‚è±Ô∏è</span>
                Horas (0-23)
                <span class="text-red-500">*</span>
              </label>
              <div class="number-input-wrapper">
                <input
                  type="number"
                  formControlName="durationHours"
                  placeholder="0"
                  min="0"
                  max="23"
                  class="input-field"
                  [class.input-error]="form.get('durationHours')?.invalid && form.get('durationHours')?.touched"
                  required>
                <div class="number-controls">
                  <button
                    type="button"
                    class="control-btn"
                    (click)="incrementHours()"
                    [disabled]="isSaving() || (form.get('durationHours')?.value || 0) >= 23">
                    <span class="text-lg">‚ñ≤</span>
                  </button>
                  <button
                    type="button"
                    class="control-btn"
                    (click)="decrementHours()"
                    [disabled]="isSaving() || (form.get('durationHours')?.value || 0) === 0">
                    <span class="text-lg">‚ñº</span>
                  </button>
                </div>
              </div>
              @if (form.get('durationHours')?.invalid && form.get('durationHours')?.touched) {
                <p class="error-message">{{ getErrorMessage('durationHours') }}</p>
              }
            </div>
          </div>

          @if (getTotalDuration() === 0) {
            <div class="warning-message">
              <span class="text-lg">‚ö†Ô∏è</span>
              <span>Debe especificar al menos 1 d√≠a o 1 hora de duraci√≥n</span>
            </div>
          }
        </div>

        <!-- Asignaci√≥n -->
        <div class="form-section">
          <h3 class="section-title">
            <span class="section-icon">üë§</span>
            Asignaci√≥n
          </h3>

          <div class="form-grid">
            <!-- Trabajador -->
            <div>
              <label class="input-label">
                <span class="label-icon">üîß</span>
                Trabajador
              </label>
              <div class="select-wrapper">
                <select
                  formControlName="workerId"
                  class="select-field"
                  [disabled]="isSaving()">
                  <option value="">Ninguno</option>
                  @for (worker of workers(); track worker.id) {
                    <option [value]="worker.id">{{ worker.name }}</option>
                  }
                </select>
                <span class="select-icon">‚ñº</span>
              </div>
              <p class="hint-text">Opcional: Asignar a un trabajador espec√≠fico</p>
            </div>

            <!-- Propuesta/Estimado -->
            <div>
              <label class="input-label">
                <span class="label-icon">üìÑ</span>
                Propuesta/Estimado
              </label>
              <div class="select-wrapper">
                <select
                  formControlName="proposalId"
                  class="select-field"
                  [disabled]="isSaving()">
                  <option value="">Ninguno</option>
                  @for (proposal of proposals(); track proposal.id) {
                    <option [value]="proposal.id">
                      {{ proposal.number }} - {{ proposal.ownerName }}
                    </option>
                  }
                </select>
                <span class="select-icon">‚ñº</span>
              </div>
              <p class="hint-text">Opcional: Vincular a una propuesta</p>
            </div>
          </div>
        </div>

        <!-- Detalles -->
        <div class="form-section">
          <h3 class="section-title">
            <span class="section-icon">üìù</span>
            Detalles
          </h3>

          <div class="form-grid">
            <!-- Descripci√≥n -->
            <div class="col-span-2">
              <label class="input-label">
                <span class="label-icon">üìã</span>
                Descripci√≥n
                <span class="text-red-500">*</span>
              </label>
              <textarea
                formControlName="description"
                rows="3"
                maxlength="500"
                placeholder="Descripci√≥n del trabajo a realizar..."
                class="textarea-field"
                [class.input-error]="form.get('description')?.invalid && form.get('description')?.touched"
                required></textarea>
              <div class="flex justify-between items-center">
                @if (form.get('description')?.invalid && form.get('description')?.touched) {
                  <p class="error-message">{{ getErrorMessage('description') }}</p>
                } @else {
                  <p class="hint-text">Describa brevemente el trabajo planificado</p>
                }
                <span class="char-count">{{ form.get('description')?.value?.length || 0 }}/500</span>
              </div>
            </div>

            <!-- Ubicaci√≥n -->
            <div>
              <label class="input-label">
                <span class="label-icon">üìç</span>
                Ubicaci√≥n
              </label>
              <input
                type="text"
                formControlName="location"
                placeholder="Ej: Oficina principal, Sitio A..."
                maxlength="200"
                class="input-field"
                [disabled]="isSaving()">
              <p class="hint-text">Lugar donde se realizar√° el trabajo</p>
            </div>

            <!-- Estado -->
            <div>
              <label class="input-label">
                <span class="label-icon">üìä</span>
                Estado
                <span class="text-red-500">*</span>
              </label>
              <div class="select-wrapper">
                <select
                  formControlName="status"
                  class="select-field"
                  [disabled]="isSaving()"
                  required>
                  <option value="scheduled">üìÖ Programado</option>
                  <option value="in-progress">‚öôÔ∏è En Progreso</option>
                  <option value="completed">‚úÖ Completado</option>
                  <option value="cancelled">‚ùå Cancelado</option>
                  <option value="postponed">‚è∏Ô∏è Pospuesto</option>
                </select>
                <span class="select-icon">‚ñº</span>
              </div>
              @if (form.get('status')?.invalid && form.get('status')?.touched) {
                <p class="error-message">{{ getErrorMessage('status') }}</p>
              }
            </div>

            <!-- Notas -->
            <div class="col-span-2">
              <label class="input-label">
                <span class="label-icon">üìÑ</span>
                Notas Adicionales
              </label>
              <textarea
                formControlName="notes"
                rows="2"
                maxlength="500"
                placeholder="Notas, comentarios o instrucciones especiales..."
                class="textarea-field"
                [disabled]="isSaving()"></textarea>
              <div class="flex justify-between items-center">
                <p class="hint-text">Informaci√≥n adicional relevante</p>
                <span class="char-count">{{ form.get('notes')?.value?.length || 0 }}/500</span>
              </div>
            </div>

            <!-- Color -->
            <div class="col-span-2">
              <label class="input-label">
                <span class="label-icon">üé®</span>
                Color de Identificaci√≥n
              </label>
              <div class="color-grid">
                @for (colorOption of colorOptions; track colorOption.value) {
                  <button
                    type="button"
                    class="color-option"
                    [class.selected]="form.get('color')?.value === colorOption.value"
                    [style.background-color]="colorOption.value"
                    (click)="selectColor(colorOption.value)"
                    [disabled]="isSaving()">
                    @if (form.get('color')?.value === colorOption.value) {
                      <span class="text-white text-lg font-bold">‚úì</span>
                    }
                  </button>
                }
              </div>
              <p class="hint-text">Seleccione un color para identificar visualmente este plan</p>
            </div>
          </div>
        </div>

        <!-- Preview -->
        @if (form.get('description')?.value || form.get('color')?.value) {
          <div class="form-section">
            <h3 class="section-title">
              <span class="section-icon">üëÅÔ∏è</span>
              Vista Previa
            </h3>

            <div class="color-preview-section">
              <p class="preview-label">As√≠ se ver√° el plan en el calendario:</p>
              <div
                class="preview-card"
                [style.border-left-color]="form.get('color')?.value || '#9333EA'">
                <div class="preview-content">
                  <span class="preview-icon">üìã</span>
                  <div class="preview-text-container">
                    <p class="preview-title">
                      {{ form.get('description')?.value || 'Sin descripci√≥n' }}
                    </p>
                    <p class="preview-subtitle">
                      ‚è±Ô∏è {{ getTotalDuration() }} {{ getTotalDuration() === 1 ? 'hora' : 'horas' }}
                      @if (form.get('workerName')?.value) {
                        ¬∑ üë§ {{ form.get('workerName')?.value }}
                      }
                      @if (form.get('location')?.value) {
                        ¬∑ üìç {{ form.get('location')?.value }}
                      }
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }

      </div>

      <!-- Actions -->
      <div class="dialog-actions">
        <button
          type="button"
          class="btn-cancel"
          (click)="onCancel()"
          [disabled]="isSaving()">
          <span>‚úï</span>
          Cancelar
        </button>
        <button
          type="submit"
          class="btn-save"
          [disabled]="form.invalid || isSaving() || getTotalDuration() === 0">
          @if (isSaving()) {
            <div class="spinner-small"></div>
          } @else {
            <span>üíæ</span>
          }
          {{ data.mode === 'create' ? 'Crear Plan' : 'Actualizar Plan' }}
        </button>
      </div>
    </form>
  }
</div>
