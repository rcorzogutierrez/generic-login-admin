<div class="work-plan-form-dialog">
  <!-- Header -->
  <div class="dialog-header">
    <div class="flex items-center gap-3">
      <div class="dialog-icon purple">
        <mat-icon>{{ getIcon() }}</mat-icon>
      </div>
      <div>
        <h2 class="dialog-title">{{ getTitle() }}</h2>
        <p class="dialog-subtitle">Complete los campos para {{ data.mode === 'create' ? 'crear' : 'actualizar' }} el plan de trabajo</p>
      </div>
    </div>
    <button
      type="button"
      class="dialog-close-btn"
      (click)="onCancel()"
      [disabled]="isSaving()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p class="loading-text">Cargando datos...</p>
    </div>
  } @else {
    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="dialog-content">

        <!-- Fecha y Duración -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>event</mat-icon>
            Fecha y Duración
          </h3>

          <div class="form-grid">
            <!-- Fecha del Plan -->
            <div class="col-span-2">
              <label class="input-label">
                <mat-icon class="label-icon">event</mat-icon>
                Fecha del Plan
                <span class="text-red-500">*</span>
              </label>
              <div class="input-wrapper">
                <input
                  [matDatepicker]="picker"
                  formControlName="planDate"
                  placeholder="Seleccione una fecha"
                  class="input-field"
                  [class.input-error]="form.get('planDate')?.invalid && form.get('planDate')?.touched"
                  required>
                <button type="button" class="datepicker-toggle" [matDatepickerToggleFor]="picker">
                  <mat-icon>calendar_today</mat-icon>
                </button>
                <mat-datepicker #picker></mat-datepicker>
              </div>
              @if (form.get('planDate')?.invalid && form.get('planDate')?.touched) {
                <p class="error-message">{{ getErrorMessage('planDate') }}</p>
              }
            </div>

            <!-- Duración en Días -->
            <div>
              <label class="input-label">
                <mat-icon class="label-icon">calendar_today</mat-icon>
                Duración (Días)
                <span class="text-red-500">*</span>
              </label>
              <div class="number-input-wrapper">
                <input
                  type="number"
                  formControlName="durationDays"
                  placeholder="0"
                  min="0"
                  class="input-field pr-24"
                  [class.input-error]="form.get('durationDays')?.invalid && form.get('durationDays')?.touched"
                  required>
                <div class="number-controls">
                  <button
                    type="button"
                    class="control-btn"
                    (click)="decrementDays()"
                    [disabled]="form.get('durationDays')?.value <= 0">
                    <mat-icon>remove</mat-icon>
                  </button>
                  <button
                    type="button"
                    class="control-btn"
                    (click)="incrementDays()">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </div>
              @if (form.get('durationDays')?.invalid && form.get('durationDays')?.touched) {
                <p class="error-message">{{ getErrorMessage('durationDays') }}</p>
              }
            </div>

            <!-- Duración en Horas -->
            <div>
              <label class="input-label">
                <mat-icon class="label-icon">schedule</mat-icon>
                Duración (Horas)
                <span class="text-red-500">*</span>
              </label>
              <div class="number-input-wrapper">
                <input
                  type="number"
                  formControlName="durationHours"
                  placeholder="0"
                  min="0"
                  max="23"
                  class="input-field pr-24"
                  [class.input-error]="form.get('durationHours')?.invalid && form.get('durationHours')?.touched"
                  required>
                <div class="number-controls">
                  <button
                    type="button"
                    class="control-btn"
                    (click)="decrementHours()"
                    [disabled]="form.get('durationHours')?.value <= 0">
                    <mat-icon>remove</mat-icon>
                  </button>
                  <button
                    type="button"
                    class="control-btn"
                    (click)="incrementHours()"
                    [disabled]="form.get('durationHours')?.value >= 23">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </div>
              @if (form.get('durationHours')?.invalid && form.get('durationHours')?.touched) {
                <p class="error-message">{{ getErrorMessage('durationHours') }}</p>
              }
              <p class="hint-text">Máximo 23 horas</p>
            </div>
          </div>
        </div>

        <!-- Asignaciones -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>assignment_ind</mat-icon>
            Asignaciones
            <span class="text-xs text-slate-500 font-normal ml-2">(Opcional: Asigne trabajador y/o propuesta)</span>
          </h3>

          <div class="form-grid">
            <!-- Trabajador -->
            <div class="col-span-2">
              <label class="input-label">
                <mat-icon class="label-icon">person</mat-icon>
                Trabajador
              </label>
              <div class="select-wrapper">
                <select formControlName="workerId" class="select-field">
                  <option value="">Sin asignar</option>
                  @for (worker of workers(); track worker.id) {
                    <option [value]="worker.id">
                      {{ worker.fullName }}
                      @if (worker.workerType === 'contractor' && worker.companyName) {
                        - {{ worker.companyName }}
                      }
                    </option>
                  }
                </select>
                <mat-icon class="select-icon">expand_more</mat-icon>
              </div>
              <p class="hint-text">Trabajador asignado al plan</p>
            </div>

            <!-- Propuesta/Estimado -->
            <div class="col-span-2">
              <label class="input-label">
                <mat-icon class="label-icon">description</mat-icon>
                Propuesta/Estimado
              </label>
              <div class="select-wrapper">
                <select formControlName="proposalId" class="select-field">
                  <option value="">Sin asignar</option>
                  @for (proposal of proposals(); track proposal.id) {
                    <option [value]="proposal.id">
                      {{ proposal.proposalNumber }} - {{ proposal.ownerName }} ({{ proposal.total | currency }})
                    </option>
                  }
                </select>
                <mat-icon class="select-icon">expand_more</mat-icon>
              </div>
              <p class="hint-text">Propuesta o estimado relacionado</p>
            </div>
          </div>

          @if (!hasAssignment() && form.touched) {
            <div class="warning-message">
              <mat-icon>info</mat-icon>
              <span>Tip: Puedes asignar un trabajador y/o una propuesta para mejor organización</span>
            </div>
          }
        </div>

        <!-- Detalles del Trabajo -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>info</mat-icon>
            Detalles del Trabajo
          </h3>

          <div class="form-grid">
            <!-- Descripción -->
            <div class="col-span-2">
              <label class="input-label">
                <mat-icon class="label-icon">subject</mat-icon>
                Descripción
                <span class="text-red-500">*</span>
              </label>
              <textarea
                formControlName="description"
                placeholder="Descripción del trabajo a realizar"
                rows="3"
                maxlength="500"
                class="textarea-field"
                [class.input-error]="form.get('description')?.invalid && form.get('description')?.touched"
                required></textarea>
              <div class="flex justify-between items-center">
                @if (form.get('description')?.invalid && form.get('description')?.touched) {
                  <p class="error-message mb-0">{{ getErrorMessage('description') }}</p>
                } @else {
                  <p class="hint-text mb-0">Describe brevemente el trabajo</p>
                }
                <span class="char-count">{{ form.get('description')?.value?.length || 0 }}/500</span>
              </div>
            </div>

            <!-- Ubicación -->
            <div class="col-span-2">
              <label class="input-label">
                <mat-icon class="label-icon">place</mat-icon>
                Ubicación
              </label>
              <input
                type="text"
                formControlName="location"
                placeholder="Dirección o ubicación del trabajo"
                maxlength="200"
                class="input-field">
              <p class="hint-text">Dirección donde se realizará el trabajo</p>
            </div>

            <!-- Notas -->
            <div class="col-span-2">
              <label class="input-label">
                <mat-icon class="label-icon">notes</mat-icon>
                Notas Adicionales
              </label>
              <textarea
                formControlName="notes"
                placeholder="Notas, comentarios o instrucciones especiales"
                rows="3"
                maxlength="1000"
                class="textarea-field"></textarea>
              <div class="flex justify-between items-center">
                <p class="hint-text mb-0">Información adicional sobre el plan</p>
                <span class="char-count">{{ form.get('notes')?.value?.length || 0 }}/1000</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Estado y Color -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>settings</mat-icon>
            Configuración
          </h3>

          <div class="form-grid">
            <!-- Estado -->
            <div>
              <label class="input-label">
                <mat-icon class="label-icon">flag</mat-icon>
                Estado
                <span class="text-red-500">*</span>
              </label>
              <div class="select-wrapper">
                <select formControlName="status" class="select-field" required>
                  @for (status of statuses; track status.value) {
                    <option [value]="status.value">{{ status.label }}</option>
                  }
                </select>
                <mat-icon class="select-icon">expand_more</mat-icon>
              </div>
              <p class="hint-text">Estado actual del plan</p>
            </div>

            <!-- Color -->
            <div>
              <label class="input-label">
                <mat-icon class="label-icon">palette</mat-icon>
                Color de Identificación
              </label>
              <div class="color-grid">
                @for (color of availableColors; track color.value) {
                  <button
                    type="button"
                    class="color-option"
                    [class.selected]="form.get('color')?.value === color.value"
                    [style.background-color]="color.value"
                    (click)="form.patchValue({ color: color.value })"
                    [title]="color.label">
                    @if (form.get('color')?.value === color.value) {
                      <mat-icon class="text-white">check</mat-icon>
                    }
                  </button>
                }
              </div>
              <p class="hint-text">Color para visualización en calendario</p>
            </div>
          </div>

          <!-- Preview de color -->
          <div class="color-preview-section">
            <p class="preview-label">Vista previa:</p>
            <div class="preview-card" [style.border-left-color]="form.get('color')?.value">
              <div class="preview-content">
                <mat-icon class="preview-icon">event_note</mat-icon>
                <div class="preview-text-container">
                  <p class="preview-title">{{ form.get('description')?.value || 'Plan de trabajo' }}</p>
                  <p class="preview-subtitle">
                    @if (form.get('durationDays')?.value || form.get('durationHours')?.value) {
                      {{ form.get('durationDays')?.value || 0 }}d {{ form.get('durationHours')?.value || 0 }}h
                    } @else {
                      Sin duración especificada
                    }
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="dialog-actions">
        <button
          type="button"
          class="btn-cancel"
          (click)="onCancel()"
          [disabled]="isSaving()">
          <mat-icon>close</mat-icon>
          <span>Cancelar</span>
        </button>

        <button
          type="submit"
          class="btn-save"
          [disabled]="form.invalid || isSaving()">
          @if (isSaving()) {
            <div class="spinner-small"></div>
            <span>Guardando...</span>
          } @else {
            <mat-icon>{{ data.mode === 'create' ? 'add' : 'save' }}</mat-icon>
            <span>{{ getSaveButtonText() }}</span>
          }
        </button>
      </div>
    </form>
  }
</div>
