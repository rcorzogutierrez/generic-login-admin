<!-- workers-list.component.html -->

<div class="min-h-screen bg-gradient-to-br from-slate-50 via-slate-100 to-slate-200">
  <div class="max-w-[1600px] mx-auto p-5">

    <!-- ========== HEADER ========== -->
    <header class="page-header">
      <div class="flex items-center justify-between gap-5 flex-wrap">

        <!-- Título e Icono -->
        <div class="flex items-center gap-4">
          <div class="header-icon-container" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <mat-icon>engineering</mat-icon>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-slate-800 mb-1">Gestión de Trabajadores</h1>
            <p class="text-sm text-slate-500">
              {{ workers().length }} trabajadores
              @if (getActiveWorkersCount() > 0) {
                <span class="text-green-600 font-semibold"> • {{ getActiveWorkersCount() }} activos</span>
              }
              <span class="text-blue-600 font-medium ml-2">{{ getInternalCount() }} propios</span>
              <span class="text-purple-600 font-medium ml-1">• {{ getContractorCount() }} subcontratados</span>
            </p>
          </div>
        </div>

        <!-- Acciones del Header -->
        <div class="flex items-center gap-3">
          <button
            mat-icon-button
            class="icon-btn"
            (click)="refreshData()"
            [disabled]="isLoading"
            matTooltip="Actualizar"
            aria-label="Actualizar lista de trabajadores">
            <mat-icon>refresh</mat-icon>
          </button>

          <button
            mat-stroked-button
            (click)="openCompaniesDialog()"
            [disabled]="isLoading"
            class="flex items-center gap-2 !border-purple-300 !text-purple-700 hover:!bg-purple-50">
            <mat-icon>business</mat-icon>
            Empresas
          </button>

          <button
            mat-raised-button
            color="primary"
            (click)="createWorker()"
            [disabled]="isLoading"
            class="flex items-center gap-2">
            <mat-icon>add</mat-icon>
            Nuevo Trabajador
          </button>
        </div>

      </div>
    </header>

    <!-- ========== FILTROS Y BÚSQUEDA ========== -->
    <div class="card-modern mb-6">
      <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
        <!-- Búsqueda -->
        <div class="flex items-center gap-4 flex-1 w-full md:w-auto">
          <mat-icon class="text-slate-400">search</mat-icon>
          <input
            type="text"
            placeholder="Buscar por nombre, teléfono, ID, empresa..."
            [ngModel]="searchTerm()"
            (ngModelChange)="onSearch($event)"
            class="flex-1 px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium
                   focus:border-amber-500 focus:ring-2 focus:ring-amber-100 outline-none transition-all
                   placeholder:text-slate-400">

          @if (searchTerm()) {
            <button
              mat-icon-button
              (click)="onSearch('')"
              matTooltip="Limpiar búsqueda"
              aria-label="Limpiar búsqueda">
              <mat-icon>close</mat-icon>
            </button>
          }
        </div>

        <!-- Filtro por tipo -->
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-sm text-slate-500 font-medium">Filtrar:</span>
          <button
            mat-stroked-button
            [class.!bg-slate-800]="filterType() === 'all'"
            [class.!text-white]="filterType() === 'all'"
            (click)="setFilterType('all')"
            class="!rounded-full !min-w-0 !px-4 text-sm">
            Todos
          </button>
          <button
            mat-stroked-button
            [class.!bg-blue-600]="filterType() === 'internal'"
            [class.!text-white]="filterType() === 'internal'"
            (click)="setFilterType('internal')"
            class="!rounded-full !min-w-0 !px-4 text-sm">
            <mat-icon class="!text-base mr-1">person</mat-icon>
            Propios
          </button>
          <button
            mat-stroked-button
            [class.!bg-purple-600]="filterType() === 'contractor'"
            [class.!text-white]="filterType() === 'contractor'"
            (click)="setFilterType('contractor')"
            class="!rounded-full !min-w-0 !px-4 text-sm">
            <mat-icon class="!text-base mr-1">groups</mat-icon>
            Subcontratados
          </button>
        </div>
      </div>
    </div>

    <!-- ========== BARRA DE ACCIONES MASIVAS ========== -->
    @if (selectedWorkers().length > 0) {
      <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 mb-6 flex items-center justify-between animate-fadeIn">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-amber-500 rounded-lg flex items-center justify-center">
            <mat-icon class="text-white !text-xl">check_circle</mat-icon>
          </div>
          <div>
            <p class="text-sm font-bold text-amber-900">
              {{ selectedWorkers().length }} trabajador(es) seleccionado(s)
            </p>
            <p class="text-xs text-amber-700">
              Puedes realizar acciones sobre los elementos seleccionados
            </p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button
            mat-button
            (click)="clearSelection()"
            class="text-amber-700 font-medium">
            <mat-icon>close</mat-icon>
            Cancelar selección
          </button>

          <button
            mat-raised-button
            (click)="deleteSelectedWorkers()"
            class="!bg-red-500 !text-white hover:!bg-red-600 font-semibold">
            <mat-icon>delete</mat-icon>
            Eliminar seleccionados
          </button>
        </div>
      </div>
    }

    <!-- ========== TABLA DE TRABAJADORES ========== -->
    <div class="card-modern">

      @if (isLoading) {
        <!-- Loading State -->
        <div class="flex flex-col items-center justify-center py-16">
          <div class="w-10 h-10 border-4 border-amber-600 border-t-transparent rounded-full animate-spin"></div>
          <p class="text-sm text-slate-500 mt-4">Cargando trabajadores...</p>
        </div>
      } @else if (paginatedWorkers().length === 0) {
        <!-- Empty State -->
        <div class="empty-state">
          <mat-icon>engineering</mat-icon>
          <h3>No hay trabajadores</h3>
          <p>{{ searchTerm() || filterType() !== 'all' ? 'No se encontraron trabajadores con esos criterios' : 'Comienza agregando tu primer trabajador' }}</p>
          @if (!searchTerm() && filterType() === 'all') {
            <button
              mat-raised-button
              color="primary"
              (click)="createWorker()"
              class="empty-state-button">
              <mat-icon>add</mat-icon>
              Crear Primer Trabajador
            </button>
          }
        </div>
      } @else {
        <!-- Tabla -->
        <div class="overflow-x-auto">
          <table class="w-full" role="table" aria-label="Tabla de trabajadores">
            <caption class="sr-only">Listado de trabajadores con su información, estado y acciones disponibles</caption>

            <!-- Header -->
            <thead class="bg-slate-50 border-b-2 border-slate-200">
              <tr>
                <!-- Checkbox -->
                <th class="px-4 py-3 text-left w-12">
                  <input
                    type="checkbox"
                    [checked]="isAllSelected()"
                    [indeterminate]="isIndeterminate()"
                    (change)="toggleSelectAll()"
                    class="w-4 h-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500">
                </th>

                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                  Nombre
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                  Tipo
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                  Empresa
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                  Teléfono
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">
                  ID/Licencia
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider w-32">
                  Estado
                </th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider w-24">
                  Acciones
                </th>
              </tr>
            </thead>

            <!-- Body -->
            <tbody class="divide-y divide-slate-200">
              @for (worker of paginatedWorkers(); track worker.id) {
                <tr
                  class="hover:bg-slate-50 transition-colors cursor-pointer"
                  [class.bg-amber-50]="isSelected(worker.id)"
                  (click)="viewWorker(worker)">

                  <!-- Checkbox -->
                  <td class="px-4 py-3" (click)="$event.stopPropagation()">
                    <input
                      type="checkbox"
                      [checked]="isSelected(worker.id)"
                      (change)="toggleSelection(worker.id)"
                      class="w-4 h-4 rounded border-slate-300 text-amber-600 focus:ring-amber-500">
                  </td>

                  <!-- Nombre -->
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-3">
                      <div class="w-9 h-9 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">{{ worker.fullName?.charAt(0)?.toUpperCase() || 'T' }}</span>
                      </div>
                      <span class="text-sm font-semibold text-slate-800">{{ worker.fullName }}</span>
                    </div>
                  </td>

                  <!-- Tipo -->
                  <td class="px-4 py-3">
                    <span
                      class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold"
                      [ngClass]="getWorkerTypeBadgeClass(worker.workerType)">
                      <mat-icon class="!text-sm">{{ worker.workerType === 'internal' ? 'person' : 'groups' }}</mat-icon>
                      {{ workerTypeLabels[worker.workerType] }}
                    </span>
                  </td>

                  <!-- Empresa -->
                  <td class="px-4 py-3 text-sm text-slate-700">
                    @if (worker.workerType === 'contractor' && worker.companyName) {
                      <span class="flex items-center gap-1">
                        <mat-icon class="!text-base text-purple-500">business</mat-icon>
                        {{ worker.companyName }}
                      </span>
                    } @else {
                      <span class="text-slate-400">-</span>
                    }
                  </td>

                  <!-- Teléfono -->
                  <td class="px-4 py-3 text-sm text-slate-700">
                    {{ worker.phone || '-' }}
                  </td>

                  <!-- ID/Licencia -->
                  <td class="px-4 py-3 text-sm text-slate-700 font-mono">
                    {{ worker.idOrLicense || '-' }}
                  </td>

                  <!-- Estado -->
                  <td class="px-4 py-3">
                    @if (worker.isActive) {
                      <span class="badge-status-active">
                        <mat-icon class="!text-xs">check_circle</mat-icon>
                        Activo
                      </span>
                    } @else {
                      <span class="badge-status-inactive">
                        <mat-icon class="!text-xs">cancel</mat-icon>
                        Inactivo
                      </span>
                    }
                  </td>

                  <!-- Acciones -->
                  <td class="px-4 py-3 text-right" (click)="$event.stopPropagation()">
                    <button
                      mat-icon-button
                      [matMenuTriggerFor]="menu"
                      (click)="$event.stopPropagation()"
                      aria-label="Abrir menú de opciones del trabajador">
                      <mat-icon>more_vert</mat-icon>
                    </button>

                    <mat-menu #menu="matMenu">
                      <button mat-menu-item (click)="editWorker(worker)">
                        <mat-icon>edit</mat-icon>
                        <span>Editar</span>
                      </button>
                      <button mat-menu-item (click)="toggleActive(worker)">
                        @if (worker.isActive) {
                          <mat-icon class="text-orange-600">visibility_off</mat-icon>
                        } @else {
                          <mat-icon class="text-green-600">visibility</mat-icon>
                        }
                        @if (worker.isActive) {
                          <span>Inactivar</span>
                        } @else {
                          <span>Activar</span>
                        }
                      </button>
                      <mat-divider></mat-divider>
                      <button mat-menu-item (click)="deleteWorker(worker)" class="text-red-600">
                        <mat-icon class="text-red-600">delete</mat-icon>
                        <span>Eliminar</span>
                      </button>
                    </mat-menu>
                  </td>

                </tr>
              }
            </tbody>

          </table>
        </div>

        <!-- ========== PAGINACIÓN ========== -->
        @if (totalPages() > 1) {
          <div class="flex items-center justify-between px-4 py-4 border-t border-slate-200">
            <div class="text-sm text-slate-600">
              Mostrando {{ (currentPage() * itemsPerPage()) + 1 }} a
              {{ Math.min((currentPage() + 1) * itemsPerPage(), filteredWorkers().length) }}
              de {{ filteredWorkers().length }} trabajadores
            </div>

            <div class="flex items-center gap-2">
              <button
                mat-icon-button
                (click)="goToPage(currentPage() - 1)"
                [disabled]="currentPage() === 0"
                aria-label="Página anterior">
                <mat-icon>chevron_left</mat-icon>
              </button>

              <span class="text-sm font-medium text-slate-700">
                Página {{ currentPage() + 1 }} de {{ totalPages() }}
              </span>

              <button
                mat-icon-button
                (click)="goToPage(currentPage() + 1)"
                [disabled]="currentPage() >= totalPages() - 1"
                aria-label="Página siguiente">
                <mat-icon>chevron_right</mat-icon>
              </button>
            </div>
          </div>
        }

      }

    </div>

  </div>
</div>
