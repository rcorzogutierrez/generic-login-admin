<!-- src/app/shared/components/data-table/data-table.component.html -->
<div class="table-container" [class]="getThemeClasses()">

  <!-- ============================================
       LOADING STATE
       ============================================ -->
  @if (loading()) {
    <div class="loading-state" role="status" aria-live="polite">
      <div class="animate-spin h-8 w-8 border-3 border-slate-300 border-t-purple-600 rounded-full"></div>
      <p class="text-sm text-slate-600 font-medium mt-3">
        {{ config().loadingMessage || 'Cargando datos...' }}
      </p>
    </div>
  }

  <!-- ============================================
       EMPTY STATE
       ============================================ -->
  @else if (data().length === 0) {
    <div class="empty-state" role="status">
      <div class="empty-icon-container">
        <mat-icon class="empty-icon">
          {{ config().emptyIcon || 'inbox' }}
        </mat-icon>
      </div>
      <p class="empty-message">
        {{ config().emptyMessage || 'No hay datos para mostrar' }}
      </p>
    </div>
  }

  <!-- ============================================
       TABLE WITH DATA
       ============================================ -->
  @else {
    <table
      class="data-table"
      [class]="getRowHeightClass()"
      [class.hover-effect]="config().hoverEffect !== false"
      [class.striped]="config().stripedRows"
      [class.bordered]="config().showRowBorders"
      role="table"
      [attr.aria-label]="'Tabla de datos con ' + data().length + ' filas'">

      <!-- TABLE HEADER -->
      <thead [class.sticky]="config().stickyHeader" role="rowgroup">
        <tr role="row">

          <!-- Checkbox Column (if selectable) -->
          @if (hasSelection()) {
            <th
              class="checkbox-cell"
              role="columnheader"
              [attr.aria-label]="'SelecciÃ³n'">
              @if (isMultipleSelection() && config().showSelectAll !== false) {
                <mat-checkbox
                  [checked]="allSelected()"
                  [indeterminate]="someSelected()"
                  [attr.aria-label]="allSelected() ? 'Deseleccionar todas las filas' : 'Seleccionar todas las filas'"
                  (change)="toggleSelectAll($event)">
                </mat-checkbox>
              }
            </th>
          }

          <!-- Data Columns -->
          @for (column of displayedColumns(); track column.id) {
            <th
              [class.sortable]="column.sortable && config().sortable"
              [class.sorted]="isColumnSorted(column)"
              [class.text-center]="column.headerAlign === 'center'"
              [class.text-right]="column.headerAlign === 'right'"
              [class.hidden-mobile]="column.hiddenOnMobile"
              [class.hidden-tablet]="column.hiddenOnTablet"
              [style.width]="column.width"
              [ngClass]="column.headerClass"
              [matTooltip]="column.tooltip || ''"
              [matTooltipDisabled]="!column.tooltip"
              role="columnheader"
              [attr.aria-sort]="isColumnSorted(column) ? (sortState()?.direction === 'asc' ? 'ascending' : 'descending') : 'none'"
              (click)="onHeaderClick(column)">

              <div class="th-content">
                <span>{{ column.label }}</span>
                @if (column.sortable && config().sortable) {
                  <mat-icon class="sort-icon" [class.active]="isColumnSorted(column)">
                    {{ getSortIcon(column) || 'unfold_more' }}
                  </mat-icon>
                }
              </div>
            </th>
          }

          <!-- Actions Column -->
          @if (config().showActionsColumn) {
            <th
              class="actions-cell text-center"
              [style.width]="config().actionsColumnWidth || '80px'"
              role="columnheader">
              {{ config().actionsColumnLabel || 'Acciones' }}
            </th>
          }
        </tr>
      </thead>

      <!-- TABLE BODY -->
      <tbody role="rowgroup">
        @for (row of data(); track getTrackByFn()($index, row)) {
          <tr
            [class.selected]="isRowSelected(row)"
            [class.clickable]="config().clickableRows"
            [attr.aria-selected]="isRowSelected(row)"
            role="row"
            (click)="onRowClick(row, $event)">

            <!-- Checkbox Cell -->
            @if (hasSelection()) {
              <td class="checkbox-cell" role="cell">
                <mat-checkbox
                  [checked]="isRowSelected(row)"
                  [attr.aria-label]="'Seleccionar fila'"
                  (change)="toggleSelection(row, $event)">
                </mat-checkbox>
              </td>
            }

            <!-- Data Cells -->
            @for (column of displayedColumns(); track column.id) {
              <td
                [class.text-center]="column.cellAlign === 'center'"
                [class.text-right]="column.cellAlign === 'right'"
                [class.hidden-mobile]="column.hiddenOnMobile"
                [class.hidden-tablet]="column.hiddenOnTablet"
                [ngClass]="getCellClasses(column, row)"
                role="cell">

                <!-- Custom Template (if provided) -->
                @if (column.cellTemplate) {
                  <ng-container *ngTemplateOutlet="column.cellTemplate; context: { $implicit: row, value: getCellValue(row, column) }">
                  </ng-container>
                }

                <!-- Default Cell Rendering -->
                @else {
                  {{ formatCellValue(getCellValue(row, column), column, row) }}
                }
              </td>
            }

            <!-- Actions Cell (content projection slot) -->
            @if (config().showActionsColumn) {
              <td class="actions-cell text-center" role="cell">
                <ng-content select="[actions]"></ng-content>
              </td>
            }
          </tr>
        }
      </tbody>
    </table>
  }
</div>
