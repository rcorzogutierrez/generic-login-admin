<!-- src/app/modules/clients/components/field-config-dialog/field-config-dialog.component.html -->
<div class="dialog-container field-config-dialog">

  <!-- HEADER -->
  <div class="dialog-header">
    <div class="flex items-center gap-3">
      <div class="header-icon">
        <mat-icon>{{ isEditMode ? 'edit' : 'add_circle' }}</mat-icon>
      </div>
      <div>
        <h2 class="dialog-title">
          {{ isEditMode ? 'Editar Campo' : 'Nuevo Campo Personalizado' }}
        </h2>
        <p class="dialog-subtitle">
          {{ isEditMode ? 'Modifica la configuración del campo' : 'Crea un campo personalizado para el módulo de clientes' }}
        </p>
      </div>
    </div>
    <button
      mat-icon-button
      (click)="onCancel()"
      [disabled]="isSaving"
      aria-label="Cerrar diálogo">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- CONTENT -->
  <form [formGroup]="fieldForm" (ngSubmit)="onSubmit()" class="dialog-content">

    <!-- INFORMACIÓN BÁSICA -->
    <section class="form-section">
      <div class="section-header">
        <mat-icon class="section-icon">info</mat-icon>
        <h3 class="section-title">Información Básica</h3>
      </div>

      <div class="form-grid">
        <!-- Label -->
        <div class="input-group flex flex-col gap-2 full-width">
          <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
            <mat-icon class="label-icon !text-lg text-purple-500">label</mat-icon>
            Etiqueta
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            class="input-field"
            formControlName="label"
            (blur)="generateNameFromLabel()"
            placeholder="Ej: Tipo de Cliente">
          @if (isFieldInvalid('label')) {
            <div class="input-error">
              {{ getErrorMessage('label') }}
            </div>
          }
        </div>

        <!-- Name (Internal) -->
        <div class="input-group flex flex-col gap-2 full-width">
          <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
            <mat-icon class="label-icon !text-lg text-purple-500">code</mat-icon>
            Nombre Interno
            <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            class="input-field"
            formControlName="name"
            placeholder="Ej: customer_type"
            [readonly]="isEditMode">
          <span class="text-xs text-slate-500 mt-1">Identificador único para el campo (no se puede cambiar después)</span>
          @if (isFieldInvalid('name')) {
            <div class="input-error">
              {{ getErrorMessage('name') }}
            </div>
          }
        </div>

        <!-- Type -->
        <div class="input-group flex flex-col gap-2">
          <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
            <mat-icon class="label-icon !text-lg text-purple-500">category</mat-icon>
            Tipo de Campo
          </label>
          <select class="input-field" formControlName="type">
            @for (type of fieldTypes; track type.value) {
              <option [value]="type.value">{{ type.label }}</option>
            }
          </select>
        </div>

        <!-- Form Width -->
        <div class="input-group flex flex-col gap-2">
          <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
            <mat-icon class="label-icon !text-lg text-purple-500">view_column</mat-icon>
            Ancho en Formulario
          </label>
          <select class="input-field" formControlName="formWidth">
            @for (width of formWidths; track width.value) {
              <option [value]="width.value">{{ width.label }}</option>
            }
          </select>
        </div>

        <!-- Placeholder -->
        <div class="input-group flex flex-col gap-2 full-width">
          <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
            <mat-icon class="label-icon !text-lg text-purple-500">text_snippet</mat-icon>
            Texto de Placeholder
          </label>
          <input
            type="text"
            class="input-field"
            formControlName="placeholder"
            placeholder="Ej: Ingresa el tipo de cliente">
        </div>

        <!-- Help Text -->
        <div class="input-group flex flex-col gap-2 full-width">
          <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
            <mat-icon class="label-icon !text-lg text-purple-500">help_outline</mat-icon>
            Texto de Ayuda
          </label>
          <textarea
            class="input-field !h-auto py-3"
            formControlName="helpText"
            rows="2"
            placeholder="Texto explicativo que aparece debajo del campo"></textarea>
        </div>
      </div>
    </section>

    <mat-divider></mat-divider>

    <!-- ICONO -->
    <section class="form-section">
      <div class="section-header">
        <mat-icon class="section-icon">palette</mat-icon>
        <div>
          <h3 class="section-title">Icono</h3>
          <p class="text-xs text-slate-500 mt-1">Selecciona o escribe el nombre de un icono de Material Icons</p>
        </div>
      </div>

      <div class="input-group flex flex-col gap-2 mb-3">
        <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
          <mat-icon class="label-icon !text-lg text-purple-500">{{ fieldForm.get('icon')?.value || 'help_outline' }}</mat-icon>
          Icono de Material Icons
        </label>
        <input
          type="text"
          class="input-field"
          formControlName="icon"
          placeholder="Ej: person, email, phone">
        <span class="text-xs text-slate-500 mt-1">Nombre del icono de Material Icons</span>
      </div>

      <!-- Iconos sugeridos -->
      <div class="suggested-icons">
        @for (icon of suggestedIcons; track icon) {
          <button
            type="button"
            mat-mini-fab
            color="primary"
            [class.selected]="fieldForm.get('icon')?.value === icon"
            (click)="selectIcon(icon)"
            [matTooltip]="icon">
            <mat-icon>{{ icon }}</mat-icon>
          </button>
        }
      </div>
    </section>

    <mat-divider></mat-divider>

    <!-- VALIDACIONES -->
    <section class="form-section">
      <div class="section-header">
        <mat-icon class="section-icon">verified</mat-icon>
        <h3 class="section-title">Validaciones</h3>
      </div>

      <!-- Required -->
      <div class="bg-purple-50 border border-purple-200 rounded-xl p-4 mb-4">
        <div class="flex items-start gap-3">
          <input
            type="checkbox"
            id="required-checkbox"
            class="w-5 h-5 mt-0.5 rounded border-2 border-purple-300 text-purple-600 focus:ring-2 focus:ring-purple-500"
            formControlName="required">
          <label for="required-checkbox" class="flex-1 cursor-pointer">
            <span class="text-sm font-semibold text-purple-800">Campo Requerido</span>
          </label>
        </div>
      </div>

      <!-- Length validations (for text fields) -->
      @if (supportsLength()) {
        <div class="form-grid">
          <div class="input-group flex flex-col gap-2">
            <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
              <mat-icon class="label-icon !text-lg text-purple-500">format_size</mat-icon>
              Longitud Mínima
            </label>
            <input
              type="number"
              class="input-field"
              formControlName="minLength"
              min="0"
              placeholder="0">
          </div>

          <div class="input-group flex flex-col gap-2">
            <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
              <mat-icon class="label-icon !text-lg text-purple-500">format_size</mat-icon>
              Longitud Máxima
            </label>
            <input
              type="number"
              class="input-field"
              formControlName="maxLength"
              min="0"
              placeholder="Sin límite">
          </div>
        </div>
      }

      <!-- Min/Max validations (for number/date fields) -->
      @if (supportsMinMax()) {
        <div class="form-grid">
          <div class="input-group flex flex-col gap-2">
            <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
              <mat-icon class="label-icon !text-lg text-purple-500">remove</mat-icon>
              Valor Mínimo
            </label>
            <input
              type="number"
              class="input-field"
              formControlName="min"
              placeholder="Sin mínimo">
          </div>

          <div class="input-group flex flex-col gap-2">
            <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
              <mat-icon class="label-icon !text-lg text-purple-500">add</mat-icon>
              Valor Máximo
            </label>
            <input
              type="number"
              class="input-field"
              formControlName="max"
              placeholder="Sin máximo">
          </div>
        </div>
      }

      <!-- Pattern validation -->
      @if (supportsPattern()) {
        <div class="input-group flex flex-col gap-2 full-width">
          <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
            <mat-icon class="label-icon !text-lg text-purple-500">pattern</mat-icon>
            Patrón de Validación (RegEx)
          </label>
          <input
            type="text"
            class="input-field"
            formControlName="pattern"
            placeholder="Ej: ^[A-Z]{2,5}$">
          <span class="text-xs text-slate-500 mt-1">Expresión regular para validar el formato</span>
        </div>
      }

      <!-- Default Value -->
      <div class="input-group flex flex-col gap-2 full-width">
        <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
          <mat-icon class="label-icon !text-lg text-purple-500">radio_button_checked</mat-icon>
          Valor por Defecto
        </label>
        <input
          type="text"
          class="input-field"
          formControlName="defaultValue"
          placeholder="Valor inicial del campo">
      </div>
    </section>

    <mat-divider></mat-divider>

    <!-- OPCIONES (para SELECT, MULTISELECT, DICTIONARY) -->
    @if (requiresOptions()) {
      <section class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">list</mat-icon>
          <div>
            <h3 class="section-title">Opciones del Campo</h3>
            <p class="text-xs text-slate-500 mt-1">Define las opciones disponibles para este campo</p>
          </div>
        </div>

        <!-- Ayuda contextual para DICTIONARY -->
        @if (fieldForm.get('type')?.value === 'dictionary') {
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
            <div class="flex items-start gap-2">
              <mat-icon class="!text-blue-600 !text-lg mt-0.5">info</mat-icon>
              <div class="text-xs text-blue-800">
                <p class="font-semibold mb-1">¿Cómo funcionan las claves del diccionario?</p>
                <p class="mb-2"><strong>Valor (ID interno):</strong> Identificador único que se guardará en la base de datos (ej: "customer_name", "age")</p>
                <p><strong>Etiqueta (Texto visible):</strong> Texto descriptivo que verá el usuario en el formulario (ej: "Nombre del Cliente", "Edad")</p>
              </div>
            </div>
          </div>
        }

        <div formArrayName="options" class="space-y-3">
          @for (option of options.controls; track $index) {
            <div [formGroupName]="$index" class="bg-purple-50 border border-purple-200 rounded-xl p-4">
              <div class="flex items-start gap-3">
                <div class="flex-1 grid grid-cols-2 gap-3">
                  <!-- Valor (value) -->
                  <div class="input-group flex flex-col gap-2">
                    <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                      <mat-icon class="label-icon !text-base text-purple-500">vpn_key</mat-icon>
                      @if (fieldForm.get('type')?.value === 'dictionary') {
                        Valor (ID interno)
                      } @else {
                        Valor (clave)
                      }
                      <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      class="input-field text-sm"
                      formControlName="value"
                      [placeholder]="fieldForm.get('type')?.value === 'dictionary' ? 'Ej: customer_name' : 'Ej: active'">
                    @if (fieldForm.get('type')?.value === 'dictionary') {
                      <span class="text-xs text-slate-500">ID que se guarda en la BD</span>
                    }
                  </div>

                  <!-- Etiqueta (label) -->
                  <div class="input-group flex flex-col gap-2">
                    <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                      <mat-icon class="label-icon !text-base text-purple-500">label</mat-icon>
                      @if (fieldForm.get('type')?.value === 'dictionary') {
                        Etiqueta (Texto visible)
                      } @else {
                        Etiqueta
                      }
                      <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      class="input-field text-sm"
                      formControlName="label"
                      [placeholder]="fieldForm.get('type')?.value === 'dictionary' ? 'Ej: Nombre del Cliente' : 'Ej: Activo'">
                    @if (fieldForm.get('type')?.value === 'dictionary') {
                      <span class="text-xs text-slate-500">Texto que verá el usuario</span>
                    }
                  </div>

                  <!-- Color (opcional) -->
                  <div class="input-group flex flex-col gap-2 col-span-2">
                    <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                      <mat-icon class="label-icon !text-base text-purple-500">palette</mat-icon>
                      Color (opcional)
                    </label>
                    <input
                      type="text"
                      class="input-field text-sm"
                      formControlName="color"
                      placeholder="Ej: #3b82f6, blue">
                    <span class="text-xs text-slate-500">Color hexadecimal o nombre de color CSS</span>
                  </div>
                </div>

                <!-- Botón eliminar -->
                <button
                  type="button"
                  mat-icon-button
                  color="warn"
                  (click)="removeOption($index)"
                  matTooltip="Eliminar opción"
                  aria-label="Eliminar opción"
                  class="mt-6">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          }

          <!-- Botón para agregar opción -->
          <button
            type="button"
            mat-raised-button
            color="accent"
            (click)="addOption()"
            class="!w-full !flex !items-center !justify-center !gap-2 !py-3">
            <mat-icon>add</mat-icon>
            Agregar Opción
          </button>

          @if (options.length === 0) {
            <div class="bg-amber-50 border border-amber-300 rounded-xl p-4 text-center">
              <mat-icon class="text-amber-600 !text-3xl mb-2">warning</mat-icon>
              <p class="text-sm text-amber-800 font-medium">
                Este tipo de campo requiere al menos una opción
              </p>
            </div>
          }
        </div>
      </section>

      <mat-divider></mat-divider>
    }

    <!-- CONFIGURACIÓN DE TABLA/GRID -->
    <section class="form-section">
      <div class="section-header">
        <mat-icon class="section-icon">table_chart</mat-icon>
        <h3 class="section-title">Configuración de Tabla</h3>
      </div>

      <div class="space-y-3">
        <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <input
              type="checkbox"
              id="showInGrid-checkbox"
              class="w-5 h-5 mt-0.5 rounded border-2 border-purple-300 text-purple-600 focus:ring-2 focus:ring-purple-500"
              formControlName="showInGrid">
            <label for="showInGrid-checkbox" class="flex-1 cursor-pointer">
              <span class="text-sm font-semibold text-purple-800">Mostrar como columna en la tabla</span>
            </label>
          </div>
        </div>

        @if (fieldForm.get('showInGrid')?.value) {
          <div class="form-grid">
            <div class="input-group flex flex-col gap-2">
              <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                <mat-icon class="label-icon !text-lg text-purple-500">width_wide</mat-icon>
                Ancho de Columna
              </label>
              <input
                type="text"
                class="input-field"
                formControlName="gridWidth"
                placeholder="Ej: 150px, 20%">
              <span class="text-xs text-slate-500 mt-1">Opcional - Ej: 150px, 20%, auto</span>
            </div>

            <div class="flex flex-col gap-3">
              <div class="bg-purple-50 border border-purple-200 rounded-xl p-3">
                <div class="flex items-start gap-3">
                  <input
                    type="checkbox"
                    id="sortable-checkbox"
                    class="w-4 h-4 mt-0.5 rounded border-2 border-purple-300 text-purple-600 focus:ring-2 focus:ring-purple-500"
                    formControlName="sortable">
                  <label for="sortable-checkbox" class="flex-1 cursor-pointer">
                    <span class="text-sm font-medium text-purple-800">Ordenable</span>
                  </label>
                </div>
              </div>
              <div class="bg-purple-50 border border-purple-200 rounded-xl p-3">
                <div class="flex items-start gap-3">
                  <input
                    type="checkbox"
                    id="filterable-checkbox"
                    class="w-4 h-4 mt-0.5 rounded border-2 border-purple-300 text-purple-600 focus:ring-2 focus:ring-purple-500"
                    formControlName="filterable">
                  <label for="filterable-checkbox" class="flex-1 cursor-pointer">
                    <span class="text-sm font-medium text-purple-800">Filtrable</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    </section>

    <mat-divider></mat-divider>

    <!-- ESTADO -->
    <section class="form-section">
      <div class="section-header">
        <mat-icon class="section-icon">toggle_on</mat-icon>
        <h3 class="section-title">Estado</h3>
      </div>

      <div class="bg-purple-50 border border-purple-200 rounded-xl p-4">
        <div class="flex items-start gap-3">
          <input
            type="checkbox"
            id="isActive-checkbox"
            class="w-5 h-5 mt-0.5 rounded border-2 border-purple-300 text-purple-600 focus:ring-2 focus:ring-purple-500"
            formControlName="isActive">
          <label for="isActive-checkbox" class="flex-1 cursor-pointer">
            <div class="flex items-center gap-2 mb-1">
              <span class="text-sm font-semibold text-purple-800">Campo Activo</span>
            </div>
            <p class="text-xs text-purple-600 m-0">Los campos inactivos no se mostrarán en los formularios</p>
          </label>
        </div>
      </div>
    </section>

  </form>

  <!-- FOOTER -->
  <div class="dialog-footer">
    <button
      mat-button
      type="button"
      (click)="onCancel()"
      [disabled]="isSaving"
      class="text-slate-600 font-medium px-5 py-2 rounded-lg hover:bg-slate-200 transition-all">
      Cancelar
    </button>
    <button
      mat-raised-button
      color="primary"
      type="submit"
      (click)="onSubmit()"
      [disabled]="fieldForm.invalid || isSaving"
      class="flex items-center gap-2 font-semibold px-7 py-3 rounded-lg !bg-gradient-to-br !from-purple-500 !to-purple-600 !text-white !shadow-[0_4px_12px_rgba(139,92,246,0.3)] hover:!shadow-[0_8px_20px_rgba(139,92,246,0.4)] hover:!-translate-y-0.5 transition-all disabled:opacity-60 disabled:cursor-not-allowed">
      @if (isSaving) {
        <mat-spinner diameter="20" class="inline-block"></mat-spinner>
      } @else {
        <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
      }
      {{ isSaving ? 'Guardando...' : (isEditMode ? 'Guardar Cambios' : 'Crear Campo') }}
    </button>
  </div>

</div>
